<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì‹œê³µì  ìë™ ë°°ì • ì§€ë„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Supabase ì´ˆê¸°í™” -->
  <script src="/js/supabaseclient.js"></script>

  <!-- XLSX for Excel parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Kakao Map SDK -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=ebeba9e3c5cb4bd9cecfcc0958ac20d4&libraries=services&autoload=false"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      display: flex;
      height: 100vh;
      overflow: hidden;
      background: #f3f4f6;
      color: #111827;
    }

    .layout {
      display: flex;
      width: 100%;
      height: 100%;
    }

    .sidebar {
      width: 380px;
      max-width: 100%;
      background: #ffffff;
      border-right: 1px solid #e5e7eb;
      padding: 20px 18px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow-y: auto;
    }

    .sidebar-header {
      margin-bottom: 4px;
    }

    .sidebar-title {
      font-size: 18px;
      font-weight: 700;
      color: #111827;
    }

    .sidebar-subtitle {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }

    .card {
      background: #f9fafb;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      padding: 14px 14px 12px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #111827;
    }

    .field-label {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .input-box {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      margin-bottom: 8px;
      outline: none;
    }

    .input-box:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px rgba(59,130,246,0.2);
    }

    .btn {
      width: 100%;
      padding: 9px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      margin-top: 6px;
    }

    .btn-primary {
      background: #2563eb;
      color: #ffffff;
    }

    .btn-primary:hover {
      background: #1d4ed8;
    }

    .btn-danger {
      background: #ef4444;
      color: #ffffff;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn-secondary {
      background: #06b6d4;
      color: #ffffff;
    }

    .btn-secondary:hover {
      background: #0891b2;
    }

    .meta-text {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }

    .meta-text strong {
      color: #111827;
    }

    .result-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 6px;
    }

    .result-item {
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      padding: 8px 9px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s, transform 0.05s;
    }

    .result-item:hover {
      background: #eff6ff;
      border-color: #3b82f6;
      transform: translateY(-1px);
    }

    .result-item.active {
      background: #dbeafe;
      border-color: #2563eb;
    }

    .result-title-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2px;
    }

    .badge-rank {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: #3b82f6;
      color: #ffffff;
      font-size: 11px;
      font-weight: 700;
      margin-right: 6px;
    }

    .result-name {
      font-weight: 600;
      color: #111827;
      font-size: 12px;
      flex: 1;
      min-width: 0;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    .result-distance {
      font-size: 11px;
      color: #4b5563;
      margin-left: 6px;
      white-space: nowrap;
    }

    .result-address {
      font-size: 11px;
      color: #6b7280;
      margin-top: 1px;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    .result-phone {
      font-size: 11px;
      color: #2563eb;
      margin-top: 1px;
    }
    
    .btn-select-workshop {
      margin-top: 8px;
      width: 100%;
      padding: 6px 12px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .btn-select-workshop:hover {
      background: #1d4ed8;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .detail-box {
      font-size: 12px;
      line-height: 1.5;
    }

    .detail-row {
      margin-top: 3px;
    }

    .detail-label {
      display: inline-block;
      min-width: 52px;
      color: #6b7280;
    }

    .detail-value {
      color: #111827;
    }

    .detail-empty {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }

    #map {
      flex: 1;
      height: 100vh;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .layout {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        height: auto;
        max-height: 55%;
        border-right: none;
        border-bottom: 1px solid #e5e7eb;
      }
      #map {
        height: 45%;
      }
    }
  </style>
</head>
<body>
<div class="layout">
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">ì‹œê³µì  ìë™ ë°°ì • ì§€ë„</div>
      <div class="sidebar-subtitle">
        ê³ ê° ì£¼ì†Œ ê¸°ì¤€ìœ¼ë¡œ ê°€ì¥ ê°€ê¹Œìš´ ì‹œê³µì  5ê³³ì„ ìë™ ì¶”ì²œí•©ë‹ˆë‹¤.
      </div>
    </div>

    <!-- Excel ì—…ë¡œë“œ ì¹´ë“œ -->
    <div class="card">
      <div class="card-title">1. ì‹œê³µì  ì—‘ì…€ ì—…ë¡œë“œ</div>
      <div class="field-label">ì—‘ì…€ íŒŒì¼ ì„ íƒ (ì»¬ëŸ¼: ìˆœë²ˆ, ìƒí˜¸, ì£¼ì†Œ, ì „í™”ë²ˆí˜¸)</div>
      <input type="file" id="excelFile" class="input-box" accept=".xlsx,.xls" />
      <button class="btn btn-primary" onclick="uploadExcel()">ì—‘ì…€ ì—…ë¡œë“œ / ì—…ë°ì´íŠ¸</button>
      <button class="btn btn-danger" onclick="clearStorage()">ì €ì¥ëœ ì‹œê³µì  ì‚­ì œ</button>
      <div class="meta-text">
        ì €ì¥ëœ ì‹œê³µì : <strong id="storeCount">0</strong> ê°œ
        <div id="uploadStatus"></div>
      </div>
    </div>

    <!-- ì£¼ì†Œ ê²€ìƒ‰ ì¹´ë“œ -->
    <div class="card">
      <div class="card-title">2. ê³ ê° ì£¼ì†Œ ê²€ìƒ‰</div>
      <div class="field-label">ê³ ê° ì£¼ì†Œ</div>
      <input id="addressInput" class="input-box" placeholder="ì˜ˆ: ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123" />
      <button class="btn btn-secondary" onclick="findNearest()">ê°€ì¥ ê°€ê¹Œìš´ 5ê³³ ì°¾ê¸°</button>
      <div class="meta-text" id="searchStatus"></div>
    </div>

    <!-- ì¶”ì²œ ì‹œê³µì  ë¦¬ìŠ¤íŠ¸ -->
    <div class="card">
      <div class="card-title">3. ì¶”ì²œ ì‹œê³µì  5ê³³</div>
      <div class="meta-text">ìˆœë²ˆ / ìƒí˜¸ / ê±°ë¦¬ / ì£¼ì†Œ / ì „í™”ë²ˆí˜¸</div>
      <div id="resultList" class="result-list"></div>
    </div>

    <!-- ì„ íƒëœ ì‹œê³µì  ìƒì„¸ -->
    <div class="card">
      <div class="card-title">4. ì„ íƒëœ ì‹œê³µì  ìƒì„¸</div>
      <div id="selectedDetail" class="detail-box">
        <div class="detail-empty">ë§ˆì»¤ ë˜ëŠ” ëª©ë¡ì„ í´ë¦­í•˜ë©´ ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
      </div>
    </div>
  </div>

  <div id="map"></div>
</div>

<script>
  // Kakao map globals
  let map;
  let geocoder;
  let stores = [];          // { seq, name, address, phone, lat, lng }
  let markers = [];         // ì¶”ì²œ ì‹œê³µì  ë§ˆì»¤
  let infoWindows = [];     // ì¶”ì²œ ì‹œê³µì  ì¸í¬ìœˆë„ìš°
  let userMarker = null;    // ê³ ê° ìœ„ì¹˜ ë§ˆì»¤
  let selectedIndex = null; // 0~4
  let nearest = [];         // ì¶”ì²œëœ ì‹œê³µì  5ê³³

  // Wait for Supabase to be ready
  function waitForSupabase() {
    return new Promise((resolve) => {
      if (window.supabaseClient && window.supabaseReady) {
        resolve();
        return;
      }
      
      window.addEventListener('supabaseReady', () => {
        resolve();
      }, { once: true });
      
      setTimeout(() => {
        if (window.supabaseClient) {
          resolve();
        } else {
          console.warn('Supabase client not ready after timeout');
          resolve();
        }
      }, 2000);
    });
  }

  // Error handling helper
  function checkError(error) {
    if (error) {
      console.error("Supabase error:", error);
      console.error("Error details:", JSON.stringify(error, null, 2));
      alert("ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + (error.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
      throw error;
    }
  }

  // Util: HTML ì´ìŠ¤ì¼€ì´í”„
  function escapeHtml(str) {
    if (!str) return "";
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  // Util: ê±°ë¦¬(km)
  function getDistanceKm(lat1, lon1, lat2, lon2) {
    function toRad(v) { return v * Math.PI / 180; }
    const R = 6371;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
      Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  // Util: ì˜ˆìƒ ì´ë™ ì‹œê°„(ë¶„) â€“ í‰ê·  40km/h ê°€ì •
  function estimateMinutes(distanceKm) {
    if (!distanceKm || distanceKm <= 0) return null;
    const minutes = distanceKm / 40 * 60;
    return Math.max(1, Math.round(minutes));
  }

  // Supabaseì—ì„œ ì‹œê³µì  ë°ì´í„° ë¡œë“œ
  async function loadStoresFromStorage() {
    await waitForSupabase();
    
    if (!window.supabaseClient) {
      console.error("Supabase client not available");
      stores = [];
      document.getElementById("storeCount").innerText = "0";
      return;
    }

    try {
      const { data, error } = await window.supabaseClient
        .from("installer_locations")
        .select("*")
        .eq("is_active", true)
        .order("priority", { ascending: true })
        .order("seq", { ascending: true });

      checkError(error);

      stores = (data || []).map(s => ({
        seq: s.seq || "",
        name: s.name || "",
        address: s.address || "",
        phone: s.phone || "",
        lat: s.lat != null ? parseFloat(s.lat) : null,
        lng: s.lng != null ? parseFloat(s.lng) : null,
      }));
      document.getElementById("storeCount").innerText = String(stores.length);
    } catch (e) {
      console.error("Failed to load stores:", e);
      stores = [];
      document.getElementById("storeCount").innerText = "0";
    }
  }

  // Supabaseì— ì‹œê³µì  ë°ì´í„° ì €ì¥
  async function saveStoresToStorage() {
    await waitForSupabase();
    
    if (!window.supabaseClient) {
      console.error("Supabase client not available");
      alert("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
      return;
    }

    try {
      // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ í›„ ìƒˆë¡œ ì‚½ì…
      const { error: deleteError } = await window.supabaseClient
        .from("installer_locations")
        .delete()
        .neq("id", "00000000-0000-0000-0000-000000000000");

      if (deleteError) {
        console.warn("Delete error (may be empty table):", deleteError);
      }

      if (stores.length > 0) {
        const records = stores.map(s => ({
          seq: s.seq,
          name: s.name,
          address: s.address,
          phone: s.phone,
          lat: s.lat,
          lng: s.lng
        }));

        const { error } = await window.supabaseClient
          .from("installer_locations")
          .insert(records);

        checkError(error);
      }

      document.getElementById("storeCount").innerText = String(stores.length);
    } catch (e) {
      console.error("Failed to save stores:", e);
      console.error("Error details:", JSON.stringify(e, null, 2));
      alert("ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + (e.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
    }
  }

  // í´ë¦­ ë§ˆì»¤/ì¸í¬ìœˆë„ìš° ì´ˆê¸°í™”
  function clearMarkers() {
    markers.forEach(m => m.setMap(null));
    markers = [];
    infoWindows.forEach(iw => iw.close());
    infoWindows = [];
  }

  function clearUserMarker() {
    if (userMarker) {
      userMarker.setMap(null);
      userMarker = null;
    }
  }

  // Excel ì—…ë¡œë“œ
  function uploadExcel() {
    const fileInput = document.getElementById("excelFile");
    const statusEl = document.getElementById("uploadStatus");
    if (!fileInput.files[0]) {
      alert("ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }

    statusEl.textContent = "ì—‘ì…€ ì²˜ë¦¬ ì¤‘â€¦ (ì£¼ì†Œ â†’ ì¢Œí‘œ ë³€í™˜)";
    statusEl.style.color = "#4b5563";

    const reader = new FileReader();
    reader.onload = function(e) {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: "array" });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet);

      // ê¸°ëŒ€ ì»¬ëŸ¼: ìˆœë²ˆ, ìƒí˜¸, ì£¼ì†Œ, ì „í™”ë²ˆí˜¸
      const rows = json.filter(r => r.ì£¼ì†Œ || r["ì£¼ì†Œ"]);
      if (!rows.length) {
        statusEl.textContent = "âŒ 'ì£¼ì†Œ' ì»¬ëŸ¼ì´ í¬í•¨ëœ í–‰ì´ ì—†ìŠµë‹ˆë‹¤.";
        statusEl.style.color = "#dc2626";
        return;
      }

      // ìˆœì°¨ ì§€ì˜¤ì½”ë”©
      const resultStores = [];
      let idx = 0;
      let successCount = 0;
      let failCount = 0;

      function processNext() {
        if (idx >= rows.length) {
          // ì™„ë£Œ
          stores = resultStores;
          saveStoresToStorage();
          statusEl.textContent = `âœ… ì—…ë¡œë“œ ì™„ë£Œ: ${successCount}ê°œ ì¢Œí‘œ ë³€í™˜ ì„±ê³µ, ${failCount}ê°œ ì‹¤íŒ¨`;
          statusEl.style.color = "#16a34a";
          return;
        }

        const r = rows[idx++];
        const seq = r.ìˆœë²ˆ || r["ìˆœë²ˆ"] || "";
        const name = r.ìƒí˜¸ || r["ìƒí˜¸"] || "";
        const address = r.ì£¼ì†Œ || r["ì£¼ì†Œ"] || "";
        const phone = r.ì „í™”ë²ˆí˜¸ || r["ì „í™”ë²ˆí˜¸"] || "";

        if (!address) {
          // ì£¼ì†Œ ì—†ìœ¼ë©´ ì¢Œí‘œ ì—†ì´ ì €ì¥
          resultStores.push({ seq, name, address, phone, lat: null, lng: null });
          failCount++;
          processNext();
          return;
        }

        geocoder.addressSearch(address, function(res, status) {
          if (status === kakao.maps.services.Status.OK && res && res[0]) {
            const lat = parseFloat(res[0].y);
            const lng = parseFloat(res[0].x);
            resultStores.push({ seq, name, address, phone, lat, lng });
            successCount++;
          } else {
            console.warn("ì§€ì˜¤ì½”ë”© ì‹¤íŒ¨:", address);
            resultStores.push({ seq, name, address, phone, lat: null, lng: null });
            failCount++;
          }
          // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ë©´ ëŒ€ëŸ‰ ì²˜ë¦¬ ì‹œ API ë¶€ë‹´ ê°ì†Œ
          setTimeout(processNext, 80);
        });
      }

      processNext();
    };

    reader.readAsArrayBuffer(fileInput.files[0]);
  }

  // ì €ì¥ëœ ì‹œê³µì  ì‚­ì œ
  async function clearStorage() {
    if (!confirm("ì €ì¥ëœ ëª¨ë“  ì‹œê³µì  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    await waitForSupabase();
    
    if (!window.supabaseClient) {
      console.error("Supabase client not available");
      alert("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
      return;
    }

    try {
      const { error } = await window.supabaseClient
        .from("installer_locations")
        .delete()
        .neq("id", "00000000-0000-0000-0000-000000000000");

      if (error) {
        console.warn("Delete error (may be empty table):", error);
      }
    } catch (e) {
      console.error("Failed to delete stores:", e);
      console.error("Error details:", JSON.stringify(e, null, 2));
      alert("ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + (e.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
    }

    stores = [];
    document.getElementById("storeCount").innerText = "0";
    document.getElementById("uploadStatus").textContent = "ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.";
    document.getElementById("uploadStatus").style.color = "#6b7280";
    clearMarkers();
    clearUserMarker();
    document.getElementById("resultList").innerHTML = "";
    document.getElementById("selectedDetail").innerHTML =
      '<div class="detail-empty">ë§ˆì»¤ ë˜ëŠ” ëª©ë¡ì„ í´ë¦­í•˜ë©´ ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>';
  }

  // ì¶”ì²œ ì‹œê³µì  ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ê¸°
  function renderResultList(nearest) {
    const listEl = document.getElementById("resultList");
    listEl.innerHTML = "";

    if (!nearest.length) {
      listEl.innerHTML = '<div class="detail-empty">ì¶”ì²œ ì‹œê³µì ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }

    nearest.forEach((s, index) => {
      const div = document.createElement("div");
      div.className = "result-item";
      div.dataset.index = String(index);

      const distanceStr = s.distanceKm != null ? s.distanceKm.toFixed(1) + "km" : "-";
      const etaStr = s.etaMin != null ? s.etaMin + "ë¶„" : "-";

      div.innerHTML = `
        <div class="result-title-line">
          <div style="display:flex;align-items:center;min-width:0;">
            <span class="badge-rank">${index + 1}</span>
            <span class="result-name">${escapeHtml(s.name || "")}</span>
          </div>
          <span class="result-distance">${distanceStr} Â· ${etaStr}</span>
        </div>
        <div class="result-address">${escapeHtml(s.address || "")}</div>
        <div class="result-phone">${s.phone ? "ğŸ“ " + escapeHtml(s.phone) : ""}</div>
        <button class="btn-select-workshop" onclick="selectWorkshop(${index}, event)">ì´ ì‹œê³µì  ì„ íƒí•˜ê¸°</button>
      `;

      div.addEventListener("click", function(e) {
        // ë²„íŠ¼ í´ë¦­ì´ ì•„ë‹ ë•Œë§Œ ë§ˆì»¤ í¬ì»¤ìŠ¤
        if (!e.target.classList.contains('btn-select-workshop')) {
          focusShopMarker(index);
        }
      });

      listEl.appendChild(div);
    });
  }

  // ìƒì„¸ íŒ¨ë„ í‘œì‹œ
  function renderSelectedDetail(shop, rank) {
    const detailEl = document.getElementById("selectedDetail");
    if (!shop) {
      detailEl.innerHTML =
        '<div class="detail-empty">ë§ˆì»¤ ë˜ëŠ” ëª©ë¡ì„ í´ë¦­í•˜ë©´ ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>';
      return;
    }

    const distanceStr = shop.distanceKm != null ? shop.distanceKm.toFixed(1) + "km" : "-";
    const etaStr = shop.etaMin != null ? shop.etaMin + "ë¶„" : "-";

    detailEl.innerHTML = `
      <div class="detail-row"><span class="detail-label">ìˆœë²ˆ</span>
        <span class="detail-value">${rank != null ? rank + "ë²ˆ" : (shop.seq || "-")}</span></div>
      <div class="detail-row"><span class="detail-label">ìƒí˜¸</span>
        <span class="detail-value">${escapeHtml(shop.name || "")}</span></div>
      <div class="detail-row"><span class="detail-label">ì£¼ì†Œ</span>
        <span class="detail-value">${escapeHtml(shop.address || "")}</span></div>
      <div class="detail-row"><span class="detail-label">ì „í™”</span>
        <span class="detail-value">${escapeHtml(shop.phone || "-")}</span></div>
      <div class="detail-row"><span class="detail-label">ê±°ë¦¬</span>
        <span class="detail-value">${distanceStr}</span></div>
      <div class="detail-row"><span class="detail-label">ì˜ˆìƒ</span>
        <span class="detail-value">${etaStr}</span></div>
      <button class="btn-select-workshop" onclick="selectWorkshopFromDetail(${rank - 1}, event)" style="margin-top: 12px; padding: 8px 16px; font-size: 13px;">ì´ ì‹œê³µì  ì„ íƒí•˜ê¸°</button>
    `;
  }
  
  // ì‹œê³µì  ì„ íƒ í•¨ìˆ˜ (ë¦¬ìŠ¤íŠ¸ì—ì„œ)
  function selectWorkshop(index, event) {
    if (event) {
      event.stopPropagation();
    }
    
    if (!nearest || !nearest[index]) {
      alert("ì‹œê³µì  ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    
    const shop = nearest[index];
    if (!shop) {
      alert("ì‹œê³µì  ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    
    // name, address, phoneë§Œ ì €ì¥
    const workshopData = {
      name: shop.name || '',
      address: shop.address || '',
      phone: shop.phone || ''
    };
    
    // localStorageì— ì €ì¥
    localStorage.setItem('selectedWorkshop', JSON.stringify(workshopData));
    
    // /accident-formë¡œ ì´ë™
    if (window.parent && window.parent !== window) {
      window.parent.postMessage({ type: 'openAccidentPage' }, '*');
    } else {
      window.location.href = '/accident-form';
    }
  }
  
  // ì‹œê³µì  ì„ íƒ í•¨ìˆ˜ (ìƒì„¸ íŒ¨ë„ì—ì„œ)
  function selectWorkshopFromDetail(index, event) {
    if (event) {
      event.stopPropagation();
    }
    selectWorkshop(index, event);
  }

  // íŠ¹ì • ìˆœìœ„(0~4) ì‹œê³µì  ë§ˆì»¤ & ë¦¬ìŠ¤íŠ¸ í¬ì»¤ìŠ¤
  function focusShopMarker(index) {
    selectedIndex = index;

    // ë¦¬ìŠ¤íŠ¸ active ì²˜ë¦¬
    document.querySelectorAll(".result-item").forEach((el, idx) => {
      el.classList.toggle("active", idx === index);
    });

    // ì¸í¬ìœˆë„ìš° ì—´ê¸° + ì§€ë„ ì„¼í„° ì´ë™
    infoWindows.forEach(iw => iw.close());
    const marker = markers[index];
    const iw = infoWindows[index];
    if (marker && iw) {
      iw.open(map, marker);
      map.setCenter(marker.getPosition());
      map.setLevel(5);
    }

    // ìƒì„¸ ì •ë³´
    const shop = marker.__shopData;
    renderSelectedDetail(shop, index + 1);
  }

  // ê°€ì¥ ê°€ê¹Œìš´ 5ê³³ ì°¾ê¸°
  function findNearest() {
    const searchStatus = document.getElementById("searchStatus");
    const addr = document.getElementById("addressInput").value.trim();

    if (!addr) {
      alert("ê³ ê° ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    if (!stores.length) {
      alert("ë¨¼ì € ì‹œê³µì  ì—‘ì…€ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.");
      return;
    }

    // geocoder ì´ˆê¸°í™” í™•ì¸
    if (!geocoder) {
      try {
        geocoder = new kakao.maps.services.Geocoder();
      } catch (e) {
        console.error("Geocoder ì´ˆê¸°í™” ì‹¤íŒ¨:", e);
        searchStatus.textContent = "âŒ ì§€ë„ ì„œë¹„ìŠ¤ë¥¼ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.";
        searchStatus.style.color = "#dc2626";
        return;
      }
    }

    searchStatus.textContent = "ì£¼ì†Œ ê²€ìƒ‰ ì¤‘â€¦";
    searchStatus.style.color = "#4b5563";

    // íƒ€ì„ì•„ì›ƒ ì„¤ì • (10ì´ˆ)
    const timeoutId = setTimeout(function() {
      searchStatus.textContent = "âŒ ì£¼ì†Œ ê²€ìƒ‰ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
      searchStatus.style.color = "#dc2626";
    }, 10000);

    geocoder.addressSearch(addr, function(res, status) {
      clearTimeout(timeoutId);

      if (status !== kakao.maps.services.Status.OK || !res || !res[0]) {
        let errorMsg = "âŒ ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        if (status === kakao.maps.services.Status.ZERO_RESULT) {
          errorMsg = "âŒ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ì£¼ì†Œë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.";
        } else if (status === kakao.maps.services.Status.ERROR) {
          errorMsg = "âŒ ì£¼ì†Œ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        } else if (status === kakao.maps.services.Status.OVER_QUERY_LIMIT) {
          errorMsg = "âŒ ìš”ì²­ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
        }
        searchStatus.textContent = errorMsg;
        searchStatus.style.color = "#dc2626";
        console.error("ì£¼ì†Œ ê²€ìƒ‰ ì‹¤íŒ¨:", status, addr);
        return;
      }

      const lat = parseFloat(res[0].y);
      const lng = parseFloat(res[0].x);
      const userLatLng = new kakao.maps.LatLng(lat, lng);

      // ì‚¬ìš©ì ë§ˆì»¤
      clearUserMarker();
      userMarker = new kakao.maps.Marker({
        map,
        position: userLatLng,
        image: new kakao.maps.MarkerImage(
          "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png",
          new kakao.maps.Size(40, 42)
        )
      });

      // ê¸°ì¡´ ì¶”ì²œ ë§ˆì»¤ ì œê±°
      clearMarkers();

      // ìœ íš¨í•œ ì¢Œí‘œê°€ ìˆëŠ” ì‹œê³µì ë§Œ
      const validStores = stores.filter(s => s.lat != null && s.lng != null);
      if (!validStores.length) {
        searchStatus.textContent = "âŒ ì¢Œí‘œ ì •ë³´ê°€ ìˆëŠ” ì‹œê³µì ì´ ì—†ìŠµë‹ˆë‹¤. ì—‘ì…€ ì£¼ì†Œë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.";
        searchStatus.style.color = "#dc2626";
        return;
      }

      // ê±°ë¦¬ ê³„ì‚°
      const withDistance = validStores.map(s => {
        const d = getDistanceKm(lat, lng, s.lat, s.lng);
        const eta = estimateMinutes(d);
        return { ...s, distanceKm: d, etaMin: eta };
      });

      withDistance.sort((a, b) => a.distanceKm - b.distanceKm);
      nearest = withDistance.slice(0, 5);

      // ë§ˆì»¤ ë° ì¸í¬ìœˆë„ìš° ìƒì„±
      // LatLngBounds ê°ì²´ ìƒì„± ë° ì¢Œí‘œ ìˆ˜ì§‘
      let bounds = null;
      const positions = [userLatLng];

      try {
        bounds = new kakao.maps.LatLngBounds();
        if (bounds && typeof bounds.extend === 'function') {
          bounds.extend(userLatLng);
        } else if (bounds && typeof bounds.add === 'function') {
          bounds.add(userLatLng);
        }
      } catch (e) {
        console.warn("LatLngBounds ìƒì„± ì‹¤íŒ¨, bounds ì—†ì´ ì§„í–‰:", e);
      }

      const blueSpriteSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_number_blue.png";
      const spriteSize = new kakao.maps.Size(36, 691);

      nearest.forEach((s, index) => {
        const pos = new kakao.maps.LatLng(s.lat, s.lng);
        positions.push(pos);

        const markerImage = new kakao.maps.MarkerImage(
          blueSpriteSrc,
          new kakao.maps.Size(36, 37),
          {
            spriteSize: spriteSize,
            spriteOrigin: new kakao.maps.Point(0, index * 46),
            offset: new kakao.maps.Point(13, 37)
          }
        );

        const marker = new kakao.maps.Marker({
          map,
          position: pos,
          image: markerImage
        });

        // ì¸í¬ìœˆë„ìš° ë‚´ìš©
        const distanceStr = s.distanceKm != null ? s.distanceKm.toFixed(1) + "km" : "-";
        const etaStr = s.etaMin != null ? s.etaMin + "ë¶„" : "-";

        const content = `
          <div style="padding:8px 10px;min-width:190px;border-radius:8px;border:1px solid #e5e7eb;background:#ffffff;box-shadow:0 8px 16px rgba(15,23,42,0.20);">
            <div style="font-size:12px;font-weight:600;color:#111827;margin-bottom:2px;">
              ${index + 1}. ${escapeHtml(s.name || "")}
            </div>
            <div style="font-size:11px;color:#6b7280;margin-bottom:2px;">
              ${escapeHtml(s.address || "")}
            </div>
            <div style="font-size:11px;color:#2563eb;margin-bottom:2px;">
              ${s.phone ? "ğŸ“ " + escapeHtml(s.phone) : ""}
            </div>
            <div style="font-size:11px;color:#4b5563;">
              ê±°ë¦¬: ${distanceStr} Â· ì˜ˆìƒ: ${etaStr}
            </div>
          </div>
        `;

        const iw = new kakao.maps.InfoWindow({
          content: content,
          removable: false
        });

        marker.__shopData = s;         // ìƒì„¸íŒ¨ë„ìš©
        markers.push(marker);
        infoWindows.push(iw);

        // boundsì— ì¶”ê°€ (ì•ˆì „í•˜ê²Œ)
        if (bounds) {
          try {
            if (typeof bounds.extend === 'function') {
              bounds.extend(pos);
            } else if (typeof bounds.add === 'function') {
              bounds.add(pos);
            }
          } catch (e) {
            console.warn("boundsì— ì¢Œí‘œ ì¶”ê°€ ì‹¤íŒ¨:", e);
          }
        }

        kakao.maps.event.addListener(marker, "click", function() {
          infoWindows.forEach(x => x.close());
          iw.open(map, marker);
          map.setCenter(marker.getPosition());
          map.setLevel(5);
          selectedIndex = index;
          // ë¦¬ìŠ¤íŠ¸ active + ìƒì„¸ ê°±ì‹ 
          document.querySelectorAll(".result-item").forEach((el, idx) => {
            el.classList.toggle("active", idx === index);
          });
          renderSelectedDetail(s, index + 1);
        });
      });

      // ì§€ë„ bounds ë§ì¶”ê¸°
      if (bounds && typeof map.setBounds === 'function') {
        try {
          map.setBounds(bounds);
        } catch (e) {
          console.warn("setBounds ì‹¤íŒ¨, ëŒ€ì‹  ì¤‘ì‹¬ì  ì„¤ì •:", e);
          // bounds ì‹¤íŒ¨ ì‹œ ì²« ë²ˆì§¸ ë§ˆì»¤ë¡œ ì¤‘ì‹¬ ì´ë™
          if (nearest.length > 0 && nearest[0].lat && nearest[0].lng) {
            map.setCenter(new kakao.maps.LatLng(nearest[0].lat, nearest[0].lng));
            map.setLevel(6);
          } else {
            map.setCenter(userLatLng);
            map.setLevel(6);
          }
        }
      } else {
        // bounds ì—†ì„ ë•Œ ì¤‘ì‹¬ì  ì„¤ì •
        if (nearest.length > 0 && nearest[0].lat && nearest[0].lng) {
          map.setCenter(new kakao.maps.LatLng(nearest[0].lat, nearest[0].lng));
          map.setLevel(6);
        } else {
          map.setCenter(userLatLng);
          map.setLevel(6);
        }
      }

      // ë¦¬ìŠ¤íŠ¸ & ì´ˆê¸° ìƒì„¸
      renderResultList(nearest);
      renderSelectedDetail(null, null);

      searchStatus.textContent = `âœ… ê²€ìƒ‰ ì™„ë£Œ: ì¶”ì²œ ì‹œê³µì  ${nearest.length}ê³³ í‘œì‹œ`;
      searchStatus.style.color = "#16a34a";
    });
  }

  // ì´ˆê¸°í™”
  function initMap() {
    try {
      if (typeof kakao === 'undefined' || !kakao.maps) {
        throw new Error("Kakao Maps SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
      }

      const mapContainer = document.getElementById("map");
      if (!mapContainer) {
        throw new Error("ì§€ë„ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      }

      map = new kakao.maps.Map(mapContainer, {
        center: new kakao.maps.LatLng(37.5665, 126.9780),
        level: 7
      });

      if (typeof kakao.maps.services !== 'undefined') {
        geocoder = new kakao.maps.services.Geocoder();
      } else {
        throw new Error("Geocoder ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      }

      console.log("ì§€ë„ ë° Geocoder ì´ˆê¸°í™” ì™„ë£Œ");
      console.log("Kakao Maps SDK ë²„ì „ í™•ì¸:", typeof kakao.maps);

      // Supabaseì—ì„œ ì‹œê³µì  ë°ì´í„° ë¡œë“œ (ë¹„ë™ê¸°)
      loadStoresFromStorage().catch(e => console.error("Failed to load stores:", e));
    } catch (e) {
      console.error("ì§€ë„ ì´ˆê¸°í™” ì˜¤ë¥˜:", e);
      const statusEl = document.getElementById("searchStatus");
      if (statusEl) {
        statusEl.textContent = "âŒ ì§€ë„ ì´ˆê¸°í™” ì‹¤íŒ¨: " + e.message;
        statusEl.style.color = "#dc2626";
      }
      alert("ì§€ë„ë¥¼ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + e.message + "\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
    }
  }

  // ì¹´ì¹´ì˜¤ ë§µ SDK ë¡œë“œ ëŒ€ê¸°
  function waitForKakaoSDK() {
    if (typeof kakao !== 'undefined' && kakao.maps && typeof kakao.maps.load === 'function') {
      kakao.maps.load(function() {
        console.log("Kakao Maps SDK ë¡œë“œ ì™„ë£Œ");
        initMap();
      });
    } else {
      // SDKê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì ì‹œ í›„ ì¬ì‹œë„
      setTimeout(waitForKakaoSDK, 100);
    }
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ SDK ëŒ€ê¸° ë° ì‚¬ê³ ìœ„ì¹˜ ìë™ ì…ë ¥
  function initializePage() {
    waitForKakaoSDK();
    
    // URL íŒŒë¼ë¯¸í„°ì—ì„œ address ê°€ì ¸ì˜¤ê¸°
    const urlParams = new URLSearchParams(window.location.search);
    let customerAddress = urlParams.get('address');
    
    // URL íŒŒë¼ë¯¸í„°ì— ì—†ìœ¼ë©´ localStorageì—ì„œ ê°€ì ¸ì˜¤ê¸°
    if (!customerAddress) {
      customerAddress = localStorage.getItem('accident_address') || '';
    }
    
    // customerAddressê°€ ìˆìœ¼ë©´ addressInputì— ìë™ ì…ë ¥
    if (customerAddress) {
      const addressInput = document.getElementById("addressInput");
      if (addressInput) {
        addressInput.value = customerAddress;
      }
    }
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializePage);
  } else {
    initializePage();
  }
</script>

</body>
</html>
