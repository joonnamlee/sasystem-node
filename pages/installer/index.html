<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ìë™ì°¨ ìœ ë¦¬ êµì²´ì  ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="stylesheet" as="style" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />

  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Supabase ì´ˆê¸°í™” -->
  <script src="/js/supabaseclient.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=ebeba9e3c5cb4bd9cecfcc0958ac20d4&libraries=services&autoload=false"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Pretendard, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f7fa;
      color: #2c3e50;
      overflow: hidden;
    }

    /* í—¤ë” */
    header {
      background: #ffffff;
      border-bottom: 1px solid #e1e8ed;
      padding: 16px 24px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.02);
      z-index: 100;
    }

    header h1 {
      font-size: 20px;
      font-weight: 600;
      color: #1a202c;
      margin-bottom: 4px;
    }

    header .subtitle {
      font-size: 13px;
      color: #718096;
    }

    /* ì»¨í…Œì´ë„ˆ */
    .container {
      display: flex;
      height: calc(100vh - 73px);
      position: relative;
    }

    /* ì‚¬ì´ë“œë°” (ì»¨íŠ¸ë¡¤ íŒ¨ë„) */
    .sidebar,
    .sidebar-panel {
      width: 420px;
      background: #ffffff;
      border-right: 1px solid #e1e8ed;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .sidebar-content {
      padding: 24px;
      flex: 1;
    }

    .sidebar-panel h3 {
      font-size: 18px;
      font-weight: 600;
      color: #1a202c;
      margin-bottom: 8px;
    }

    .sidebar-panel .desc {
      font-size: 13px;
      color: #718096;
      margin-bottom: 24px;
    }

    .panel-section {
      margin-bottom: 24px;
    }

    .panel-section h4 {
      font-size: 15px;
      font-weight: 600;
      color: #1a202c;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .panel-section h4::before {
      content: '';
      width: 4px;
      height: 16px;
      background: #3b82f6;
      border-radius: 2px;
    }

    .upload-box {
      margin-bottom: 12px;
    }

    .upload-box input[type="file"] {
      width: 100%;
      padding: 12px;
      border: 2px dashed #cbd5e0;
      border-radius: 8px;
      background: #f7fafc;
      font-size: 14px;
      font-family: Pretendard, sans-serif;
      cursor: pointer;
      transition: all 0.2s;
    }

    .upload-box input[type="file"]:hover {
      border-color: #3b82f6;
      background: #edf2f7;
    }

    .info-box {
      margin-top: 16px;
      padding: 12px 16px;
      background: #f7fafc;
      border-radius: 8px;
      border-left: 4px solid #3b82f6;
      font-size: 13px;
      color: #4a5568;
    }

    .info-box p {
      margin: 0;
      color: #1a202c;
    }

    .info-box h5 {
      font-size: 14px;
      font-weight: 600;
      color: #ef4444;
      margin: 0 0 8px 0;
    }

    .info-box ul {
      margin: 8px 0 0 0;
      padding-left: 20px;
      font-size: 12px;
      color: #718096;
    }

    .info-box li {
      margin: 4px 0;
    }

    .text-input {
      width: 100%;
      margin-bottom: 12px;
    }

    /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .card {
      background: #ffffff;
      border: 1px solid #e1e8ed;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      color: #1a202c;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title::before {
      content: '';
      width: 4px;
      height: 16px;
      background: #3b82f6;
      border-radius: 2px;
    }

    /* íŒŒì¼ ì…ë ¥ ìŠ¤íƒ€ì¼ */
    .file-input-wrapper {
      position: relative;
      margin-bottom: 12px;
    }

    .file-input-label {
      display: block;
      padding: 12px 16px;
      background: #f7fafc;
      border: 2px dashed #cbd5e0;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      color: #4a5568;
    }

    .file-input-label:hover {
      background: #edf2f7;
      border-color: #3b82f6;
    }

    .file-input-label.has-file {
      background: #eff6ff;
      border-color: #3b82f6;
      color: #3b82f6;
    }

    #fileInput {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }

    /* Material ìŠ¤íƒ€ì¼ ë²„íŠ¼ */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      font-family: Pretendard, sans-serif;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .btn-primary {
      background: #3b82f6;
      color: #ffffff;
      width: 100%;
      margin-bottom: 8px;
    }

    .btn-primary:hover {
      background: #2563eb;
      box-shadow: 0 4px 6px rgba(59,130,246,0.3);
    }

    .btn-secondary {
      background: #ffffff;
      color: #64748b;
      border: 1px solid #e1e8ed;
      width: 100%;
    }

    .btn-secondary:hover {
      background: #f7fafc;
      border-color: #cbd5e0;
    }

    .btn-danger {
      background: #ef4444;
      color: #ffffff;
      width: 100%;
      margin-top: 8px;
    }

    .btn-danger:hover {
      background: #dc2626;
      box-shadow: 0 4px 6px rgba(239,68,68,0.3);
    }

    /* ê²€ìƒ‰ ì˜ì—­ */
    .search-section {
      margin-top: 8px;
    }

    .input-group {
      margin-bottom: 12px;
    }

    .input-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #4a5568;
      margin-bottom: 8px;
    }

    .input-field {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #e1e8ed;
      border-radius: 8px;
      font-size: 14px;
      font-family: Pretendard, sans-serif;
      transition: all 0.2s;
      background: #ffffff;
    }

    .input-field:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
    }

    /* ìƒíƒœ í‘œì‹œ */
    #status {
      padding: 16px;
      background: #f7fafc;
      border-radius: 8px;
      font-size: 13px;
      line-height: 1.6;
      color: #4a5568;
      margin-bottom: 20px;
      border-left: 4px solid #3b82f6;
    }

    #status strong {
      color: #1a202c;
      display: block;
      margin-bottom: 4px;
    }

    /* ê²€ìƒ‰ ê²°ê³¼ ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ */
    #shopList {
      margin-top: 20px;
    }

    .result-header {
      font-size: 14px;
      font-weight: 600;
      color: #1a202c;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e1e8ed;
    }

    .shop-card {
      background: #ffffff;
      border: 1px solid #e1e8ed;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .shop-card:hover {
      border-color: #3b82f6;
      box-shadow: 0 4px 12px rgba(59,130,246,0.15);
      transform: translateY(-2px);
    }

    .shop-card.active {
      border-color: #3b82f6;
      background: #eff6ff;
      box-shadow: 0 4px 12px rgba(59,130,246,0.2);
    }

    .shop-card-rank {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 28px;
      height: 28px;
      background: #3b82f6;
      color: #ffffff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
    }

    .shop-card-name {
      font-size: 15px;
      font-weight: 600;
      color: #1a202c;
      margin-bottom: 8px;
      padding-right: 40px;
    }

    .shop-card-info {
      font-size: 13px;
      color: #718096;
      margin-bottom: 4px;
    }

    .shop-card-distance {
      font-size: 14px;
      font-weight: 600;
      color: #3b82f6;
      margin-top: 8px;
    }

    /* ì§€ë„ */
    #map {
      flex: 1;
      height: 100%;
      background: #e1e8ed;
    }

    /* êµ¬ë¶„ì„  */
    .divider {
      height: 1px;
      background: #e1e8ed;
      margin: 24px 0;
    }

    /* ëª¨ë°”ì¼ ëŒ€ì‘ */
    @media (max-width: 768px) {
      .container {
        flex-direction: column;
        height: calc(100vh - 73px);
      }

      .sidebar {
        width: 100%;
        height: 50%;
        border-right: none;
        border-top: 1px solid #e1e8ed;
        order: 2;
      }

      #map {
        height: 50%;
        order: 1;
      }

      .btn {
        padding: 14px 24px;
        font-size: 15px;
      }

      .sidebar-content {
        padding: 20px;
      }

      .card {
        padding: 16px;
      }
    }

    /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
    .sidebar::-webkit-scrollbar {
      width: 6px;
    }

    .sidebar::-webkit-scrollbar-track {
      background: #f7fafc;
    }

    .sidebar::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 3px;
    }

    .sidebar::-webkit-scrollbar-thumb:hover {
      background: #a0aec0;
    }

    /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #cbd5e0;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ë¹ˆ ìƒíƒœ */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #a0aec0;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }

    .empty-state-text {
      font-size: 14px;
    }

    /* í† ìŠ¤íŠ¸ ì•Œë¦¼ */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #ffffff;
      border: 1px solid #e1e8ed;
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 300px;
      animation: slideIn 0.3s ease-out;
      font-size: 14px;
    }

    .toast.success {
      border-left: 4px solid #10b981;
    }

    .toast.error {
      border-left: 4px solid #ef4444;
    }

    .toast-icon {
      font-size: 20px;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      color: #1a202c;
      margin-bottom: 4px;
    }

    .toast-message {
      color: #718096;
      font-size: 13px;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    /* ì•¡ì…˜ ë²„íŠ¼ ê·¸ë£¹ */
    .shop-card-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .btn-action {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      font-family: Pretendard, sans-serif;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .btn-action:active {
      transform: translateY(1px);
    }

    .btn-call {
      background: #10b981;
      color: #ffffff;
    }

    .btn-call:hover {
      background: #059669;
      box-shadow: 0 2px 4px rgba(16,185,129,0.3);
    }

    .btn-navigate {
      background: #3b82f6;
      color: #ffffff;
    }

    .btn-navigate:hover {
      background: #2563eb;
      box-shadow: 0 2px 4px rgba(59,130,246,0.3);
    }
  </style>
</head>

<body>
<header>
  <h1>ğŸš— ìë™ì°¨ ìœ ë¦¬ êµì²´ì  ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
  <div class="subtitle">ê³ ê° ìƒë‹´ ì¤‘ ì¦‰ì‹œ ì§€ì  ê²€ìƒ‰ ë° ì§€ë„ ì•ˆë‚´</div>
</header>

<div class="container">
  <!-- ì¢Œì¸¡ ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
  <div id="installer-sidebar" class="sidebar-panel sidebar">
    <div class="sidebar-content">
      <h3>ğŸ›  ìë™ì°¨ ìœ ë¦¬ êµì²´ì  ê´€ë¦¬ ì‹œìŠ¤í…œ</h3>
      <p class="desc">ê³ ê° ìƒë‹´ ì¤‘ ì¦‰ì‹œ ì§€ì  ê²€ìƒ‰ ë° ì§€ë„ ì•ˆë‚´</p>

      <div class="panel-section">
        <h4>ğŸ“ ì§€ì  ë°ì´í„° ê´€ë¦¬</h4>
        <div class="upload-box">
          <input id="excelFile" type="file" accept=".xlsx, .xls">
        </div>

        <button id="uploadBtn" class="btn btn-primary">ğŸ“¤ ì—‘ì…€ ì—…ë¡œë“œ / ì—…ë°ì´íŠ¸</button>
        <button id="clearBtn" class="btn btn-danger">ğŸ—‘ ì €ì¥ëœ ë°ì´í„° ì‚­ì œ</button>

        <div id="savedInfo" class="info-box">
          <p>ì €ì¥ëœ ì§€ì  ìˆ˜: <span id="branchCount">0ê°œ</span></p>
        </div>

        <div id="failedList" class="info-box" style="display: none;">
          <h5>âš  ì‹¤íŒ¨í•œ ì£¼ì†Œ ëª©ë¡</h5>
          <ul id="failedItems"></ul>
        </div>
      </div>

      <div class="panel-section">
        <h4>ğŸ” ê³ ê° ì£¼ì†Œ ê²€ìƒ‰</h4>
        <input id="customerAddress" type="text" class="text-input input-field" placeholder="ì˜ˆ: ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123" onkeypress="if(event.key==='Enter') searchNearest()">
        <button id="findBtn" class="btn btn-secondary">ğŸ“ ê°€ê¹Œìš´ ì§€ì  5ê³³ ì°¾ê¸°</button>
      </div>

      <!-- ê²€ìƒ‰ ê²°ê³¼ -->
      <div id="shopList"></div>
    </div>
  </div>

  <!-- ìš°ì¸¡ ì§€ë„ -->
  <div id="map"></div>
</div>

<!-- í† ìŠ¤íŠ¸ ì•Œë¦¼ -->
<div id="toast" class="toast" style="display: none;"></div>

<script>
let map, geocoder;
let shops = [];
let markers = [];
let infoWindows = [];
let customerMarker = null;
let currentResults = [];
let activeMarkerIndex = -1;

/* âœ… ì§€ë„ ìµœì´ˆ 1íšŒë§Œ ìƒì„± */
function initMap() {
  map = new kakao.maps.Map(document.getElementById("map"), {
    center: new kakao.maps.LatLng(37.5665, 126.9780),
    level: 8
  });
  geocoder = new kakao.maps.services.Geocoder();
}

// Error handling helper
function checkError(error) {
  if (error) {
    console.error("Supabase error:", error);
    alert("ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    throw error;
  }
}

/* âœ… ì €ì¥ëœ ë°ì´í„° ë¡œë“œ */
async function loadData() {
  if (!window.supabaseClient) {
    shops = [];
    document.getElementById("branchCount").textContent = "0ê°œ";
    return;
  }

  try {
    const { data, error } = await window.supabaseClient
      .from("installer_locations")
      .select("*")
      .order("seq", { ascending: true });

    checkError(error);

    shops = (data || []).map(s => ({
      ìˆœë²ˆ: s.seq,
      ìƒí˜¸: s.name,
      ì£¼ì†Œ: s.address,
      ì „í™”ë²ˆí˜¸: s.phone,
      lat: s.lat,
      lng: s.lng
    }));

    document.getElementById("branchCount").textContent = `${shops.length}ê°œ`;
  } catch (e) {
    console.error("Failed to load shops:", e);
    shops = [];
    document.getElementById("branchCount").textContent = "0ê°œ";
  }
}

/* âœ… íŒŒì¼ ì…ë ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ */
document.getElementById("excelFile").addEventListener("change", function(e) {
  // íŒŒì¼ ì„ íƒ ì‹œ ì²˜ë¦¬ (í•„ìš”ì‹œ ì¶”ê°€)
});

/* âœ… ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ */
document.getElementById("uploadBtn").addEventListener("click", uploadExcel);
document.getElementById("clearBtn").addEventListener("click", clearData);
document.getElementById("findBtn").addEventListener("click", searchNearest);

/* âœ… ì—‘ì…€ ì—…ë¡œë“œ */
function uploadExcel() {
  const file = document.getElementById("excelFile").files[0];
  if (!file) {
    alert("ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    document.getElementById("fileInput").click();
    return;
  }

  if (!confirm("ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  // ì‹¤íŒ¨ ì£¼ì†Œ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
  failedAddresses = [];

  const reader = new FileReader();
  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    let json = XLSX.utils.sheet_to_json(sheet);

    let completed = 0;
    let totalWithAddress = 0;

    // ì£¼ì†Œê°€ ìˆëŠ” í•­ëª©ë§Œ ì¹´ìš´íŠ¸
    json.forEach(shop => {
      if (shop.ì£¼ì†Œ || shop.address) totalWithAddress++;
    });

    if (totalWithAddress === 0) {
      alert("ì£¼ì†Œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ì—‘ì…€ íŒŒì¼ì— 'ì£¼ì†Œ' ë˜ëŠ” 'address' ì»¬ëŸ¼ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      return;
    }

    // geocoder ì´ˆê¸°í™” í™•ì¸
    if (!geocoder) {
      try {
        geocoder = new kakao.maps.services.Geocoder();
      } catch (e) {
        console.error('Geocoder ì´ˆê¸°í™” ì‹¤íŒ¨:', e);
        showToast('error', 'ì´ˆê¸°í™” ì˜¤ë¥˜', 'ì§€ë„ ì„œë¹„ìŠ¤ë¥¼ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
    }

    let successCount = 0;
    let failCount = 0;

    json.forEach((shop, idx) => {
      const address = shop.ì£¼ì†Œ || shop.address;
      if (!address) {
        failedAddresses.push("ì£¼ì†Œ ì—†ìŒ");
        completed++;
        if (completed === json.length) {
          finishUpload(json, successCount, failCount);
        }
        return;
      }

      geocoder.addressSearch(address, function (res, status) {
        if (status === kakao.maps.services.Status.OK && res && res.length > 0) {
          shop.lat = parseFloat(res[0].y);
          shop.lng = parseFloat(res[0].x);
          successCount++;
        } else {
          console.warn(`ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨: ${address} (ìƒíƒœ: ${status})`);
          failedAddresses.push(address);
          failCount++;
        }

        completed++;
        if (completed === json.length) {
          finishUpload(json, successCount, failCount);
        }
      });
    });
  };

  reader.readAsArrayBuffer(file);
}

/* âœ… ì—…ë¡œë“œ ì™„ë£Œ ì²˜ë¦¬ */
async function finishUpload(json, successCount = null, failCount = null) {
  if (!window.supabaseClient) {
    alert("Supabase client not available");
    return;
  }
  
  try {
    // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ
    await window.supabaseClient
        .from("installer_locations")
        .delete()
        .neq("id", "00000000-0000-0000-0000-000000000000");

      // ìƒˆ ë°ì´í„° ì‚½ì…
      if (json.length > 0) {
        const records = json.map(s => ({
          seq: s.ìˆœë²ˆ || s.seq || "",
          name: s.ìƒí˜¸ || s.name || "",
          address: s.ì£¼ì†Œ || s.address || "",
          phone: s.ì „í™”ë²ˆí˜¸ || s.phone || "",
          lat: s.lat,
          lng: s.lng
        }));

        const { error } = await client
          .from("installer_locations")
          .insert(records);

        checkError(error);
      }
    } catch (e) {
      console.error("Failed to save to Supabase:", e);
    }
  }

  shops = json;
  
  let statusMessage = '';
  if (successCount !== null && failCount !== null) {
    const totalWithAddress = successCount + failCount;
    if (failCount > 0) {
      statusMessage = `<strong>âš ï¸ ì—…ë¡œë“œ ì™„ë£Œ (ì¼ë¶€ ì‹¤íŒ¨)</strong><br>ì„±ê³µ: <strong>${successCount}ê°œ</strong> / ì‹¤íŒ¨: <strong>${failCount}ê°œ</strong><br><small style="color:#718096;">ì‹¤íŒ¨í•œ ì£¼ì†ŒëŠ” ì¢Œí‘œ ë³€í™˜ì´ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</small>`;
    } else {
      statusMessage = `<strong>âœ… ì—…ë¡œë“œ ì™„ë£Œ!</strong><br><strong>${successCount}ê°œ</strong> ì§€ì ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.<br><small style="color:#718096;">ì´ì œ ê³„ì† ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>`;
    }
  } else {
    statusMessage = `<strong>âœ… ì—…ë¡œë“œ ì™„ë£Œ!</strong><br><strong>${json.length}ê°œ</strong> ì§€ì ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.<br><small style="color:#718096;">ì´ì œ ê³„ì† ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>`;
  }
  
  document.getElementById("excelFile").value = "";
  clearMarkers();
  document.getElementById("shopList").innerHTML = "";
  
  // ì—…ë¡œë“œ ê²°ê³¼ ë Œë”ë§
  if (successCount !== null && failCount !== null) {
    renderUploadResult(successCount, failCount);
  } else {
    document.getElementById("branchCount").textContent = `${json.length}ê°œ`;
  }
  
  // í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ
  if (failCount && failCount > 0) {
    showToast('error', 'ì—…ë¡œë“œ ì™„ë£Œ (ì¼ë¶€ ì‹¤íŒ¨)', `${successCount}ê°œ ì„±ê³µ, ${failCount}ê°œ ì‹¤íŒ¨`);
  } else {
    showToast('success', 'ì—…ë¡œë“œ ì™„ë£Œ', `${json.length}ê°œ ì§€ì ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
  }
}

/* âœ… ì €ì¥ëœ ë°ì´í„° ì‚­ì œ */
async function clearData() {
  if (!confirm("ì €ì¥ëœ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  if (!window.supabaseClient) {
    alert("Supabase client not available");
    return;
  }
  
  try {
    const { error } = await window.supabaseClient
        .from("installer_locations")
        .delete()
        .neq("id", "00000000-0000-0000-0000-000000000000");

      checkError(error);
    } catch (e) {
      console.error("Failed to delete:", e);
    }
  }

  shops = [];
  document.getElementById("branchCount").textContent = "0ê°œ";
  document.getElementById("failedList").style.display = "none";
  document.getElementById("failedItems").innerHTML = "";
  document.getElementById("shopList").innerHTML = "";
  clearMarkers();
}

/* âœ… ê±°ë¦¬ ê³„ì‚° */
function distanceMeters(lat1, lon1, lat2, lon2) {
  function toRad(v) { return v * Math.PI / 180; }
  const R = 6371000;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a =
    Math.sin(dLat/2) ** 2 +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
    Math.sin(dLon/2) ** 2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

/* âœ… ê¸°ì¡´ ë§ˆì»¤ ì‚­ì œ */
function clearMarkers() {
  markers.forEach(m => m.setMap(null));
  infoWindows.forEach(iw => iw.close());
  markers = [];
  infoWindows = [];
  activeMarkerIndex = -1;
  if (customerMarker) {
    customerMarker.setMap(null);
    customerMarker = null;
  }
}

/* âœ… ì§€ì  ì¹´ë“œ í´ë¦­ ì‹œ ì§€ë„ ì¤‘ì‹¬ ì´ë™ ë° ë§ˆì»¤ ê°•ì¡° */
function focusShop(index) {
  if (!currentResults[index]) return;
  
  const shop = currentResults[index];
  const position = new kakao.maps.LatLng(shop.lat, shop.lng);
  
  // ì§€ë„ ì¤‘ì‹¬ ì´ë™
  map.setCenter(position);
  map.setLevel(5); // í™•ëŒ€
  
  // í™œì„± ì¹´ë“œ í‘œì‹œ ë° ìŠ¤í¬ë¡¤
  const cards = document.querySelectorAll('.shop-card');
  cards.forEach((card, i) => {
    if (i === index) {
      card.classList.add('active');
      // ì¹´ë“œê°€ ë³´ì´ë„ë¡ ìŠ¤í¬ë¡¤
      card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    } else {
      card.classList.remove('active');
    }
  });
  
  // ë§ˆì»¤ ê°•ì¡°
  if (markers[index]) {
    const markerPosition = markers[index].getPosition();
    map.panTo(markerPosition);
  }
}

/* âœ… ë§ˆì»¤ í´ë¦­ ì‹œ ì¹´ë“œ ê°•ì¡° */
function highlightCardFromMarker(index) {
  if (!currentResults[index]) return;
  
  const shop = currentResults[index];
  const position = new kakao.maps.LatLng(shop.lat, shop.lng);
  
  // ì§€ë„ ì¤‘ì‹¬ ì´ë™
  map.setCenter(position);
  map.setLevel(5);
  
  // í™œì„± ì¹´ë“œ í‘œì‹œ ë° ìŠ¤í¬ë¡¤
  const cards = document.querySelectorAll('.shop-card');
  cards.forEach((card, i) => {
    if (i === index) {
      card.classList.add('active');
      // ì¹´ë“œê°€ ë³´ì´ë„ë¡ ìŠ¤í¬ë¡¤
      card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    } else {
      card.classList.remove('active');
    }
  });
}

/* âœ… ì „í™”ê±¸ê¸° */
function callShop(phoneNumber) {
  if (!phoneNumber) {
    showToast('error', 'ì „í™”ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  // ì „í™”ë²ˆí˜¸ì—ì„œ í•˜ì´í”ˆ, ê³µë°± ì œê±°
  const cleanPhone = phoneNumber.replace(/[-\s]/g, '');
  window.location.href = `tel:${cleanPhone}`;
}

/* âœ… ê¸¸ì°¾ê¸° */
function navigateToShop(shop) {
  if (!shop.lat || !shop.lng) {
    showToast('error', 'ìœ„ì¹˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  // ì¹´ì¹´ì˜¤ë§µ ê¸¸ì°¾ê¸° URL
  const url = `https://map.kakao.com/link/to/${shop.ìƒí˜¸ || shop.name || 'ëª©ì ì§€'},${shop.lat},${shop.lng}`;
  window.open(url, '_blank');
}

/* âœ… HTML ì´ìŠ¤ì¼€ì´í”„ */
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

/* âœ… í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ */
function showToast(type, title, message) {
  const toast = document.getElementById('toast');
  const icon = type === 'success' ? 'âœ…' : 'âŒ';
  
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    <div class="toast-icon">${icon}</div>
    <div class="toast-content">
      <div class="toast-title">${title}</div>
      ${message ? `<div class="toast-message">${message}</div>` : ''}
    </div>
  `;
  
  toast.style.display = 'flex';
  
  // 3ì´ˆ í›„ ìë™ ìˆ¨ê¹€
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease-out';
    setTimeout(() => {
      toast.style.display = 'none';
      toast.style.animation = '';
    }, 300);
  }, 3000);
}

/* âœ… ê²€ìƒ‰ ì‹¤í–‰ */
function searchNearest() {
  const addr = document.getElementById("customerAddress").value.trim();
  if (!addr) {
    alert("ê³ ê° ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    document.getElementById("customerAddress").focus();
    return;
  }
  if (!shops.length) {
    alert("ì—‘ì…€ íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.");
    return;
  }

  // ì¹´ì¹´ì˜¤ë§µ API ë° geocoder í™•ì¸
  if (typeof kakao === 'undefined' || !kakao.maps) {
    showToast('error', 'API ì˜¤ë¥˜', 'ì¹´ì¹´ì˜¤ë§µ APIë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }

  if (!geocoder) {
    try {
      geocoder = new kakao.maps.services.Geocoder();
    } catch (e) {
      console.error('Geocoder ì´ˆê¸°í™” ì‹¤íŒ¨:', e);
      showToast('error', 'ì´ˆê¸°í™” ì˜¤ë¥˜', 'ì§€ë„ ì„œë¹„ìŠ¤ë¥¼ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
  }

  geocoder.addressSearch(addr, function (res, status) {
    let errorMessage = '';
    
    if (status === kakao.maps.services.Status.OK) {
      // ì„±ê³µ - ê³„ì† ì§„í–‰
    } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
      errorMessage = 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ì£¼ì†Œë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.';
    } else if (status === kakao.maps.services.Status.ERROR) {
      errorMessage = 'ì£¼ì†Œ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
    } else if (status === kakao.maps.services.Status.OVER_QUERY_LIMIT) {
      errorMessage = 'ìš”ì²­ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
    } else {
      errorMessage = `ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì˜¤ë¥˜ ì½”ë“œ: ${status})<br>ë‹¤ë¥¸ í˜•ì‹ìœ¼ë¡œ ì£¼ì†Œë¥¼ ì…ë ¥í•´ë³´ì„¸ìš”.<br><small>ì˜ˆ: "ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123" ë˜ëŠ” "ì„œìš¸ ê°•ë‚¨êµ¬"</small>`;
    }

    if (status !== kakao.maps.services.Status.OK) {
      console.error('ì£¼ì†Œ ê²€ìƒ‰ ì‹¤íŒ¨:', status, addr);
      showToast('error', 'ì£¼ì†Œ ê²€ìƒ‰ ì‹¤íŒ¨', errorMessage.split('<br>')[0]);
      return;
    }

    if (!res || res.length === 0) {
      showToast('error', 'ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ', 'ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    const clat = parseFloat(res[0].y);
    const clng = parseFloat(res[0].x);

    // ê³ ê° ì£¼ì†Œ ë§ˆì»¤ ìƒì„± (ë¹¨ê°„ìƒ‰)
    if (customerMarker) {
      customerMarker.setMap(null);
    }
    
    // ë¹¨ê°„ìƒ‰ ë§ˆì»¤ ì´ë¯¸ì§€ ìƒì„±
    // ì¹´ì¹´ì˜¤ë§µ ê¸°ë³¸ ë¹¨ê°„ìƒ‰ ë§ˆì»¤ ì´ë¯¸ì§€ ì‚¬ìš©
    const imageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png';
    const imageSize = new kakao.maps.Size(24, 35);
    const imageOption = { offset: new kakao.maps.Point(12, 35) };
    const markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);
    
    // ê¸°ì¡´ ê³ ê° ë§ˆì»¤ê°€ ìˆìœ¼ë©´ ì œê±°
    if (customerMarker) {
      customerMarker.setMap(null);
      customerMarker = null;
    }
    
    customerMarker = new kakao.maps.Marker({
      map: map,
      position: new kakao.maps.LatLng(clat, clng),
      image: markerImage,
      zIndex: 1000 // ë‹¤ë¥¸ ë§ˆì»¤ë³´ë‹¤ ìœ„ì— í‘œì‹œ
    });
    
    // ê³ ê° ìœ„ì¹˜ ì¸í¬ìœˆë„ìš° ìƒì„±
    const customerInfoContent = `
      <div style="padding:12px; min-width:180px; font-family:Pretendard, sans-serif;">
        <div style="font-weight:600; font-size:14px; color:#ef4444; margin-bottom:4px;">
          ğŸ“ ê³ ê° ìœ„ì¹˜
        </div>
        <div style="font-size:12px; color:#718096;">
          ${escapeHtml(addr)}
        </div>
      </div>
    `;
    
    const customerInfoWindow = new kakao.maps.InfoWindow({
      content: customerInfoContent,
      removable: false
    });
    
    // ê³ ê° ë§ˆì»¤ì— ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ì¸í¬ìœˆë„ìš° í‘œì‹œ
    kakao.maps.event.addListener(customerMarker, 'mouseover', function() {
      customerInfoWindow.open(map, customerMarker);
    });
    
    kakao.maps.event.addListener(customerMarker, 'mouseout', function() {
      customerInfoWindow.close();
    });

    // ì¢Œí‘œê°€ ìˆëŠ” ì§€ì ë§Œ í•„í„°ë§
    const validShops = shops.filter(s => s.lat && s.lng);
    
    const result = validShops
      .map(s => ({
        ...s,
        distance: distanceMeters(clat, clng, s.lat, s.lng)
      }))
      .sort((a,b) => a.distance - b.distance)
      .slice(0,5);

    // ì§€ë„ ì¤‘ì‹¬ì„ ê³ ê° ì£¼ì†Œë¡œ ì´ë™ (ê²€ìƒ‰ ê²°ê³¼ì™€ ê´€ê³„ì—†ì´)
    map.setCenter(new kakao.maps.LatLng(clat, clng));
    map.setLevel(6);
    
    if (result.length === 0) {
      document.getElementById("shopList").innerHTML = "";
      // ì§€ì  ë§ˆì»¤ë§Œ ì‚­ì œí•˜ê³  ê³ ê° ë§ˆì»¤ëŠ” ìœ ì§€
      markers.forEach(m => m.setMap(null));
      infoWindows.forEach(iw => iw.close());
      markers = [];
      infoWindows = [];
      showToast('error', 'ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ', 'ì €ì¥ëœ ì§€ì  ë°ì´í„°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
      return;
    }

    currentResults = result;

    /* âœ… ê²€ìƒ‰ ê²°ê³¼ ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ ì¶œë ¥ */
    const shopListContainer = document.getElementById("shopList");
    const header = document.createElement('div');
    header.className = 'result-header';
    header.textContent = `ğŸ“ ê°€ê¹Œìš´ ì§€ì  ${result.length}ê³³`;
    shopListContainer.innerHTML = '';
    shopListContainer.appendChild(header);
    
    result.forEach((s, i) => {
      const phone = s.ì „í™”ë²ˆí˜¸ || s.phone || s.tel || '';
      const card = document.createElement('div');
      card.className = 'shop-card';
      card.onclick = () => focusShop(i);
      
      card.innerHTML = `
        <div class="shop-card-rank">${i + 1}</div>
        <div class="shop-card-name">${escapeHtml(s.ìƒí˜¸ || s.name || s.ìƒí˜¸ëª… || 'ì´ë¦„ ì—†ìŒ')}</div>
        ${s.ì£¼ì†Œ || s.address ? `<div class="shop-card-info">ğŸ“ ${escapeHtml(s.ì£¼ì†Œ || s.address)}</div>` : ''}
        ${phone ? `<div class="shop-card-info">ğŸ“ ${escapeHtml(phone)}</div>` : ''}
        <div class="shop-card-distance">ê±°ë¦¬: ${(s.distance/1000).toFixed(2)}km</div>
        <div class="shop-card-actions" onclick="event.stopPropagation()">
          ${phone ? `<button class="btn-action btn-call" data-phone="${escapeHtml(phone)}">
            <span>ğŸ“</span>
            <span>ì „í™”ê±¸ê¸°</span>
          </button>` : ''}
          <button class="btn-action btn-navigate" data-index="${i}">
            <span>ğŸ—ºï¸</span>
            <span>ê¸¸ì°¾ê¸°</span>
          </button>
        </div>
      `;
      
      // ì „í™”ê±¸ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
      if (phone) {
        const callBtn = card.querySelector('.btn-call');
        if (callBtn) {
          callBtn.onclick = (e) => {
            e.stopPropagation();
            callShop(phone);
          };
        }
      }
      
      // ê¸¸ì°¾ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
      const navBtn = card.querySelector('.btn-navigate');
      if (navBtn) {
        navBtn.onclick = (e) => {
          e.stopPropagation();
          navigateToShop(s);
        };
      }
      
      shopListContainer.appendChild(card);
    });

    /* âœ… ì§€ë„ ë§ˆì»¤ ê°±ì‹  (ê³ ê° ë§ˆì»¤ëŠ” ìœ ì§€) */
    markers.forEach(m => m.setMap(null));
    infoWindows.forEach(iw => iw.close());
    markers = [];
    infoWindows = [];

    result.forEach((s, i) => {
      const marker = new kakao.maps.Marker({
        map: map,
        position: new kakao.maps.LatLng(s.lat, s.lng)
      });
      
      // ì¸í¬ìœˆë„ìš° ìƒì„±
      const phone = s.ì „í™”ë²ˆí˜¸ || s.phone || s.tel || '';
      const name = s.ìƒí˜¸ || s.name || s.ìƒí˜¸ëª… || 'ì´ë¦„ ì—†ìŒ';
      const address = s.ì£¼ì†Œ || s.address || '';
      const distance = (s.distance/1000).toFixed(2);
      
      const infoContent = `
        <div style="padding:12px; min-width:200px; font-family:Pretendard, sans-serif;">
          <div style="font-weight:600; font-size:14px; color:#1a202c; margin-bottom:8px;">
            ${escapeHtml(name)}
          </div>
          ${address ? `<div style="font-size:12px; color:#718096; margin-bottom:4px;">
            ğŸ“ ${escapeHtml(address)}
          </div>` : ''}
          ${phone ? `<div style="font-size:12px; color:#718096; margin-bottom:4px;">
            ğŸ“ ${escapeHtml(phone)}
          </div>` : ''}
          <div style="font-size:13px; font-weight:600; color:#3b82f6; margin-top:8px; padding-top:8px; border-top:1px solid #e1e8ed;">
            ê±°ë¦¬: ${distance}km
          </div>
        </div>
      `;
      
      const infoWindow = new kakao.maps.InfoWindow({
        content: infoContent,
        removable: false
      });
      
      // ë§ˆì»¤ì— ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ì¸í¬ìœˆë„ìš° í‘œì‹œ
      kakao.maps.event.addListener(marker, 'mouseover', function() {
        infoWindow.open(map, marker);
      });
      
      // ë§ˆì»¤ì—ì„œ ë§ˆìš°ìŠ¤ ì•„ì›ƒ ì‹œ ì¸í¬ìœˆë„ìš° ë‹«ê¸°
      kakao.maps.event.addListener(marker, 'mouseout', function() {
        infoWindow.close();
      });
      
      // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
      kakao.maps.event.addListener(marker, 'click', function() {
        highlightCardFromMarker(i);
      });
      
      markers.push(marker);
      infoWindows.push(infoWindow);
    });

    // ì§€ë„ ì¤‘ì‹¬ì€ ì´ë¯¸ ìœ„ì—ì„œ ì´ë™í–ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ë‹¤ì‹œ ì´ë™í•˜ì§€ ì•ŠìŒ
    
    showToast('success', 'ê²€ìƒ‰ ì™„ë£Œ', `${result.length}ê°œ ì§€ì ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.`);
  });
}

/* âœ… ìµœì´ˆ ì‹¤í–‰ */
window.onload = function () {
  // ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ í™•ì¸
  if (typeof kakao === 'undefined') {
    document.getElementById("status").innerHTML = 
      `<strong>âŒ ì¹´ì¹´ì˜¤ë§µ APIë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</strong><br>ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê³  í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.`;
    console.error('ì¹´ì¹´ì˜¤ë§µ APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    return;
  }

  kakao.maps.load(function () {
    try {
      initMap();
      loadData();
    } catch (e) {
      console.error('ì§€ë„ ì´ˆê¸°í™” ì˜¤ë¥˜:', e);
      document.getElementById("status").innerHTML = 
        `<strong>âŒ ì§€ë„ë¥¼ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</strong><br>ì˜¤ë¥˜: ${e.message}<br>í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.`;
      showToast('error', 'ì´ˆê¸°í™” ì˜¤ë¥˜', 'ì§€ë„ë¥¼ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
  });
};
</script>
</body>
</html>
