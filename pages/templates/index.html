<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì˜µì…˜ ë°œì£¼ í…œí”Œë¦¿ ê´€ë¦¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="stylesheet" as="style" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Pretendard, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f7fa;
      color: #2c3e50;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #e1e8ed;
    }

    h1 {
      font-size: 24px;
      font-weight: 600;
      color: #1a202c;
      margin-bottom: 8px;
    }

    .subtitle {
      font-size: 14px;
      color: #718096;
      margin-bottom: 32px;
    }

    .template-section {
      margin-bottom: 32px;
    }

    .template-section:last-child {
      margin-bottom: 0;
    }

    .template-section h2 {
      font-size: 18px;
      font-weight: 600;
      color: #1a202c;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .template-section h2::before {
      content: '';
      width: 4px;
      height: 18px;
      background: #3b82f6;
      border-radius: 2px;
    }

    .variable-list {
      background: #f7fafc;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      font-size: 13px;
      color: #4a5568;
    }

    .variable-list strong {
      display: block;
      margin-bottom: 8px;
      color: #1a202c;
    }

    .variable-list code {
      background: #edf2f7;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #3b82f6;
    }

    textarea {
      width: 100%;
      min-height: 300px;
      padding: 16px;
      border: 1px solid #e1e8ed;
      border-radius: 8px;
      font-size: 14px;
      font-family: Pretendard, sans-serif;
      resize: vertical;
      line-height: 1.6;
    }

    textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
    }

    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      font-family: Pretendard, sans-serif;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    button:active {
      transform: translateY(1px);
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .btn-primary {
      background: #3b82f6;
      color: #ffffff;
      flex: 1;
    }

    .btn-primary:hover {
      background: #2563eb;
      box-shadow: 0 4px 6px rgba(59,130,246,0.3);
    }

    .btn-secondary {
      background: #ffffff;
      color: #64748b;
      border: 1px solid #e1e8ed;
    }

    .btn-secondary:hover {
      background: #f7fafc;
      border-color: #cbd5e0;
    }

    @media (max-width: 768px) {
      .button-group {
        flex-direction: column;
      }

      button {
        width: 100%;
      }
    }
  </style>
</head>

<body>

<div class="container">
  <h1>ğŸ“ ì˜µì…˜ ë°œì£¼ í…œí”Œë¦¿ ê´€ë¦¬</h1>
  <p class="subtitle">ë°œì£¼ì²˜ ë° ì‹œê³µì  ì¹´ì¹´ì˜¤í†¡ ë©”ì‹œì§€ í…œí”Œë¦¿ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>

  <div class="template-section">
    <h2>ë°œì£¼ì²˜ í…œí”Œë¦¿</h2>
    <div class="variable-list">
      <strong>ì‚¬ìš© ê°€ëŠ¥í•œ ë³€ìˆ˜:</strong>
      <code>{{ì ‘ìˆ˜ë²ˆí˜¸}}</code>, <code>{{ì‚¬ê³ ì¼ì‹œ}}</code>, <code>{{ê³ ê°ëª…}}</code>, <code>{{ì—°ë½ì²˜}}</code>, 
      <code>{{ì°¨ëŸ‰ë²ˆí˜¸}}</code>, <code>{{VIN}}</code>, <code>{{ì°¨ëª…}}</code>, <code>{{ë©´ì±…ê¸ˆ}}</code>, 
      <code>{{ë©´ì±…ê¸ˆë°©ì‹}}</code>, <code>{{ë³´í—˜ì‚¬}}</code>, <code>{{íŒŒì†ë¶€ìœ„}}</code>, <code>{{ì‚¬ê³ ìœ„ì¹˜}}</code>,
      <code>{{HUD}}</code>, <code>{{ì°¨ìŒìœ ë¦¬}}</code>, <code>{{ì¹´ë©”ë¼}}</code>, <code>{{ë ˆì¸ì„¼ì„œ}}</code>
    </div>
    <textarea id="vendorTemplate" placeholder="ë°œì£¼ì²˜ ë©”ì‹œì§€ í…œí”Œë¦¿ì„ ì…ë ¥í•˜ì„¸ìš”.&#10;ì˜ˆ: ì°¨ëŸ‰: {{ì°¨ëª…}}&#10;VIN: {{VIN}}&#10;..."></textarea>
  </div>

  <div class="template-section">
    <h2>ì‹œê³µì  í…œí”Œë¦¿</h2>
    <div class="variable-list">
      <strong>ì‚¬ìš© ê°€ëŠ¥í•œ ë³€ìˆ˜:</strong>
      <code>{{ì ‘ìˆ˜ë²ˆí˜¸}}</code>, <code>{{ì‚¬ê³ ì¼ì‹œ}}</code>, <code>{{ê³ ê°ëª…}}</code>, <code>{{ì—°ë½ì²˜}}</code>, 
      <code>{{ì°¨ëŸ‰ë²ˆí˜¸}}</code>, <code>{{VIN}}</code>, <code>{{ì°¨ëª…}}</code>, <code>{{ë©´ì±…ê¸ˆ}}</code>, 
      <code>{{ë©´ì±…ê¸ˆë°©ì‹}}</code>, <code>{{ë³´í—˜ì‚¬}}</code>, <code>{{íŒŒì†ë¶€ìœ„}}</code>, <code>{{ì‚¬ê³ ìœ„ì¹˜}}</code>,
      <code>{{HUD}}</code>, <code>{{ì°¨ìŒìœ ë¦¬}}</code>, <code>{{ì¹´ë©”ë¼}}</code>, <code>{{ë ˆì¸ì„¼ì„œ}}</code>
    </div>
    <textarea id="installerTemplate" placeholder="ì‹œê³µì  ë©”ì‹œì§€ í…œí”Œë¦¿ì„ ì…ë ¥í•˜ì„¸ìš”.&#10;ì˜ˆ: [ì‘ì—…ì§€ì‹œ]&#10;ì°¨ëŸ‰: {{ì°¨ëª…}}&#10;..."></textarea>
  </div>

  <div class="button-group">
    <button class="btn-primary" onclick="saveTemplates()">
      <span>ğŸ’¾</span>
      <span>í…œí”Œë¦¿ ì €ì¥í•˜ê¸°</span>
    </button>
    <button class="btn-secondary" onclick="loadTemplates()">
      <span>ğŸ“¥</span>
      <span>í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸°</span>
    </button>
  </div>
</div>

<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Supabase ì´ˆê¸°í™” -->
<script src="/js/supabaseclient.js"></script>

<script>
// í…œí”Œë¦¿ íƒ€ì… ìƒìˆ˜ ì •ì˜ (DBì— ì €ì¥ëœ ì‹¤ì œ ê°’ ê¸°ì¤€)
const TEMPLATE_TYPE = {
  ISSUER: 'ë°œì£¼ì²˜',    // ë°œì£¼ì²˜ í…œí”Œë¦¿
  WORKSHOP: 'ì‹œê³µì '   // ì‹œê³µì  í…œí”Œë¦¿
};

// Error handling helper
function checkError(error) {
  if (error) {
    console.error("Supabase error:", error);
    alert("ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    throw error;
  }
}

async function saveTemplates() {
  const vendorTemplate = document.getElementById("vendorTemplate").value.trim();
  const installerTemplate = document.getElementById("installerTemplate").value.trim();

  if (!vendorTemplate || !installerTemplate) {
    alert("ë°œì£¼ì²˜ ë° ì‹œê³µì  í…œí”Œë¦¿ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }

  if (!window.supabaseClient) {
    alert("Supabase client not available");
    return;
  }
  const client = window.supabaseClient;

  try {
    // ë°œì£¼ì²˜ í…œí”Œë¦¿ ì €ì¥ (type = 'ë°œì£¼ì²˜')
    // ê¸°ì¡´ í…œí”Œë¦¿ì€ overwrite (upsert ì‚¬ìš©)
    const { error: vendorError } = await client
      .from("message_templates")
      .upsert({
        type: TEMPLATE_TYPE.ISSUER,  // 'ë°œì£¼ì²˜'
        content: vendorTemplate,
        updated_at: new Date().toISOString()
      }, {
        onConflict: 'type'
      });

    checkError(vendorError);

    // ì‹œê³µì  í…œí”Œë¦¿ ì €ì¥ (type = 'ì‹œê³µì ')
    // ê¸°ì¡´ í…œí”Œë¦¿ì€ overwrite (upsert ì‚¬ìš©)
    const { error: installerError } = await client
      .from("message_templates")
      .upsert({
        type: TEMPLATE_TYPE.WORKSHOP,  // 'ì‹œê³µì '
        content: installerTemplate,
        updated_at: new Date().toISOString()
      }, {
        onConflict: 'type'
      });

    checkError(installerError);

    alert("âœ… í…œí”Œë¦¿ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
  } catch (error) {
    console.error("ì €ì¥ ì˜¤ë¥˜:", error);
    alert("âŒ í…œí”Œë¦¿ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
  }
}

async function loadTemplates() {
  if (!window.supabaseClient) {
    alert("Supabase client not available");
    return;
  }
  const client = window.supabaseClient;
  if (!client) {
    console.warn("Supabase client not available");
    return;
  }

  try {
    // ë°œì£¼ì²˜ í…œí”Œë¦¿ ë¡œë“œ (type = 'ë°œì£¼ì²˜')
    const { data: vendorData, error: vendorError } = await client
      .from("message_templates")
      .select("content")
      .eq("type", TEMPLATE_TYPE.ISSUER)  // 'ë°œì£¼ì²˜'
      .single();

    if (!vendorError && vendorData && vendorData.content) {
      document.getElementById("vendorTemplate").value = vendorData.content;
    }

    // ì‹œê³µì  í…œí”Œë¦¿ ë¡œë“œ (type = 'ì‹œê³µì ')
    const { data: installerData, error: installerError } = await client
      .from("message_templates")
      .select("content")
      .eq("type", TEMPLATE_TYPE.WORKSHOP)  // 'ì‹œê³µì '
      .single();

    if (!installerError && installerData && installerData.content) {
      document.getElementById("installerTemplate").value = installerData.content;
    }
  } catch (error) {
    console.log("í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error.message);
  }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸°
document.addEventListener('DOMContentLoaded', function() {
  loadTemplates();
});
</script>

</body>
</html>

