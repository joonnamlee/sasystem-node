<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>SA System ì‚¬ê³  ì ‘ìˆ˜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Kakao SDK -->
  <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.5.0/kakao.min.js"
          crossorigin="anonymous"></script>

  <!-- Supabase Bootstrap -->
  <script type="module" src="/js/accidentBootstrap.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; margin:0; }
    header { background:#111; color:#fff; padding:14px 20px; font-size:18px; font-weight:bold; }
    .container { max-width:1200px; margin:20px auto; background:#fff; padding:24px; border-radius:10px; }
    .form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:16px; }
    .form-field { display:flex; flex-direction:column; gap:6px; }
    input, textarea, select { padding:10px; border-radius:6px; border:1px solid #ccc; font-size:13px; }
    textarea { height:160px; resize:none; }
    .button-group { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-top:16px; }
    button { padding:12px; border-radius:8px; border:none; cursor:pointer; font-weight:600; }
    .btn-save { background:#2563eb; color:#fff; }
    .btn-vendor { background:#10b981; color:#fff; }
    .btn-installer { background:#f59e0b; color:#fff; }
    .status { margin-top:12px; font-weight:bold; }
    .readonly { background:#f3f4f6; cursor:not-allowed; }
    .status-badge { padding:6px 12px; border-radius:6px; font-weight:600; }
  </style>
</head>

<body>

<header>ğŸš— ì—ìŠ¤ì—ì´ì‹œìŠ¤í…œ ì‚¬ê³  ì ‘ìˆ˜ ì‹œìŠ¤í…œ</header>

<div class="container">

  <h2 id="pageTitle">ì‹ ê·œ ì‚¬ê³  ì ‘ìˆ˜</h2>

  <textarea id="kakaoRaw" placeholder="ì¹´ì¹´ì˜¤í†¡ ì‚¬ê³  ì ‘ìˆ˜ ë‚´ìš©ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”"></textarea>
  <button onclick="fillFromKakao()">ìë™ ì…ë ¥</button>

  <div id="statusSection" style="display:none; margin-top:20px;">
    <span id="currentStatusBadge" class="status-badge">-</span>
    <select id="statusSelect">
      <option value="RECEIVED">ì ‘ìˆ˜ë¨</option>
      <option value="ASSIGNED">ë°°ì •ë¨</option>
      <option value="IN_PROGRESS">ì§„í–‰ì¤‘</option>
      <option value="COMPLETED">ì™„ë£Œ</option>
      <option value="SETTLED">ì •ì‚°ì™„ë£Œ</option>
    </select>
    <button onclick="updateStatus()">ìƒíƒœ ì €ì¥</button>
  </div>

  <div class="form-grid">
    <div class="form-field"><label>ì ‘ìˆ˜ë²ˆí˜¸</label><input id="receiptNumber"></div>
    <div class="form-field"><label>ì‚¬ê³ ì¼ì‹œ</label><input id="accidentTime"></div>
    <div class="form-field"><label>ê³ ê°ëª…</label><input id="customerName"></div>
    <div class="form-field"><label>ì—°ë½ì²˜</label><input id="phone"></div>
    <div class="form-field"><label>ì°¨ëŸ‰ë²ˆí˜¸</label><input id="carNumber"></div>
    <div class="form-field"><label>VIN</label><input id="vin"></div>
    <div class="form-field"><label>ì°¨ëª…</label><input id="carModel"></div>
    <div class="form-field"><label>ë©´ì±…ê¸ˆ</label><input id="deductible"></div>
    <div class="form-field"><label>ë©´ì±…ê¸ˆ ë°©ì‹</label><input id="deductiblePayType"></div>
    <div class="form-field"><label>ë³´í—˜ì‚¬</label><input id="insurer"></div>
    <div class="form-field"><label>íŒŒì†ìœ í˜•</label><input id="damageType"></div>
    <div class="form-field">
      <label>ë‹´ë‹¹ì</label>
      <input id="manager" class="readonly" readonly>
      <input type="hidden" id="managerId">
    </div>
    <div class="form-field"><label>ì‚¬ê³ ìœ„ì¹˜</label><input id="accidentLocation"></div>
    <div class="form-field"><label>ë¹„ê³ </label><input id="memo"></div>
  </div>

  <div class="button-group">
    <button class="btn-save" onclick="saveAccident()">ì ‘ìˆ˜ ì €ì¥</button>
    <button class="btn-vendor" onclick="sendKakaoToVendor()">ë°œì£¼ì²˜ ì¹´í†¡</button>
    <button class="btn-installer" onclick="sendKakaoToInstaller()">ì‹œê³µì  ì¹´í†¡</button>
  </div>

  <div id="statusMsg" class="status"></div>
</div>

<script>
/* =========================
   ì „ì—­ ìƒíƒœ
========================= */
let currentMode = "new";
let sessionUser = null;

/* =========================
   Supabase ëŒ€ê¸°
========================= */
function waitForSupabase() {
  return new Promise(resolve => {
    if (window.supabaseClient) return resolve();
    window.addEventListener("supabaseReady", resolve, { once:true });
  });
}

/* =========================
   ì´ˆê¸°í™”
========================= */
document.addEventListener("DOMContentLoaded", async () => {
  await waitForSupabase();
  initMode();
});

/* =========================
   ì‹ ê·œ / ìƒì„¸ ë¶„ê¸°
========================= */
async function initMode() {
  const params = new URLSearchParams(location.search);
  const receipt = params.get("receipt_number");

  if (!receipt) return;

  currentMode = "existing";
  document.getElementById("pageTitle").innerText = "ì‚¬ê³  ì ‘ìˆ˜ ìƒì„¸";
  document.getElementById("receiptNumber").disabled = true;
  document.getElementById("receiptNumber").classList.add("readonly");
  document.getElementById("statusSection").style.display = "block";

  const { data } = await window.supabaseClient
    .from("accident_records")
    .select("*")
    .or(`case_no.eq.${receipt},receipt_number.eq.${receipt}`)
    .maybeSingle();

  if (!data) return;

  fillForm(data);
  loadStatus(data.case_no);
}

/* =========================
   í¼ ì±„ìš°ê¸°
========================= */
function fillForm(d) {
  receiptNumber.value = d.case_no;
  accidentTime.value = d.incident_date || "";
  customerName.value = d.customer_name || "";
  phone.value = d.phone || "";
  carNumber.value = d.car_number || "";
  vin.value = d.vin || "";
  carModel.value = d.car_model || "";
  deductible.value = d.deductible || "";
  deductiblePayType.value = d.deductible_type || "";
  insurer.value = d.insurer || "";
  damageType.value = d.damage_type || "";
  accidentLocation.value = d.accident_location || "";
  memo.value = d.memo || "";
}

/* =========================
   ì €ì¥
========================= */
async function saveAccident() {
  await waitForSupabase();

  const caseNo = receiptNumber.value.trim();
  if (!caseNo) return alert("ì ‘ìˆ˜ë²ˆí˜¸ í•„ìˆ˜");

  const payload = {
    case_no: caseNo,
    incident_date: accidentTime.value,
    customer_name: customerName.value,
    phone: phone.value,
    car_number: carNumber.value,
    vin: vin.value,
    car_model: carModel.value,
    deductible: deductible.value,
    deductible_type: deductiblePayType.value,
    insurer: insurer.value,
    damage_type: damageType.value,
    accident_location: accidentLocation.value,
    memo: memo.value,
    status: "RECEIVED"
  };

  // manager_idëŠ” sessionUser.id ì‚¬ìš© (postMessageë¡œ ë°›ì€ ê°’)
  if (sessionUser?.id) {
    payload.manager_id = sessionUser.id;
  }

  if (currentMode === "new") {
    await window.supabaseClient.from("accident_records").insert(payload);
    statusMsg.innerText = "âœ… ì‹ ê·œ ì ‘ìˆ˜ ì™„ë£Œ";
  } else {
    await window.supabaseClient.from("accident_records")
      .update(payload).eq("case_no", caseNo);
    statusMsg.innerText = "âœ… ìˆ˜ì • ì™„ë£Œ";
  }
}

/* =========================
   ìƒíƒœ
========================= */
async function loadStatus(caseNo) {
  const { data } = await window.supabaseClient
    .from("accident_records").select("status")
    .eq("case_no", caseNo).single();
  currentStatusBadge.innerText = data.status;
  statusSelect.value = data.status;
}

async function updateStatus() {
  const caseNo = receiptNumber.value;
  const newStatus = statusSelect.value;
  await window.supabaseClient
    .from("accident_records")
    .update({ status:newStatus })
    .eq("case_no", caseNo);
  loadStatus(caseNo);
}

/* =========================
   ì¹´ì¹´ì˜¤
========================= */
function sendKakaoToVendor() { alert("ë°œì£¼ì²˜ ì¹´í†¡"); }
function sendKakaoToInstaller() { alert("ì‹œê³µì  ì¹´í†¡"); }
function fillFromKakao() { alert("íŒŒì‹± ë¡œì§ ì—°ê²° ê°€ëŠ¥"); }
</script>

</body>
</html>
