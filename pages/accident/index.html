<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>SA System ì‚¬ê³  ì ‘ìˆ˜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- ì¹´ì¹´ì˜¤ SDK -->
  <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.5.0/kakao.min.js"></script>
  
  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Supabase ì´ˆê¸°í™” -->
  <script src="/js/supabaseclient.js"></script>
  <script src="/js/statusConfig.js"></script>
  <script src="/js/accidentapi.js" defer></script>
  <script>
    // ì„¸ì…˜ ì²´í¬ ë° API í•¨ìˆ˜ ì´ˆê¸°í™”
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        // supabaseClient ì´ˆê¸°í™” ëŒ€ê¸° (supabaseclient.jsì—ì„œ ì´ˆê¸°í™”ë¨)
        let retryCount = 0;
        while (!window.supabaseClient && retryCount < 10) {
          await new Promise(resolve => setTimeout(resolve, 100));
          retryCount++;
        }
        
        if (!window.supabaseClient) {
          console.error("âŒ Supabase clientê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
          alert("Supabase ì´ˆê¸°í™” ì‹¤íŒ¨. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
          return;
        }
        
        const supabase = window.supabaseClient;
        
        // ì„¸ì…˜ ì²´í¬
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
          location.href = "/login.html";
          return;
        }

        // ì „ì—­ ë³€ìˆ˜ë¡œ ì„¤ì • (ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤)
        window.supabase = supabase;
        
        // API í•¨ìˆ˜ë“¤ì€ ì´ë¯¸ accidentApi.jsì—ì„œ ì „ì—­ìœ¼ë¡œ ì„¤ì •ë¨
        // API í•¨ìˆ˜ ë¡œë“œ í™•ì¸
        if (!window.API && !window.saveAccidentRecord) {
          console.error("âŒ API í•¨ìˆ˜ë“¤ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. accidentApi.js íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.");
        }
        
        // ì´ˆê¸°í™” ì™„ë£Œ ì‹ í˜¸
        window.supabaseReady = true;
        window.dispatchEvent(new CustomEvent('supabaseReady'));
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë©”ì‹œì§€ ìƒì„± ë²„íŠ¼ ì´ˆê¸° ìƒíƒœ ì„¤ì •
        // ì ‘ìˆ˜ ì €ì¥ ì „ì—ëŠ” ë©”ì‹œì§€ ìƒì„± ë²„íŠ¼ ë¹„í™œì„±í™”
        const messageButton = document.querySelector('.btn-kakao-vendor');
        if (messageButton) {
          // sessionStorageì— accidentIdê°€ ìˆìœ¼ë©´ í™œì„±í™”
          const savedAccidentId = sessionStorage.getItem('currentAccidentId');
          if (savedAccidentId) {
            messageButton.disabled = false;
            window.currentRecordId = savedAccidentId;
          } else {
            messageButton.disabled = true;
          }
        }
        
        // ì´ˆê¸°í™” ì™„ë£Œ ë¡œê·¸
        console.log("âœ… Supabase ì´ˆê¸°í™” ì™„ë£Œ");
        console.log("âœ… Supabase client:", window.supabaseClient);
        console.log("âœ… API ê°ì²´:", window.API);
        console.log("âœ… API functions loaded:", {
          API_saveAccident: typeof window.API?.saveAccident,
          saveAccidentRecord: typeof window.saveAccidentRecord,
          fetchAccidentRecords: typeof window.fetchAccidentRecords
        });
      } catch (error) {
        console.error("âŒ Supabase ì´ˆê¸°í™” ì‹¤íŒ¨:", error);
        alert("Supabase ì´ˆê¸°í™” ì‹¤íŒ¨: " + error.message + "\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
      }
    });

    // Kakao ì´ˆê¸°í™”
    document.addEventListener("DOMContentLoaded", () => {
        if (window.Kakao && !Kakao.isInitialized()) {
            Kakao.init("7984dc779fbf2deb1028140bb5cff0f9");
            console.log("Kakao initialized:", Kakao.isInitialized());
        }
    });
  </script>
  
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 0;
    }

    header {
      background: #111;
      color: white;
      padding: 14px 20px;
      font-size: 18px;
      font-weight: bold;
    }

    .container {
      max-width: 1200px;
      margin: 20px auto;
      background: white;
      padding: 24px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.08);
    }

    h2 {
      margin-top: 0;
      margin-bottom: 16px;
    }

    textarea {
      width: 100%;
      height: 180px;
      padding: 12px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 6px;
      resize: none;
    }

    button {
      margin-top: 10px;
      padding: 10px 18px;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      background: #2563eb;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background: #1d4ed8;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-grid label {
      font-size: 13px;
      font-weight: 500;
      color: #374151;
      text-align: left;
    }

    .form-grid input {
      padding: 10px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #ccc;
      width: 100%;
      box-sizing: border-box;
    }

    .form-grid input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-grid select {
      padding: 10px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #ccc;
      width: 100%;
      box-sizing: border-box;
      background-color: white;
      cursor: pointer;
    }

    .form-grid select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .status {
      margin-top: 12px;
      font-weight: bold;
      color: green;
    }

    /* í•„ë“œ ìë™ ì¸ì‹ ìƒíƒœ í‘œì‹œ */
    .field-auto-filled {
      background-color: #d1fae5 !important; /* ì—°ë‘ìƒ‰ */
      border-color: #10b981 !important;
    }

    .field-manual {
      background-color: white !important;
      border-color: #ccc !important;
    }

    .button-group {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 16px;
    }

    @media (min-width: 768px) {
      .button-group {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    .button-group button {
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 500;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: Arial, sans-serif;
    }

    .button-group button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .btn-save {
      background: #2563eb;
      color: white;
    }

    .btn-save:hover {
      background: #1d4ed8;
    }

    .btn-kakao-vendor {
      background: #10b981;
      color: white;
    }

    .btn-kakao-vendor:hover {
      background: #059669;
    }

    .btn-kakao-installer {
      background: #f59e0b;
      color: white;
    }

    .btn-kakao-installer:hover {
      background: #d97706;
    }

    .btn-delete {
      background: #ef4444;
      color: white;
    }

    .btn-delete:hover {
      background: #dc2626;
    }

    /* ìƒíƒœ ë±ƒì§€ ìŠ¤íƒ€ì¼ */
    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
    }

    .status-received {
      background: #e5e7eb;
      color: #374151;
    }

    .status-assigned {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-scheduled {
      background: #e9d5ff;
      color: #6b21a8;
    }

    .status-completed {
      background: #d1fae5;
      color: #065f46;
    }

    .status-pending {
      background: #fed7aa;
      color: #9a3412;
    }

    .status-settled {
      background: #10b981;
      color: white;
    }

    .status-closed {
      background: #4b5563;
      color: white;
    }
  </style>
</head>

<body>

<header>ğŸš— ì—ìŠ¤ì—ì´ì‹œìŠ¤í…œ ì‚¬ê³  ì ‘ìˆ˜ ì‹œìŠ¤í…œ</header>

<div class="container">

  <h2>ì¹´ì¹´ì˜¤í†¡ ì‚¬ê³  ì ‘ìˆ˜ ë‚´ìš© ì…ë ¥</h2>
  <textarea id="kakaoRaw" placeholder="ì¹´ì¹´ì˜¤í†¡ ë©”ì‹œì§€ë¥¼ ë³µì‚¬í•˜ì—¬ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”"></textarea>
  <div style="display: flex; gap: 8px; margin-top: 8px;">
    <button onclick="fillFromKakao()" style="padding: 10px 20px; font-size: 14px; font-weight: 500; border: none; border-radius: 8px; cursor: pointer; background: #10b981; color: white; transition: all 0.2s;">ìë™ ì…ë ¥</button>
    <button onclick="openWorkshopMap()" style="padding: 10px 20px; font-size: 14px; font-weight: 500; border: none; border-radius: 8px; cursor: pointer; background: #2563eb; color: white; transition: all 0.2s;">ì‹œê³µì  ì°¾ê¸°</button>
  </div>

  <h2 style="margin-top:30px;">ì‹ ê·œ ì‚¬ê³  ì ‘ìˆ˜</h2>

  <div class="form-grid">
    <div class="form-field">
      <label for="receiptNumber">ì ‘ìˆ˜ë²ˆí˜¸</label>
      <input id="receiptNumber" placeholder="ì ‘ìˆ˜ë²ˆí˜¸" />
    </div>
    
    <div class="form-field">
      <label for="accidentTime">ì‚¬ê³ ì¼ì‹œ</label>
      <input id="accidentTime" placeholder="ì‚¬ê³ ì¼ì‹œ" />
    </div>
    
    <div class="form-field">
      <label for="customerName">ê³ ê°ëª…</label>
      <input id="customerName" placeholder="ê³ ê°ëª…" />
    </div>
    
    <div class="form-field">
      <label for="phone">ì—°ë½ì²˜</label>
      <input id="phone" placeholder="ì—°ë½ì²˜" />
    </div>
    
    <div class="form-field">
      <label for="carNumber">ì°¨ëŸ‰ë²ˆí˜¸</label>
      <input id="carNumber" placeholder="ì°¨ëŸ‰ë²ˆí˜¸" />
    </div>
    
    <div class="form-field">
      <label for="vin">VIN</label>
      <input id="vin" placeholder="ì°¨ëŒ€ë²ˆí˜¸" />
    </div>
    
    <div class="form-field">
      <label for="carModel">ì°¨ëª…</label>
      <input id="carModel" placeholder="ì°¨ëª…" />
    </div>
    
    <div class="form-field">
      <label for="deductible">ë©´ì±…ê¸ˆ</label>
      <input id="deductible" placeholder="ë©´ì±…ê¸ˆ" />
    </div>
    
    <div class="form-field">
      <label for="deductiblePayType">ë©´ì±…ê¸ˆ ë‚©ë¶€ë°©ì‹</label>
      <input id="deductiblePayType" placeholder="ì„ ë‚© / í›„ë‚©" />
    </div>
    
    <div class="form-field">
      <label for="insurer">ë³´í—˜ì‚¬</label>
      <input id="insurer" placeholder="ë³´í—˜ì‚¬" />
    </div>
    
    <div class="form-field">
      <label for="damageType">íŒŒì†ìœ í˜•</label>
      <input id="damageType" placeholder="íŒŒì†ìœ í˜•" />
    </div>
    
    <div class="form-field">
      <label for="manager">ë‹´ë‹¹ì</label>
      <input id="manager" placeholder="ë‹´ë‹¹ì" />
    </div>
    
    <div class="form-field">
      <label for="accidentLocation">ì‚¬ê³ ìœ„ì¹˜</label>
      <input id="accidentLocation" placeholder="ì‚¬ê³ ìœ„ì¹˜" />
    </div>
    
    <div class="form-field">
      <label for="memo">ë¹„ê³ </label>
      <input id="memo" placeholder="ì ‘ìˆ˜ ë©”ëª¨" />
    </div>
    
    <!-- ìƒíƒœ ê´€ë¦¬ í•„ë“œ -->
    <div class="form-field" id="statusFieldContainer" style="display: none;">
      <label for="accidentStatus">ìƒíƒœ</label>
      <select id="accidentStatus" style="padding: 10px; font-size: 13px; border-radius: 6px; border: 1px solid #ccc; width: 100%; box-sizing: border-box;">
        <option value="ì ‘ìˆ˜ì™„ë£Œ">ì ‘ìˆ˜ì™„ë£Œ</option>
        <option value="ë°°ì •ì™„ë£Œ">ë°°ì •ì™„ë£Œ</option>
        <option value="ì‹œê³µì˜ˆì •">ì‹œê³µì˜ˆì •</option>
        <option value="ì‹œê³µì™„ë£Œ">ì‹œê³µì™„ë£Œ</option>
        <option value="ì •ì‚°ëŒ€ê¸°">ì •ì‚°ëŒ€ê¸°</option>
        <option value="ì •ì‚°ì™„ë£Œ">ì •ì‚°ì™„ë£Œ</option>
        <option value="ì¢…ë£Œ">ì¢…ë£Œ</option>
      </select>
      <div id="statusBadge" style="margin-top: 8px;"></div>
    </div>
    
    <!-- ë°°ì • ì‹œê³µì  í•„ë“œ -->
    <div class="form-field" style="grid-column: 1 / -1; border-top: 2px solid #e5e7eb; padding-top: 16px; margin-top: 8px;">
      <label style="font-weight: 600; color: #2563eb;">ğŸ”§ ë°°ì • ì‹œê³µì  ì •ë³´</label>
    </div>
    
    <div class="form-field">
      <label for="assignedWorkshopName">ë°°ì • ì‹œê³µì ëª…</label>
      <input id="assignedWorkshopName" placeholder="ë°°ì • ì‹œê³µì ëª…" readonly style="background-color: #f3f4f6;" />
    </div>
    
    <div class="form-field">
      <label for="assignedWorkshopAddress">ë°°ì • ì‹œê³µì  ì£¼ì†Œ</label>
      <input id="assignedWorkshopAddress" placeholder="ë°°ì • ì‹œê³µì  ì£¼ì†Œ" readonly style="background-color: #f3f4f6;" />
    </div>
    
    <div class="form-field">
      <label for="assignedWorkshopPhone">ë°°ì • ì‹œê³µì  ì „í™”ë²ˆí˜¸</label>
      <input id="assignedWorkshopPhone" placeholder="ë°°ì • ì‹œê³µì  ì „í™”ë²ˆí˜¸" readonly style="background-color: #f3f4f6;" />
    </div>
  </div>

  <div class="button-group" style="margin-top:16px;">
    <button class="btn-save" onclick="saveAccident()">ğŸ“ ì ‘ìˆ˜ ì €ì¥</button>
    <button class="btn-kakao-vendor" onclick="openMessagePage()">ğŸ’¬ ë©”ì‹œì§€ ìƒì„±</button>
    <button class="btn-delete" onclick="deleteCurrentRecord()" id="deleteBtn" style="display: none;">ğŸ—‘ï¸ ì ‘ìˆ˜ ì‚­ì œ</button>
  </div>

  <div class="status" id="statusMsg"></div>

  <!-- ìƒíƒœ ë³€ê²½ ì´ë ¥ ì„¹ì…˜ -->
  <div id="statusHistorySection" style="display: none; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: #374151;">ğŸ“‹ ìƒíƒœ ë³€ê²½ ì´ë ¥</h3>
    <div id="statusHistoryContainer" style="max-height: 300px; overflow-y: auto; padding: 12px; background: #f9fafb; border-radius: 8px;">
      <p style="color: #9ca3af; font-size: 14px;">ë¡œë”© ì¤‘...</p>
    </div>
  </div>

</div>

<script>
// ì „ì—­ ë³€ìˆ˜: ë‹´ë‹¹ì ID ì €ì¥
let managerId = null;

// Wait for Supabase to be ready
function waitForSupabase() {
  return new Promise((resolve, reject) => {
    // Check if both client and API functions are ready
    if (window.supabaseClient && (window.API?.saveAccident || window.saveAccidentRecord)) {
      resolve();
      return;
    }
    
    // Listen for supabaseReady event
    window.addEventListener('supabaseReady', () => {
      // Double-check API functions are available
      if (window.API?.saveAccident || window.saveAccidentRecord) {
        resolve();
      } else {
        console.warn('Supabase ready but API functions not available');
        // Still resolve to allow fallback error handling
        resolve();
      }
    }, { once: true });
    
    // Fallback timeout
    setTimeout(() => {
      if (window.supabaseClient && (window.API?.saveAccident || window.saveAccidentRecord)) {
        resolve();
      } else {
        console.warn('Supabase client or API functions not ready after timeout');
        // Still resolve to allow fallback error handling
        resolve();
      }
    }, 3000); // Increased timeout to 3 seconds
  });
}

// í¼ ë°ì´í„°ë¥¼ localStorageì— ì €ì¥
function saveFormToLocalStorage() {
  try {
    const formData = {
      receiptNumber: document.getElementById("receiptNumber")?.value || '',
      accidentTime: document.getElementById("accidentTime")?.value || '',
      customerName: document.getElementById("customerName")?.value || '',
      phone: document.getElementById("phone")?.value || '',
      carNumber: document.getElementById("carNumber")?.value || '',
      vin: document.getElementById("vin")?.value || '',
      carModel: document.getElementById("carModel")?.value || '',
      deductible: document.getElementById("deductible")?.value || '',
      deductiblePayType: document.getElementById("deductiblePayType")?.value || '',
      insurer: document.getElementById("insurer")?.value || '',
      damageType: document.getElementById("damageType")?.value || '',
      manager: document.getElementById("manager")?.value || '',
      accidentLocation: document.getElementById("accidentLocation")?.value || '',
      memo: document.getElementById("memo")?.value || '',
      assignedWorkshopName: document.getElementById("assignedWorkshopName")?.value || '',
      assignedWorkshopAddress: document.getElementById("assignedWorkshopAddress")?.value || '',
      assignedWorkshopPhone: document.getElementById("assignedWorkshopPhone")?.value || ''
    };
    localStorage.setItem('accidentForm', JSON.stringify(formData));
  } catch (e) {
    console.warn("Failed to save form to localStorage:", e);
  }
}

// localStorageì—ì„œ í¼ ë°ì´í„° ë¡œë“œ
function loadFormFromLocalStorage() {
  try {
    const savedData = localStorage.getItem('accidentForm');
    if (!savedData) return false;
    
    const formData = JSON.parse(savedData);
    
    // ëª¨ë“  í•„ë“œ ë³µì›
    if (formData.receiptNumber !== undefined) document.getElementById("receiptNumber").value = formData.receiptNumber || '';
    if (formData.accidentTime !== undefined) document.getElementById("accidentTime").value = formData.accidentTime || '';
    if (formData.customerName !== undefined) document.getElementById("customerName").value = formData.customerName || '';
    if (formData.phone !== undefined) document.getElementById("phone").value = formData.phone || '';
    if (formData.carNumber !== undefined) document.getElementById("carNumber").value = formData.carNumber || '';
    if (formData.vin !== undefined) document.getElementById("vin").value = formData.vin || '';
    if (formData.carModel !== undefined) document.getElementById("carModel").value = formData.carModel || '';
    if (formData.deductible !== undefined) document.getElementById("deductible").value = formData.deductible || '';
    if (formData.deductiblePayType !== undefined) document.getElementById("deductiblePayType").value = formData.deductiblePayType || '';
    if (formData.insurer !== undefined) document.getElementById("insurer").value = formData.insurer || '';
    if (formData.damageType !== undefined) document.getElementById("damageType").value = formData.damageType || '';
    if (formData.manager !== undefined) document.getElementById("manager").value = formData.manager || '';
    if (formData.accidentLocation !== undefined) document.getElementById("accidentLocation").value = formData.accidentLocation || '';
    if (formData.memo !== undefined) document.getElementById("memo").value = formData.memo || '';
    if (formData.assignedWorkshopName !== undefined) document.getElementById("assignedWorkshopName").value = formData.assignedWorkshopName || '';
    if (formData.assignedWorkshopAddress !== undefined) document.getElementById("assignedWorkshopAddress").value = formData.assignedWorkshopAddress || '';
    if (formData.assignedWorkshopPhone !== undefined) document.getElementById("assignedWorkshopPhone").value = formData.assignedWorkshopPhone || '';
    
    return true;
  } catch (e) {
    console.warn("Failed to load form from localStorage:", e);
    return false;
  }
}

// localStorageì—ì„œ í¼ ë°ì´í„° ì‚­ì œ
function clearFormFromLocalStorage() {
  try {
    localStorage.removeItem('accidentForm');
  } catch (e) {
    console.warn("Failed to clear form from localStorage:", e);
  }
}

// ëª¨ë“  ì…ë ¥ í•„ë“œì— ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
function setupFormAutoSave() {
  const fieldIds = [
    'receiptNumber', 'accidentTime', 'customerName', 'phone', 'carNumber', 'vin',
    'carModel', 'deductible', 'deductiblePayType', 'insurer', 'damageType',
    'manager', 'accidentLocation', 'memo',
    'assignedWorkshopName', 'assignedWorkshopAddress', 'assignedWorkshopPhone'
  ];
  
  fieldIds.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.addEventListener('input', saveFormToLocalStorage);
      element.addEventListener('change', saveFormToLocalStorage);
    }
  });
}

// URLì—ì„œ receipt_number íŒŒë¼ë¯¸í„° ì¶”ì¶œ
function getReceiptNumberFromURL() {
  const params = new URLSearchParams(window.location.search);
  return params.get('receipt_number');
}

// í¼ í•„ë“œ ì±„ìš°ê¸° í•¨ìˆ˜
function fillAccidentForm(data) {
  if (!data) return;
  
  // ì ‘ìˆ˜ë²ˆí˜¸
  const caseNo = data.case_no || data.receipt_number;
  if (caseNo) {
    const receiptNumberEl = document.getElementById("receiptNumber");
    if (receiptNumberEl) receiptNumberEl.value = caseNo;
  }
  
  // ì‚¬ê³ ì¼ì‹œ: ISO í˜•ì‹ì„ ë¡œì»¬ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
  const incidentDate = data.incident_date || data.accident_time;
  if (incidentDate) {
    try {
      const date = new Date(incidentDate);
      if (!isNaN(date.getTime())) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const accidentTimeEl = document.getElementById("accidentTime");
        if (accidentTimeEl) accidentTimeEl.value = `${year}-${month}-${day} ${hours}:${minutes}`;
      } else {
        const accidentTimeEl = document.getElementById("accidentTime");
        if (accidentTimeEl) accidentTimeEl.value = incidentDate;
      }
    } catch (e) {
      console.warn("ë‚ ì§œ ë³€í™˜ ì˜¤ë¥˜:", e);
      const accidentTimeEl = document.getElementById("accidentTime");
      if (accidentTimeEl) accidentTimeEl.value = incidentDate;
    }
  }
  
  // ë‚˜ë¨¸ì§€ í•„ë“œë“¤
  if (data.customer_name) {
    const el = document.getElementById("customerName");
    if (el) el.value = data.customer_name;
  }
  if (data.phone) {
    const el = document.getElementById("phone");
    if (el) el.value = data.phone;
  }
  const carNo = data.car_no || data.car_number;
  if (carNo) {
    const el = document.getElementById("carNumber");
    if (el) el.value = carNo;
  }
  if (data.vin) {
    const el = document.getElementById("vin");
    if (el) el.value = data.vin;
  }
  const carModel = data.car_model || data.vehicle_model;
  if (carModel) {
    const el = document.getElementById("carModel");
    if (el) el.value = carModel;
  }
  const damageType = data.damage_type || data.damage_location;
  if (damageType) {
    const el = document.getElementById("damageType");
    if (el) el.value = damageType;
  }
  const insurance = data.insurance || data.insurer;
  if (insurance) {
    const el = document.getElementById("insurer");
    if (el) el.value = insurance;
  }
  if (data.accident_location) {
    const el = document.getElementById("accidentLocation");
    if (el) el.value = data.accident_location;
  }
  const manager = data.manager || data.branch;
  if (manager) {
    const el = document.getElementById("manager");
    if (el) el.value = manager;
  }
  // manager_id ë¡œë“œ (ë³€ê²½ ì´ë ¥ ë¡œê·¸ìš©)
  if (data.manager_id && typeof managerId !== 'undefined') {
    managerId = data.manager_id;
  }
        // ìƒíƒœ í•„ë“œ í‘œì‹œ ë° ê°’ ì„¤ì •
  const statusFieldContainer = document.getElementById("statusFieldContainer");
  if (statusFieldContainer) {
    statusFieldContainer.style.display = "block";
  }
  
  // ìƒíƒœ ë³€ê²½ ì´ë ¥ ì„¹ì…˜ í‘œì‹œ
  const statusHistorySection = document.getElementById("statusHistorySection");
  if (statusHistorySection) {
    statusHistorySection.style.display = "block";
  }
  
  // ìƒíƒœ ìë™ ì„¸íŒ… í•¨ìˆ˜
  function setStatusSelect(status) {
    const select = document.getElementById("accidentStatus");
    if (!select || !status) return;
    select.value = status;
    if (typeof currentStatus !== 'undefined') {
      currentStatus = status;
    }
  }
  
  if (data.status) {
    setStatusSelect(data.status);
  } else {
    setStatusSelect("ì ‘ìˆ˜ì™„ë£Œ");
  }
  
  // ìƒíƒœ ë±ƒì§€ ì—…ë°ì´íŠ¸
  updateStatusBadge(data.status || "ì ‘ìˆ˜ì™„ë£Œ");
  
  // ìƒíƒœ ì˜µì…˜ ì—…ë°ì´íŠ¸
  updateStatusOptions(data.status || "ì ‘ìˆ˜ì™„ë£Œ");
  
  // ìƒíƒœ ë³€ê²½ ì´ë ¥ ë¡œë“œ
  if (caseNo) {
    loadStatusHistory(caseNo);
  }
  if (data.deductible) {
    const el = document.getElementById("deductible");
    if (el) el.value = data.deductible;
  }
  const deductibleType = data.deductible_type || data.deductible_pay_type;
  if (deductibleType) {
    const el = document.getElementById("deductiblePayType");
    if (el) el.value = deductibleType;
  }
  const memo = data.memo || data.request_detail;
  if (memo) {
    const el = document.getElementById("memo");
    if (el) el.value = memo;
  }
  
  // ë°°ì • ì‹œê³µì  ì •ë³´
  if (data.assigned_workshop_name) {
    const el = document.getElementById("assignedWorkshopName");
    if (el) el.value = data.assigned_workshop_name;
  }
  if (data.assigned_workshop_address) {
    const el = document.getElementById("assignedWorkshopAddress");
    if (el) el.value = data.assigned_workshop_address;
  }
  if (data.assigned_workshop_phone) {
    const el = document.getElementById("assignedWorkshopPhone");
    if (el) el.value = data.assigned_workshop_phone;
  }
}

// URL íŒŒë¼ë¯¸í„°ì—ì„œ edit/id/receipt_number ëª¨ë“œ í™•ì¸
document.addEventListener('DOMContentLoaded', async function() {
  await waitForSupabase();
  const urlParams = new URLSearchParams(window.location.search);
  const editReceiptNumber = urlParams.get('edit') || urlParams.get('id') || getReceiptNumberFromURL();
  
  // receipt_number íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ ì²˜ë¦¬
  const receiptNumber = getReceiptNumberFromURL();
  if (receiptNumber) {
    console.log('[receipt_number ê°ì§€]', receiptNumber);
    
    if (!window.supabaseClient) {
      console.error("Supabase client not available");
      alert("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
      return;
    }

    try {
      const data = await window.loadAccidentByReceiptNumber(receiptNumber);
      
      if (data) {
        fillAccidentForm(data);
        
        // ë ˆì½”ë“œ ID ì €ì¥ (ì‚­ì œ ê¸°ëŠ¥ìš© ë° ë©”ì‹œì§€ ìƒì„±ìš©)
        if (data.id) {
          window.currentRecordId = data.id;
          // sessionStorageì—ë„ ì €ì¥
          sessionStorage.setItem('currentAccidentId', data.id);
          // ë©”ì‹œì§€ ìƒì„± ë²„íŠ¼ í™œì„±í™”
          const messageButton = document.querySelector('.btn-kakao-vendor');
          if (messageButton) {
            messageButton.disabled = false;
          }
        }
        
        // ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
        const deleteBtn = document.getElementById("deleteBtn");
        if (deleteBtn) {
          deleteBtn.style.display = "block";
        }
        
        // ìˆ˜ì • ëª¨ë“œ í”Œë˜ê·¸ ì„¤ì •
        window.__ACCIDENT_EDIT_MODE__ = true;
        
        // ì €ì¥ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
        const saveBtn = document.querySelector('.btn-save');
        if (saveBtn) {
          saveBtn.textContent = 'ğŸ“ ì ‘ìˆ˜ ìˆ˜ì •';
        }
        
        const caseNo = data.case_no || data.receipt_number;
        const statusMsg = document.getElementById("statusMsg");
        if (statusMsg) {
          statusMsg.innerText = "ğŸ“ í¸ì§‘ ëª¨ë“œ: ì ‘ìˆ˜ë²ˆí˜¸ " + caseNo;
          statusMsg.style.color = "#2563eb";
        }
        
        console.log('ìˆ˜ì • ëª¨ë“œë¡œ ì „í™˜ë¨');
        return; // receipt_number ì²˜ë¦¬ ì™„ë£Œ, ê¸°ì¡´ ë¡œì§ ìŠ¤í‚µ
      } else {
        console.warn("ë ˆì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", receiptNumber);
      }
    } catch (e) {
      console.error("ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", e);
      alert("ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + (e.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
    }
  }

  // í¸ì§‘ ëª¨ë“œì¼ ê²½ìš° ë°ì´í„° ë¡œë“œ (í¸ì§‘ ëª¨ë“œì—ì„œëŠ” localStorage ë¬´ì‹œ)
  // receipt_numberê°€ ì´ë¯¸ ì²˜ë¦¬ë˜ì—ˆìœ¼ë©´ ìŠ¤í‚µ
  if (editReceiptNumber && !receiptNumber) {
    if (!window.supabaseClient) {
      console.error("Supabase client not available");
      alert("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
      return;
    }

    try {
      const record = await window.loadAccidentByReceiptNumber(editReceiptNumber);
      
      if (!record) {
        console.warn("ë ˆì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", editReceiptNumber);
        return;
      }

      if (record) {
        console.log("Loading record:", record);
        
        // ë ˆì½”ë“œ ID ì €ì¥ (ì‚­ì œ ê¸°ëŠ¥ìš© ë° ë©”ì‹œì§€ ìƒì„±ìš©)
        window.currentRecordId = record.id;
        // sessionStorageì—ë„ ì €ì¥
        sessionStorage.setItem('currentAccidentId', record.id);
        // ë©”ì‹œì§€ ìƒì„± ë²„íŠ¼ í™œì„±í™”
        const messageButton = document.querySelector('.btn-kakao-vendor');
        if (messageButton) {
          messageButton.disabled = false;
        }
        
        // ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
        const deleteBtn = document.getElementById("deleteBtn");
        if (deleteBtn) {
          deleteBtn.style.display = "block";
        }
        
        // í¼ í•„ë“œ ì±„ìš°ê¸° - fillAccidentForm í•¨ìˆ˜ ì‚¬ìš©
        fillAccidentForm(record);
        
        // ìˆ˜ì • ëª¨ë“œ í”Œë˜ê·¸ ì„¤ì •
        window.__ACCIDENT_EDIT_MODE__ = true;
        
        // ì €ì¥ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
        const saveBtn = document.querySelector('.btn-save');
        if (saveBtn) {
          saveBtn.textContent = 'ğŸ“ ì ‘ìˆ˜ ìˆ˜ì •';
        }
        
        const caseNo = record.case_no || record.receipt_number;
        const statusMsg = document.getElementById("statusMsg");
        if (statusMsg) {
          statusMsg.innerText = "ğŸ“ í¸ì§‘ ëª¨ë“œ: ì ‘ìˆ˜ë²ˆí˜¸ " + caseNo;
          statusMsg.style.color = "#2563eb";
        }
        
        console.log('ìˆ˜ì • ëª¨ë“œë¡œ ì „í™˜ë¨');
      }
    } catch (e) {
      console.error("ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", e);
      console.error("Error details:", JSON.stringify(e, null, 2));
      alert("ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + (e.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
    }
  } else if (!editReceiptNumber && !receiptNumber) {
    // í¸ì§‘ ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ localStorageì—ì„œ í¼ ë°ì´í„° ë¡œë“œ
    // (í¸ì§‘ ëª¨ë“œì—ì„œëŠ” DB ë°ì´í„°ê°€ ìš°ì„ )
    const loaded = loadFormFromLocalStorage();
    if (loaded) {
      console.log("Form data restored from localStorage");
    }
    
    // ìƒˆ ë ˆì½”ë“œ ìƒì„± ëª¨ë“œì´ë¯€ë¡œ ì‚­ì œ ë²„íŠ¼ ìˆ¨ê¹€
    const deleteBtn = document.getElementById("deleteBtn");
    if (deleteBtn) {
      deleteBtn.style.display = "none";
    }
    window.currentRecordId = null;
    // sessionStorageì—ì„œë„ ì œê±°
    sessionStorage.removeItem('currentAccidentId');
    // ë©”ì‹œì§€ ìƒì„± ë²„íŠ¼ ë¹„í™œì„±í™”
    const messageButton = document.querySelector('.btn-kakao-vendor');
    if (messageButton) {
      messageButton.disabled = true;
    }
    
    // ë‹´ë‹¹ì í•„ë“œ ìë™ ì…ë ¥ (í¸ì§‘ ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ)
    await loadManagerName();
    // ì‹ ê·œ ì ‘ìˆ˜ ëª¨ë“œì—ì„œëŠ” ìƒíƒœ í•„ë“œ ìˆ¨ê¹€
    const statusFieldContainer = document.getElementById("statusFieldContainer");
    if (statusFieldContainer) {
      statusFieldContainer.style.display = "none";
    }
    // ì‹ ê·œ ì ‘ìˆ˜ëŠ” ê¸°ë³¸ ìƒíƒœë¡œ ì„¤ì •
    currentStatus = "ì ‘ìˆ˜ì™„ë£Œ";
  }
  
  // ìƒíƒœ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
  const statusSelect = document.getElementById("accidentStatus");
  if (statusSelect) {
    statusSelect.addEventListener("change", handleStatusChange);
    // ì´ˆê¸° ìƒíƒœ ì˜µì…˜ ì—…ë°ì´íŠ¸
    if (currentStatus) {
      updateStatusOptions(currentStatus);
    }
  }
  
  // localStorageì—ì„œ ì„ íƒëœ ì‹œê³µì  ì •ë³´ ë¡œë“œ
  loadSelectedWorkshop();
  
  // ìë™ ì €ì¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
  setupFormAutoSave();
});

// ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ì´ë¦„ì„ ë‹´ë‹¹ì í•„ë“œì— ìë™ ì…ë ¥
async function loadManagerName() {
  if (!window.supabaseClient) {
    console.error('Supabase client not ready');
    alert('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  try {

    // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const { data: { user }, error: userError } = await window.supabaseClient.auth.getUser();
    
    if (userError) {
      console.warn("ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:", userError);
      return;
    }

    if (!user) {
      console.warn("ë¡œê·¸ì¸í•œ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    // public.users í…Œì´ë¸”ì—ì„œ ì‚¬ìš©ì ì´ë¦„ ì¡°íšŒ
    const { data, error } = await window.supabaseClient
      .from('users')
      .select('id, name')
      .eq('id', user.id)
      .single();

    if (error) {
      console.warn("ì‚¬ìš©ì ì´ë¦„ ì¡°íšŒ ì˜¤ë¥˜:", error);
      return;
    }

    if (data?.name) {
      const managerField = document.getElementById("manager");
      if (managerField) {
        managerField.value = data.name;
        // ë‚´ë¶€ ë³€ìˆ˜ë¡œ manager_id ì €ì¥
        managerId = data.id;
        console.log("ë‹´ë‹¹ì ìë™ ì…ë ¥ ì™„ë£Œ:", data.name, "manager_id:", managerId);
      }
    } else {
      console.warn('ë‹´ë‹¹ì ì´ë¦„ì´ ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ìš©ìì…ë‹ˆë‹¤');
    }
  } catch (error) {
    console.warn("ë‹´ë‹¹ì ìë™ ì…ë ¥ ì¤‘ ì˜¤ë¥˜:", error);
  }
}

// ìƒíƒœ ìˆœì„œ ì •ì˜
const STATUS_ORDER = ['ì ‘ìˆ˜ì™„ë£Œ', 'ë°°ì •ì™„ë£Œ', 'ì‹œê³µì˜ˆì •', 'ì‹œê³µì™„ë£Œ', 'ì •ì‚°ëŒ€ê¸°', 'ì •ì‚°ì™„ë£Œ', 'ì¢…ë£Œ'];

// ë‹¤ìŒ ìƒíƒœë¡œë§Œ ë³€ê²½ ê°€ëŠ¥í•œì§€ í™•ì¸
function canChangeToStatus(currentStatus, newStatus) {
  const currentIndex = STATUS_ORDER.indexOf(currentStatus);
  const newIndex = STATUS_ORDER.indexOf(newStatus);
  
  // í˜„ì¬ ìƒíƒœë‚˜ ìƒˆ ìƒíƒœê°€ ëª©ë¡ì— ì—†ìœ¼ë©´ false
  if (currentIndex === -1 || newIndex === -1) {
    return false;
  }
  
  // ë‹¤ìŒ ìƒíƒœë¡œë§Œ ë³€ê²½ ê°€ëŠ¥ (ê°™ì€ ìƒíƒœëŠ” í—ˆìš©í•˜ì§€ ì•ŠìŒ)
  return newIndex === currentIndex + 1;
}

// ìƒíƒœ ë³€ê²½ ê°€ëŠ¥í•œ ì˜µì…˜ë§Œ í‘œì‹œ
function updateStatusOptions(currentStatus) {
  const statusSelect = document.getElementById("accidentStatus");
  if (!statusSelect) return;
  
  const currentIndex = STATUS_ORDER.indexOf(currentStatus);
  if (currentIndex === -1) {
    // í˜„ì¬ ìƒíƒœê°€ ëª©ë¡ì— ì—†ìœ¼ë©´ ëª¨ë“  ì˜µì…˜ í‘œì‹œ
    return;
  }
  
  // í˜„ì¬ ìƒíƒœì™€ ë‹¤ìŒ ìƒíƒœë§Œ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡
  const options = statusSelect.options;
  for (let i = 0; i < options.length; i++) {
    const optionStatus = options[i].value;
    const optionIndex = STATUS_ORDER.indexOf(optionStatus);
    
    // í˜„ì¬ ìƒíƒœ ì´ì „ì˜ ìƒíƒœëŠ” ë¹„í™œì„±í™”
    if (optionIndex < currentIndex) {
      options[i].disabled = true;
    } else if (optionIndex === currentIndex || optionIndex === currentIndex + 1) {
      // í˜„ì¬ ìƒíƒœì™€ ë‹¤ìŒ ìƒíƒœë§Œ í™œì„±í™”
      options[i].disabled = false;
    } else {
      // ê·¸ ì´í›„ ìƒíƒœëŠ” ë¹„í™œì„±í™”
      options[i].disabled = true;
    }
  }
}

// ìƒíƒœë³„ ë±ƒì§€ í´ë˜ìŠ¤ ë°˜í™˜ (statusConfig.js ì‚¬ìš©)
function getStatusBadgeClass(status) {
  if (window.getStatusClass) {
    return window.getStatusClass(status);
  }
  // Fallback (statusConfig.jsê°€ ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš°)
  const statusMap = {
    'ì ‘ìˆ˜ì™„ë£Œ': 'status-received',
    'ë°°ì •ì™„ë£Œ': 'status-assigned',
    'ì‹œê³µì˜ˆì •': 'status-scheduled',
    'ì‹œê³µì™„ë£Œ': 'status-completed',
    'ì •ì‚°ëŒ€ê¸°': 'status-pending',
    'ì •ì‚°ì™„ë£Œ': 'status-settled',
    'ì¢…ë£Œ': 'status-closed'
  };
  return statusMap[status] || 'status-received';
}

// ìƒíƒœ ë±ƒì§€ ì—…ë°ì´íŠ¸ (statusConfig.js ì‚¬ìš©)
function updateStatusBadge(status) {
  const badgeEl = document.getElementById("statusBadge");
  if (!badgeEl) return;
  
  // statusConfig.jsì˜ renderStatusBadge ì‚¬ìš©
  if (window.renderStatusBadge) {
    const normalizedStatus = window.normalizeStatus ? window.normalizeStatus(status) : (status || 'ì ‘ìˆ˜ì™„ë£Œ');
    badgeEl.innerHTML = window.renderStatusBadge(normalizedStatus, false);
  } else {
    // Fallback
    const badgeClass = getStatusBadgeClass(status);
    const badgeText = status || 'ì ‘ìˆ˜ì™„ë£Œ';
    badgeEl.innerHTML = `<span class="status-badge ${badgeClass}">${badgeText}</span>`;
  }
}

// ìƒíƒœ ë³€ê²½ ì²˜ë¦¬ í•¨ìˆ˜
async function handleStatusChange() {
  if (!window.supabaseClient) {
    console.error('Supabase client not ready');
    alert('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  const newStatus = document.getElementById("accidentStatus").value;
  
  // ìƒíƒœê°€ ì‹¤ì œë¡œ ë³€ê²½ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì•„ë¬´ ì‘ì—…ë„ í•˜ì§€ ì•ŠìŒ
  if (currentStatus === newStatus) {
    return;
  }
  
  // ìƒíƒœ ë³€ê²½ ìˆœì„œ ê²€ì¦
  if (!canChangeToStatus(currentStatus, newStatus)) {
    alert(`ìƒíƒœëŠ” ìˆœì„œëŒ€ë¡œë§Œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\ní˜„ì¬ ìƒíƒœ: ${currentStatus}\në‹¤ìŒ ìƒíƒœ: ${STATUS_ORDER[STATUS_ORDER.indexOf(currentStatus) + 1] || 'ì—†ìŒ'}`);
    // ìƒíƒœë¥¼ ì›ë˜ëŒ€ë¡œ ë˜ëŒë¦¼
    document.getElementById("accidentStatus").value = currentStatus;
    return;
  }
  
  const oldStatus = currentStatus;
  const caseNo = document.getElementById("receiptNumber").value.trim();
  
  if (!caseNo) {
    console.warn("ì ‘ìˆ˜ë²ˆí˜¸ê°€ ì—†ì–´ ìƒíƒœ ë³€ê²½ ë¡œê·¸ë¥¼ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    currentStatus = newStatus;
    return;
  }
  
  try {
    await waitForSupabase();
    
    // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const { data: { user }, error: userError } = await window.supabaseClient.auth.getUser();
    if (userError || !user) {
      console.warn("ë¡œê·¸ì¸í•œ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    
    // status_priority ê³„ì‚° (statusConfig.jsì˜ ACCIDENT_STATUS_PRIORITY ì‚¬ìš©)
    const statusPriority = (window.ACCIDENT_STATUS_PRIORITY && window.ACCIDENT_STATUS_PRIORITY[newStatus]) || 5;
    
    // accident_records.status UPDATE (status_priorityë„ í•¨ê»˜ ì—…ë°ì´íŠ¸)
    const { error: updateError } = await window.supabaseClient
      .from('accident_records')
      .update({ 
        status: newStatus,
        status_priority: statusPriority
      })
      .eq('case_no', caseNo);
    
    if (updateError) {
      console.error("ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", updateError);
      // ìƒíƒœë¥¼ ì›ë˜ëŒ€ë¡œ ë˜ëŒë¦¼
      document.getElementById("accidentStatus").value = oldStatus;
      alert("ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: " + updateError.message);
      return;
    }
    
    // accident_status_logs í…Œì´ë¸”ì— ë³€ê²½ ë¡œê·¸ INSERT
    const { error: logError } = await window.supabaseClient
      .from('accident_status_logs')
      .insert({
        case_no: caseNo,
        before_status: oldStatus,
        after_status: newStatus,
        changed_by: user.id
      });
    
    if (logError) {
      console.warn("ìƒíƒœ ë³€ê²½ ì´ë ¥ ë¡œê·¸ ì €ì¥ ì‹¤íŒ¨:", logError);
      // ìƒíƒœ ì—…ë°ì´íŠ¸ëŠ” ì„±ê³µí–ˆìœ¼ë¯€ë¡œ ê²½ê³ ë§Œ ì¶œë ¥
    } else {
      console.log("ìƒíƒœ ë³€ê²½ ì™„ë£Œ:", oldStatus, "â†’", newStatus);
    }
    
    // í˜„ì¬ ìƒíƒœ ì—…ë°ì´íŠ¸
    currentStatus = newStatus;
    
    // ìƒíƒœ ë±ƒì§€ ì—…ë°ì´íŠ¸
    updateStatusBadge(newStatus);
    
    // ìƒíƒœ ì˜µì…˜ ì—…ë°ì´íŠ¸
    updateStatusOptions(newStatus);
    
    // ìƒíƒœ ë³€ê²½ ì´ë ¥ ë‹¤ì‹œ ë¡œë“œ
    loadStatusHistory(caseNo);
    
  } catch (error) {
    console.error("ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜:", error);
    // ìƒíƒœë¥¼ ì›ë˜ëŒ€ë¡œ ë˜ëŒë¦¼
    document.getElementById("accidentStatus").value = oldStatus;
    alert("ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + (error.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
  }
}

// ìƒíƒœ ë³€ê²½ ì´ë ¥ ë¡œë“œ
async function loadStatusHistory(caseNo) {
  if (!caseNo || !window.supabaseClient) return;
  
  try {
    // ë¨¼ì € ë¡œê·¸ ì¡°íšŒ
    const { data: logs, error } = await window.supabaseClient
      .from('accident_status_logs')
      .select('*')
      .eq('case_no', caseNo)
      .order('created_at', { ascending: false });
    
    if (error) {
      console.warn("ìƒíƒœ ë³€ê²½ ì´ë ¥ ë¡œë“œ ì‹¤íŒ¨:", error);
      return;
    }
    
    if (!logs || logs.length === 0) {
      renderStatusHistory([]);
      return;
    }
    
    // ì‚¬ìš©ì ì´ë¦„ ì¡°íšŒ
    const userIds = [...new Set(logs.map(log => log.changed_by).filter(Boolean))];
    const userMap = {};
    
    if (userIds.length > 0) {
      const { data: users, error: userError } = await window.supabaseClient
        .from('users')
        .select('id, name')
        .in('id', userIds);
      
      if (!userError && users) {
        users.forEach(user => {
          userMap[user.id] = user.name || 'ì•Œ ìˆ˜ ì—†ìŒ';
        });
      }
    }
    
    // ë¡œê·¸ì— ì‚¬ìš©ì ì´ë¦„ ì¶”ê°€
    const logsWithUsers = logs.map(log => ({
      ...log,
      changed_by_user: {
        name: userMap[log.changed_by] || 'ì•Œ ìˆ˜ ì—†ìŒ'
      }
    }));
    
    renderStatusHistory(logsWithUsers);
  } catch (error) {
    console.error("ìƒíƒœ ë³€ê²½ ì´ë ¥ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", error);
  }
}

// ìƒíƒœ ë³€ê²½ ì´ë ¥ ë Œë”ë§
function renderStatusHistory(logs) {
  const historyContainer = document.getElementById("statusHistoryContainer");
  if (!historyContainer) return;
  
  if (!logs || logs.length === 0) {
    historyContainer.innerHTML = '<p style="color: #9ca3af; font-size: 14px;">ìƒíƒœ ë³€ê²½ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }
  
  const historyHtml = logs.map(log => {
    const date = new Date(log.created_at);
    const dateStr = date.toLocaleString('ko-KR', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
    const userName = log.changed_by_user?.name || 'ì•Œ ìˆ˜ ì—†ìŒ';
    const beforeStatus = log.before_status || '(ì—†ìŒ)';
    const afterStatus = log.after_status || '(ì—†ìŒ)';
    
    return `
      <div style="padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
        <div style="font-size: 13px; color: #6b7280;">
          ${dateStr} | ${beforeStatus} â†’ ${afterStatus} | ${userName}
        </div>
      </div>
    `;
  }).join('');
  
  historyContainer.innerHTML = historyHtml;
}

// localStorageì—ì„œ ì„ íƒëœ ì‹œê³µì  ì •ë³´ ë¡œë“œ
function loadSelectedWorkshop() {
  try {
    const selectedWorkshop = localStorage.getItem('selectedWorkshop');
    if (selectedWorkshop) {
      const workshop = JSON.parse(selectedWorkshop);
      if (workshop) {
        document.getElementById("assignedWorkshopName").value = workshop.name || '';
        document.getElementById("assignedWorkshopAddress").value = workshop.address || '';
        document.getElementById("assignedWorkshopPhone").value = workshop.phone || '';
        
        // ì‚¬ê³ ìœ„ì¹˜ê°€ ë¹„ì–´ìˆìœ¼ë©´ ì‹œê³µì  ì£¼ì†Œë¡œ ìë™ ì…ë ¥
        const accidentLocation = document.getElementById("accidentLocation");
        if (!accidentLocation.value.trim() && workshop.address) {
          accidentLocation.value = workshop.address;
        }
        
        // localStorageì—ì„œ ì„ íƒëœ ì‹œê³µì  ì •ë³´ ì‚­ì œ
        localStorage.removeItem('selectedWorkshop');
        
        // ì‹œê³µì  ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìœ¼ë¯€ë¡œ í¼ ë°ì´í„° ì €ì¥
        saveFormToLocalStorage();
      }
    }
  } catch (e) {
    console.warn("Failed to load selected workshop:", e);
  }
}

// ì ‘ìˆ˜ ì‚­ì œ í•¨ìˆ˜ (ìƒì„¸/í¸ì§‘ í˜ì´ì§€ì—ì„œ)
async function deleteCurrentRecord() {
  if (!window.supabaseClient) {
    console.error('Supabase client not ready');
    alert('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  if (!window.currentRecordId) {
    alert("ì‚­ì œí•  ë ˆì½”ë“œ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  
  if (!window.confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì‚­ì œ í›„ ë³µêµ¬ ê°€ëŠ¥)")) {
    return;
  }
  
  try {
    await waitForSupabase();
    
    if (!window.deleteAccidentRecord) {
      throw new Error("ì‚­ì œ í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
    }
    
    await window.deleteAccidentRecord(window.currentRecordId);
    
    alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
    
    // localStorageì—ì„œë„ í¼ ë°ì´í„° ì‚­ì œ
    clearFormFromLocalStorage();
    
    // ì ‘ìˆ˜ í˜„í™© í˜ì´ì§€ë¡œ ì´ë™
    if (window.parent && window.parent !== window) {
      window.parent.postMessage({ type: 'openAccidentDetail', receiptNumber: '', useId: false }, '*');
      // ì ‘ìˆ˜ í˜„í™© í˜ì´ì§€ë¡œ ì´ë™
      setTimeout(() => {
        window.parent.postMessage({ type: 'navigate', page: 'status' }, '*');
      }, 100);
    } else {
      window.location.href = '/pages/status/index.html';
    }
    
  } catch (error) {
    console.error("ì‚­ì œ ì˜¤ë¥˜:", error);
    alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + (error.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
  }
}

// ì‹œê³µì  ì°¾ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ (ìë™ ì…ë ¥ ë²„íŠ¼ ì˜†)
function openWorkshopMap() {
  const accidentLocation = document.getElementById("accidentLocation").value.trim();
  
  // ì‚¬ê³ ìœ„ì¹˜ê°€ ì—†ìœ¼ë©´ alert í›„ ì¤‘ë‹¨
  if (!accidentLocation) {
    alert("ì‚¬ê³ ìœ„ì¹˜ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
    document.getElementById("accidentLocation").focus();
    return;
  }
  
  // accident_addressë¥¼ localStorageì— ë°±ì—…ìœ¼ë¡œ ì €ì¥
  localStorage.setItem("accident_address", accidentLocation);
  
  // encodeURIComponentë¡œ ì¸ì½”ë”©í•˜ì—¬ ì´ë™
  const encodedAddress = encodeURIComponent(accidentLocation);
  
  // ë¶€ëª¨ í”„ë ˆì„ì´ ìˆìœ¼ë©´ ë©”ì‹œì§€ ì „ì†¡, ì—†ìœ¼ë©´ ì§ì ‘ ì´ë™
  if (window.parent && window.parent !== window) {
    window.parent.postMessage({ type: 'openInstallerMap', address: accidentLocation }, '*');
  } else {
    window.location.href = '/pages/installer/embed.html?address=' + encodedAddress;
  }
}

/**
 * í‚¤ì›Œë“œ ê¸°ë°˜ íŒŒì‹± í•¨ìˆ˜
 * "í‚¤ì›Œë“œ:" ë’¤ì˜ ê°’ì„ ì¶”ì¶œ
 */
function parseKeywordBased(text) {
  if (!text || typeof text !== 'string') {
    return {};
  }

  const result = {};
  
  // ì •ê·œí™”: ì¤„ë°”ê¿ˆ ì •ë¦¬
  const normalizedText = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
  
  // ê° í•„ë“œë³„ í‚¤ì›Œë“œ íŒ¨í„´ ì •ì˜
  const patterns = {
    carNumber: [
      /ì°¨ëŸ‰ë²ˆí˜¸\s*[:ï¼š]\s*([0-9ê°€-í£\-]+)/i,
      /ì°¨ëŸ‰\s*ë²ˆí˜¸\s*[:ï¼š]\s*([0-9ê°€-í£\-]+)/i,
      /ì°¨ë²ˆ\s*[:ï¼š]\s*([0-9ê°€-í£\-]+)/i
    ],
    phone: [
      /ì—°ë½ì²˜\s*[:ï¼š]\s*([^\n]+)/i,
      /ì—°ë½ì²˜\s*[-=]\s*([^\n]+)/i,
      /ì—°ë½ì²˜\s+([^\n]+)/i,
      /ì‚¬ê³ \s*ì—°ë½ì²˜\s*[:ï¼š]\s*([^\n]+)/i
    ],
    vin: [
      /ì°¨ëŒ€ë²ˆí˜¸\s*[:ï¼š]\s*([A-Z0-9\s-]{10,20})/i,
      /ì°¨ëŒ€ë²ˆí˜¸\s*[-=]\s*([A-Z0-9\s-]{10,20})/i,
      /ì°¨ëŒ€ë²ˆí˜¸\s+([A-Z0-9\s-]{10,20})/i,
      /VIN\s*[:ï¼š]\s*([A-Z0-9\s-]{10,20})/i,
      /VIN\s*[-=]\s*([A-Z0-9\s-]{10,20})/i,
      /VIN\s+([A-Z0-9\s-]{10,20})/i,
      // VIN 17ìë¦¬ íŒ¨í„´ (ê³µë°±/í•˜ì´í”ˆ ì œê±° í›„ ê²€ì¦)
      /(?:ì°¨ëŒ€ë²ˆí˜¸|VIN)\s*[:ï¼š-]?\s*([A-Z0-9]{17})/i
    ],
    receiptNumber: [
      /ì ‘ìˆ˜ë²ˆí˜¸\s*[:ï¼š]\s*([^\n]+)/i,
      /ì ‘ìˆ˜ë²ˆí˜¸\s*[-=]\s*([^\n]+)/i,
      /ì ‘ìˆ˜ë²ˆí˜¸\s+([^\n]+)/i,
      /ì‚¬ê³ ì ‘ìˆ˜ë²ˆí˜¸\s*[:ï¼š]\s*([^\n]+)/i
    ],
    damageType: [
      /ìˆ˜ë¦¬ë¶€ìœ„\s*[:ï¼š]\s*([^\n]+)/i,
      /ìˆ˜ë¦¬ë¶€ìœ„\s*[-=]\s*([^\n]+)/i,
      /ìˆ˜ë¦¬ë¶€ìœ„\s+([^\n]+)/i,
      /íŒŒì†ë¶€ìœ„\s*[:ï¼š]\s*([^\n]+)/i,
      /íŒŒì†ë¶€ìœ„\s*[-=]\s*([^\n]+)/i,
      /íŒŒì†ë¶€ìœ„\s+([^\n]+)/i,
      /íŒŒì†ìœ í˜•\s*[:ï¼š]\s*([^\n]+)/i,
      /íŒŒì†ìœ í˜•\s*[-=]\s*([^\n]+)/i,
      /íŒŒì†ìœ í˜•\s+([^\n]+)/i
    ],
    accidentLocation: [
      /ìˆ˜ë¦¬ìš”ì²­ì§€\s*[:ï¼š]\s*([^\n]+)/i,
      /ìˆ˜ë¦¬ìš”ì²­ì§€\s*[-=]\s*([^\n]+)/i,
      /ìˆ˜ë¦¬ìš”ì²­ì§€\s+([^\n]+)/i,
      /ìš”ì²­ì§€\s*[:ï¼š]\s*([^\n]+)/i,
      /ìš”ì²­ì§€\s*[-=]\s*([^\n]+)/i,
      /ìš”ì²­ì§€\s+([^\n]+)/i,
      /ìˆ˜ë¦¬\s*ì¥ì†Œ\s*[:ï¼š]\s*([^\n]+)/i,
      /ìˆ˜ë¦¬\s*ì¥ì†Œ\s*[-=]\s*([^\n]+)/i,
      /ìˆ˜ë¦¬\s*ì¥ì†Œ\s+([^\n]+)/i,
      /ì‚¬ê³ \s*ì¥ì†Œ\s*[:ï¼š]\s*([^\n]+)/i,
      /ì‚¬ê³ ìœ„ì¹˜\s*[:ï¼š]\s*([^\n]+)/i,
      /ì£¼ì†Œ\s*[:ï¼š]\s*([^\n]+)/i
    ],
    insurer: [
      // ë³´í—˜ì‚¬ í‚¤ì›Œë“œ íŒ¨í„´
      /ë³´í—˜ì‚¬\s*[:ï¼š]\s*([^\n]+)/i,
      /ë³´í—˜ì‚¬\s*[-=]\s*([^\n]+)/i,
      /ë³´í—˜ì‚¬\s+([^\n]+)/i,
      /ë³´í—˜ì‚¬ëª…\s*[:ï¼š]\s*([^\n]+)/i,
      /ìºí”¼íƒˆ\s*[:ï¼š]\s*([^\n]+)/i,
      // ë³´í—˜ì‚¬ëª… ì§ì ‘ ë§¤ì¹­ (ì°¨ëŸ‰ë²ˆí˜¸ì™€ í˜¼ë™ ë°©ì§€)
      // ë³´í—˜ì‚¬ëª…ì´ í‚¤ì›Œë“œ ì—†ì´ ì§ì ‘ ë‚˜íƒ€ë‚˜ëŠ” ê²½ìš°
      /(?:^|\n)\s*(í˜„ëŒ€ìºí”¼íƒˆ|ì‚¼ì„±í™”ì¬|DBì†ë³´|KBì†ë³´|í•œí™”ì†ë³´|ë¡¯ë°ì†ë³´|MGì†ë³´|ë™ë¶€í™”ì¬|AXAì†ë³´|í¥êµ­í™”ì¬|ë©”ë¦¬ì¸ í™”ì¬|êµë³´ì†ë³´|NHì†ë³´|í•˜ë‚˜ì†ë³´|ì‹ í•œì†ë³´|ì¹´ì¹´ì˜¤í˜ì´ì†ë³´|ë¼ì´ë‚˜ìƒëª…|êµë³´ìƒëª…|ì‚¼ì„±ìƒëª…|í•œí™”ìƒëª…|ë™ë¶€ìƒëª…|í‘¸ë¥´ë´ì…œìƒëª…|ë¯¸ë˜ì—ì…‹ìƒëª…|êµë³´AXAìƒëª…|ì‹ í•œìƒëª…|í•˜ë‚˜ìƒëª…|NHìƒëª…|KBìƒëª…|DBìƒëª…|í˜„ëŒ€ìƒëª…|ì‚¼ì„±í™”ì¬í•´ìƒë³´í—˜|í˜„ëŒ€í•´ìƒ|ë™ë¶€í™”ì¬í•´ìƒë³´í—˜|ë¡¯ë°ì†í•´ë³´í—˜|í•œí™”ì†í•´ë³´í—˜|MGì†í•´ë³´í—˜|AXAì†í•´ë³´í—˜|í¥êµ­í™”ì¬í•´ìƒë³´í—˜|ë©”ë¦¬ì¸ í™”ì¬í•´ìƒë³´í—˜|êµë³´ì†í•´ë³´í—˜|NHì†í•´ë³´í—˜|í•˜ë‚˜ì†í•´ë³´í—˜|ì‹ í•œì†í•´ë³´í—˜|ì¹´ì¹´ì˜¤í˜ì´ì†í•´ë³´í—˜)(?:\s*[:ï¼š]|\s|$)/i
    ],
    memo: [
      /ìš”ì²­ì‚¬í•­\s*[:ï¼š]\s*([^\n]+(?:\n(?!\s*[ê°€-í£]+\s*[:ï¼š])[^\n]+)*)/i,
      /ìš”ì²­ì‚¬í•­\s*[-=]\s*([^\n]+(?:\n(?!\s*[ê°€-í£]+\s*[:ï¼š])[^\n]+)*)/i,
      /ë©”ëª¨\s*[:ï¼š]\s*([^\n]+(?:\n(?!\s*[ê°€-í£]+\s*[:ï¼š])[^\n]+)*)/i,
      /ì‚¬ê³ \s*ë‚´ìš©\s*[:ï¼š]\s*([^\n]+(?:\n(?!\s*[ê°€-í£]+\s*[:ï¼š])[^\n]+)*)/i
    ],
    carModel: [
      /ì°¨ëª…\s*[:ï¼š]\s*([^\n]+)/i
    ],
    deductible: [
      /ë©´ì±…ê¸ˆ\s*[:ï¼š]\s*([0-9]+ë§Œì›)/i,
      /ë©´ì±…ê¸ˆ\s*[:ï¼š]\s*(\d{1,3},?\d{0,3}ì›)/i,
      /ë©´ì±…ê¸ˆ\s+([0-9]+ë§Œì›)/i
    ],
    deductiblePayType: [
      /ì„ ë‚©/i,
      /í›„ë‚©/i
    ]
  };
  
  // ê° í•„ë“œì— ëŒ€í•´ íŒ¨í„´ ë§¤ì¹­
  for (const [field, fieldPatterns] of Object.entries(patterns)) {
    // ì°¨ëŸ‰ë²ˆí˜¸ í•„ë“œ ë””ë²„ê¹…ìš©
    if (field === 'carNumber') {
      console.log('=== ì°¨ëŸ‰ë²ˆí˜¸ íŒŒì‹± ì‹œì‘ ===');
      console.log('ì›ë³¸ í…ìŠ¤íŠ¸:', text);
      console.log('ì •ê·œí™”ëœ í…ìŠ¤íŠ¸:', normalizedText);
      console.log('ì°¨ëŸ‰ë²ˆí˜¸ íŒ¨í„´ ê°œìˆ˜:', fieldPatterns.length);
    }
    
    for (let patternIndex = 0; patternIndex < fieldPatterns.length; patternIndex++) {
      const pattern = fieldPatterns[patternIndex];
      const match = normalizedText.match(pattern);
      
      // ì°¨ëŸ‰ë²ˆí˜¸ í•„ë“œ ë””ë²„ê¹…ìš©
      if (field === 'carNumber') {
        console.log(`íŒ¨í„´ ${patternIndex + 1}:`, pattern);
        console.log('ë§¤ì¹­ ê²°ê³¼:', match);
      }
      
      if (match) {
        let value = '';
        
        // ë³´í—˜ì‚¬ëª… ì§ì ‘ ë§¤ì¹­ íŒ¨í„´ ì²˜ë¦¬ (match[1]ì´ ë³´í—˜ì‚¬ëª…)
        if (field === 'insurer' && match[1] && /^(í˜„ëŒ€ìºí”¼íƒˆ|ì‚¼ì„±í™”ì¬|DBì†ë³´|KBì†ë³´|í•œí™”ì†ë³´|ë¡¯ë°ì†ë³´|MGì†ë³´|ë™ë¶€í™”ì¬|AXAì†ë³´|í¥êµ­í™”ì¬|ë©”ë¦¬ì¸ í™”ì¬|êµë³´ì†ë³´|NHì†ë³´|í•˜ë‚˜ì†ë³´|ì‹ í•œì†ë³´|ì¹´ì¹´ì˜¤í˜ì´ì†ë³´|ë¼ì´ë‚˜ìƒëª…|êµë³´ìƒëª…|ì‚¼ì„±ìƒëª…|í•œí™”ìƒëª…|ë™ë¶€ìƒëª…|í‘¸ë¥´ë´ì…œìƒëª…|ë¯¸ë˜ì—ì…‹ìƒëª…|êµë³´AXAìƒëª…|ì‹ í•œìƒëª…|í•˜ë‚˜ìƒëª…|NHìƒëª…|KBìƒëª…|DBìƒëª…|í˜„ëŒ€ìƒëª…|ì‚¼ì„±í™”ì¬í•´ìƒë³´í—˜|í˜„ëŒ€í•´ìƒ|ë™ë¶€í™”ì¬í•´ìƒë³´í—˜|ë¡¯ë°ì†í•´ë³´í—˜|í•œí™”ì†í•´ë³´í—˜|MGì†í•´ë³´í—˜|AXAì†í•´ë³´í—˜|í¥êµ­í™”ì¬í•´ìƒë³´í—˜|ë©”ë¦¬ì¸ í™”ì¬í•´ìƒë³´í—˜|êµë³´ì†í•´ë³´í—˜|NHì†í•´ë³´í—˜|í•˜ë‚˜ì†í•´ë³´í—˜|ì‹ í•œì†í•´ë³´í—˜|ì¹´ì¹´ì˜¤í˜ì´ì†í•´ë³´í—˜)/i.test(match[1])) {
          // ë³´í—˜ì‚¬ëª…ì´ ì§ì ‘ ë§¤ì¹­ëœ ê²½ìš° (ë³´í—˜ì‚¬ëª… ìì²´ë¥¼ ê°’ìœ¼ë¡œ ì‚¬ìš©)
          value = match[1].trim();
        } else if (match[1]) {
          // ì¼ë°˜ íŒ¨í„´ (match[1]ì´ ê°’)
          value = match[1].trim();
        }
        
        // ì°¨ëŸ‰ë²ˆí˜¸ í•„ë“œ ë””ë²„ê¹…ìš©
        if (field === 'carNumber') {
          console.log('ë§¤ì¹­ëœ ì›ë³¸ ê°’ (match[1]):', match[1]);
          console.log('trim í›„ ê°’:', value);
        }
        
        if (!value) {
          // ì°¨ëŸ‰ë²ˆí˜¸ í•„ë“œ ë””ë²„ê¹…ìš©
          if (field === 'carNumber') {
            console.log('âŒ ê°’ì´ ë¹„ì–´ìˆì–´ì„œ ê±´ë„ˆëœ€');
          }
          continue;
        }
        
        // âœ… ì°¨ëŸ‰ë²ˆí˜¸ëŠ” í•œê¸€ í¬í•¨ ê·¸ëŒ€ë¡œ ìœ ì§€
        if (field === 'carNumber') {
          value = value.replace(/[^0-9ê°€-í£\-]/g, "").trim();
        } else {
          // ë¶ˆí•„ìš”í•œ êµ¬ë¶„ì ì œê±° (ì•ë’¤ë§Œ)
          const beforeClean = value;
          value = value.replace(/^[:ï¼š\s\-=]+|[:ï¼š\s\-=]+$/g, '');
          
          // ì°¨ëŸ‰ë²ˆí˜¸ í•„ë“œ ë””ë²„ê¹…ìš©
          if (field === 'carNumber') {
            console.log('êµ¬ë¶„ì ì œê±° ì „:', beforeClean);
            console.log('êµ¬ë¶„ì ì œê±° í›„:', value);
          }
          
          value = value.split(/\n/)[0].trim();
        }
        
        // ì°¨ëŸ‰ë²ˆí˜¸ í•„ë“œ íŠ¹ë³„ ì²˜ë¦¬
        if (field === 'carNumber') {
          // ì¤„ë°”ê¿ˆ ì „ê¹Œì§€ë§Œ ì¶”ì¶œ
          value = value.split(/\n/)[0].trim();
          
          // ì°¨ëŸ‰ë²ˆí˜¸ í•„ë“œ ë””ë²„ê¹…ìš©
          console.log('ì¤„ë°”ê¿ˆ ë¶„ë¦¬ í›„:', value);
          
          // ë³´í—˜ì‚¬ëª…ì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ì œì™¸ (ë¨¼ì € ì²´í¬)
          const insurerNames = ['í˜„ëŒ€ìºí”¼íƒˆ', 'ì‚¼ì„±í™”ì¬', 'DBì†ë³´', 'KBì†ë³´', 'í•œí™”ì†ë³´', 'ë¡¯ë°ì†ë³´', 'MGì†ë³´', 'ë™ë¶€í™”ì¬', 'AXAì†ë³´', 'í¥êµ­í™”ì¬', 'ë©”ë¦¬ì¸ í™”ì¬', 'êµë³´ì†ë³´', 'NHì†ë³´', 'í•˜ë‚˜ì†ë³´', 'ì‹ í•œì†ë³´'];
          if (insurerNames.some(name => value.includes(name))) {
            console.log('âŒ ë³´í—˜ì‚¬ëª…ì´ í¬í•¨ë˜ì–´ ìˆì–´ì„œ ê±´ë„ˆëœ€. ê°’:', value);
            continue; // ì´ ë§¤ì¹­ì€ ê±´ë„ˆë›°ê¸°
          }
          
          // ë‹¤ìŒ í•„ë“œ í‚¤ì›Œë“œê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ê·¸ ì „ê¹Œì§€ë§Œ ì¶”ì¶œ (ì¤„ë°”ê¿ˆ ì—†ì´ ê°™ì€ ì¤„ì— ìˆëŠ” ê²½ìš°)
          // ì£¼ì˜: "ì°¨ëª…" í‚¤ì›Œë“œëŠ” ì°¨ëŸ‰ë²ˆí˜¸ ê°’(ì˜ˆ: "203í˜¸8203")ì— í¬í•¨ë  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, 
          // "ì°¨ëª… :" ë˜ëŠ” "ì°¨ëª…:" í˜•ì‹ì¼ ë•Œë§Œ ë‹¤ìŒ í•„ë“œë¡œ ì¸ì‹í•˜ì—¬ ì œê±°
          const nextFieldKeywords = ['ì°¨ëŒ€ë²ˆí˜¸', 'VIN', 'ì—°ë½ì²˜', 'ìˆ˜ë¦¬ìš”ì²­ì§€', 'ìˆ˜ë¦¬ë¶€ìœ„', 'íŒŒì†ë¶€ìœ„', 'íŒŒì†ìœ í˜•', 'ì ‘ìˆ˜ë²ˆí˜¸', 'ë³´í—˜ì‚¬', 'ìš”ì²­ì‚¬í•­', 'ë©”ëª¨', 'ë©´ì±…ê¸ˆ'];
          
          // "ì°¨ëª…"ì€ ë³„ë„ ì²˜ë¦¬: "ì°¨ëª… :" ë˜ëŠ” "ì°¨ëª…:" í˜•ì‹ì¼ ë•Œë§Œ ì œê±°
          // "203í˜¸8203" ê°™ì€ ì°¨ëŸ‰ë²ˆí˜¸ì—ëŠ” "ì°¨ëª…"ì´ í¬í•¨ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì•ˆì „
          if (value.includes('ì°¨ëª…')) {
            const ì°¨ëª…Index = value.indexOf('ì°¨ëª…');
            // "ì°¨ëª… :" ë˜ëŠ” "ì°¨ëª…:" í˜•ì‹ì¸ì§€ í™•ì¸ (ê³µë°± + ì½œë¡  ë˜ëŠ” ë°”ë¡œ ì½œë¡ )
            const afterì°¨ëª… = value.substring(ì°¨ëª…Index + 2);
            if (afterì°¨ëª….match(/^\s*[:ï¼š]/)) {
              console.log(`âš ï¸ "ì°¨ëª… :" í˜•ì‹ ë°œê²¬ (ìœ„ì¹˜: ${ì°¨ëª…Index}), ê·¸ ì „ê¹Œì§€ë§Œ ì¶”ì¶œ`);
              value = value.substring(0, ì°¨ëª…Index).trim();
            } else {
              // "ì°¨ëª…"ì´ ê°’ì— í¬í•¨ë˜ì–´ ìˆì§€ë§Œ ë‹¤ìŒ í•„ë“œê°€ ì•„ë‹Œ ê²½ìš° (ì˜ˆ: "203í˜¸ì°¨ëª…8203" ê°™ì€ ì˜ëª»ëœ ê²½ìš°)
              // ì´ ê²½ìš°ëŠ” ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰
              console.log(`âš ï¸ "ì°¨ëª…" ë°œê²¬í–ˆì§€ë§Œ ë‹¤ìŒ í•„ë“œ í˜•ì‹ì´ ì•„ë‹ˆë¯€ë¡œ ë¬´ì‹œ (ìœ„ì¹˜: ${ì°¨ëª…Index})`);
            }
          }
          
          // ë‹¤ë¥¸ í‚¤ì›Œë“œ ì²˜ë¦¬
          for (const keyword of nextFieldKeywords) {
            const keywordIndex = value.indexOf(keyword);
            if (keywordIndex !== -1) {
              console.log(`âš ï¸ ë‹¤ìŒ í‚¤ì›Œë“œ "${keyword}" ë°œê²¬ (ìœ„ì¹˜: ${keywordIndex}), ê·¸ ì „ê¹Œì§€ë§Œ ì¶”ì¶œ`);
              value = value.substring(0, keywordIndex).trim();
              break;
            }
          }
          
          // ë¹ˆê°’ì´ë©´ ê±´ë„ˆë›°ê¸°
          if (!value || value.length === 0) {
            console.log('âŒ í‚¤ì›Œë“œ ì œê±° í›„ ê°’ì´ ë¹„ì–´ìˆì–´ì„œ ê±´ë„ˆëœ€');
            continue;
          }
          
          console.log('âœ… ì°¨ëŸ‰ë²ˆí˜¸ ìµœì¢… ê°’:', value);
        } else {
          // ë‹¤ë¥¸ í•„ë“œëŠ” ì¤„ë°”ê¿ˆê¹Œì§€ë§Œ
          value = value.split(/\n/)[0].trim();
        }
        
        // VIN í•„ë“œ íŠ¹ë³„ ì²˜ë¦¬: ê³µë°±/í•˜ì´í”ˆ ì œê±° í›„ 17ìë¦¬ ê²€ì¦
        if (field === 'vin') {
          const cleanedVin = value.replace(/[\s\-]/g, '');
          if (cleanedVin.length >= 10 && cleanedVin.length <= 20) {
            value = cleanedVin;
          }
        }
        
        if (value && value.length > 0) {
          result[field] = value;
          
          // ì°¨ëŸ‰ë²ˆí˜¸ í•„ë“œ ë””ë²„ê¹…ìš©
          if (field === 'carNumber') {
            console.log('âœ… ì°¨ëŸ‰ë²ˆí˜¸ resultì— ì €ì¥ë¨:', result[field]);
            console.log('=== ì°¨ëŸ‰ë²ˆí˜¸ íŒŒì‹± ì™„ë£Œ ===');
          }
          
          break; // ì²« ë²ˆì§¸ ë§¤ì¹­ë§Œ ì‚¬ìš©
        } else {
          // ì°¨ëŸ‰ë²ˆí˜¸ í•„ë“œ ë””ë²„ê¹…ìš©
          if (field === 'carNumber') {
            console.log('âŒ ìµœì¢… ê°’ì´ ë¹„ì–´ìˆì–´ì„œ resultì— ì €ì¥í•˜ì§€ ì•ŠìŒ');
          }
        }
      } else {
        // ì°¨ëŸ‰ë²ˆí˜¸ í•„ë“œ ë””ë²„ê¹…ìš©
        if (field === 'carNumber') {
          console.log(`íŒ¨í„´ ${patternIndex + 1} ë§¤ì¹­ ì‹¤íŒ¨`);
        }
      }
    }
    
    // ì°¨ëŸ‰ë²ˆí˜¸ í•„ë“œ ë””ë²„ê¹…ìš© - ëª¨ë“  íŒ¨í„´ ì‹œë„ í›„ ê²°ê³¼ í™•ì¸
    if (field === 'carNumber') {
      console.log('ìµœì¢… result.carNumber:', result.carNumber || '(ì—†ìŒ)');
      if (!result.carNumber) {
        console.log('âŒ ì°¨ëŸ‰ë²ˆí˜¸ ë§¤ì¹­ ì‹¤íŒ¨ ì´ìœ  ë¶„ì„:');
        console.log('1. íŒ¨í„´ì´ í…ìŠ¤íŠ¸ì™€ ì¼ì¹˜í•˜ì§€ ì•ŠìŒ');
        console.log('2. ë§¤ì¹­ì€ ë˜ì—ˆì§€ë§Œ í›„ì²˜ë¦¬ ê³¼ì •ì—ì„œ ê°’ì´ ì œê±°ë¨');
        console.log('3. ë³´í—˜ì‚¬ëª… í•„í„°ë§ì— ì˜í•´ ì œì™¸ë¨');
        console.log('4. ë‹¤ìŒ í‚¤ì›Œë“œ í•„í„°ë§ì— ì˜í•´ ê°’ì´ ëª¨ë‘ ì œê±°ë¨');
        // ì‹¤ì œ í…ìŠ¤íŠ¸ì—ì„œ "ì°¨ëŸ‰ë²ˆí˜¸" í‚¤ì›Œë“œ ê²€ìƒ‰
        const carNumberKeywordIndex = normalizedText.indexOf('ì°¨ëŸ‰ë²ˆí˜¸');
        if (carNumberKeywordIndex !== -1) {
          const context = normalizedText.substring(Math.max(0, carNumberKeywordIndex - 10), Math.min(normalizedText.length, carNumberKeywordIndex + 50));
          console.log('í…ìŠ¤íŠ¸ì—ì„œ "ì°¨ëŸ‰ë²ˆí˜¸" ë°œê²¬ ìœ„ì¹˜:', carNumberKeywordIndex);
          console.log('ì£¼ë³€ í…ìŠ¤íŠ¸:', context);
        } else {
          console.log('í…ìŠ¤íŠ¸ì—ì„œ "ì°¨ëŸ‰ë²ˆí˜¸" í‚¤ì›Œë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
        }
      }
    }
  }
  
  return result;
}

/**
 * íŒŒì‹±ëœ ë°ì´í„°ë¥¼ í¼ì— ì±„ìš°ê³  ì‹œê°ì  í”¼ë“œë°± ì œê³µ
 */
function fillFormWithVisualFeedback(parsedData) {
  const fieldMapping = {
    receiptNumber: 'receiptNumber',
    accidentTime: 'accidentTime',
    customerName: 'customerName',
    phone: 'phone',
    carNumber: 'carNumber',
    vin: 'vin',
    insurer: 'insurer',
    accidentLocation: 'accidentLocation',
    damageType: 'damageType',
    manager: 'manager',
    memo: 'memo',
    carModel: 'carModel',
    deductible: 'deductible',
    deductiblePayType: 'deductiblePayType'
  };
  
  let filledCount = 0;
  
  // ëª¨ë“  í•„ë“œ ì´ˆê¸°í™”
  for (const fieldId of Object.values(fieldMapping)) {
    const element = document.getElementById(fieldId);
    if (element) {
      element.classList.remove('field-auto-filled', 'field-manual');
    }
  }
  
  // íŒŒì‹±ëœ ë°ì´í„° ì ìš© (ìˆ˜ë™ ì…ë ¥ ê°’ ìš°ì„ )
  const priorityFields = ['carNumber', 'insurer', 'accidentLocation', 'damageType'];
  
  for (const [key, fieldId] of Object.entries(fieldMapping)) {
    const element = document.getElementById(fieldId);
    if (element) {
      const parsedValue = parsedData[key];
      
      // ìš°ì„ ìˆœìœ„ í•„ë“œì¸ ê²½ìš°: ìˆ˜ë™ ì…ë ¥ ê°’ì´ ìˆìœ¼ë©´ ìë™ ì…ë ¥ìœ¼ë¡œ ë®ì–´ì“°ì§€ ì•ŠìŒ
      if (priorityFields.includes(key)) {
        const currentValue = element.value.trim();
        // ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥ëœ ê°’ì´ ìˆìœ¼ë©´ (field-manual í´ë˜ìŠ¤ê°€ ìˆê±°ë‚˜, ê°’ì´ ìˆê³  ìë™ ì…ë ¥ í‘œì‹œê°€ ì—†ëŠ” ê²½ìš°)
        const hasManualInput = element.classList.contains('field-manual');
        
        if (hasManualInput && currentValue) {
          // ìˆ˜ë™ ì…ë ¥ ê°’ì´ ìˆìœ¼ë©´ ìë™ ì…ë ¥ ë¬´ì‹œ
          continue;
        }
        // ê°’ì´ ìˆì§€ë§Œ ìˆ˜ë™ ì…ë ¥ í‘œì‹œê°€ ì—†ëŠ” ê²½ìš°ëŠ” ìë™ ì…ë ¥ìœ¼ë¡œ ë®ì–´ì“¸ ìˆ˜ ìˆìŒ
      }
      
      // ìë™ ì…ë ¥ ê°’ ì ìš©
      if (parsedValue && parsedValue.trim() !== '') {
        element.value = parsedValue;
        element.classList.add('field-auto-filled');
        filledCount++;
      }
      // ê°’ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ í°ìƒ‰ ìœ ì§€ (ë…¸ë€ìƒ‰ ì œê±°)
    }
  }
  
  // ìˆ˜ë™ ì…ë ¥ ê°ì§€ (ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€)
  for (const fieldId of Object.values(fieldMapping)) {
    const element = document.getElementById(fieldId);
    if (element && !element.hasAttribute('data-listener-added')) {
      element.addEventListener('input', function() {
        this.classList.remove('field-auto-filled');
        this.classList.add('field-manual');
      });
      element.setAttribute('data-listener-added', 'true');
    }
  }
  
  return { filledCount };
}

  // ì¹´ì¹´ì˜¤í†¡ í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸°ì—ì„œ ìë™ ì…ë ¥
function fillFromKakao() {
  const text = document.getElementById("kakaoRaw").value;

  if (!text || text.trim() === "") {
    alert("ì¹´ì¹´ì˜¤í†¡ ë©”ì‹œì§€ë¥¼ ë¶™ì—¬ë„£ì–´ì£¼ì„¸ìš”.");
    return;
  }

  // í‚¤ì›Œë“œ ê¸°ë°˜ íŒŒì‹± ì‚¬ìš©
  const parsedData = parseKeywordBased(text);
  
  // í¼ì— ì±„ìš°ê³  ì‹œê°ì  í”¼ë“œë°± ì œê³µ
  const { filledCount } = fillFormWithVisualFeedback(parsedData);
  
  // ìë™ ì…ë ¥ í›„ localStorageì— ì €ì¥
  saveFormToLocalStorage();
  
  document.getElementById("statusMsg").innerText = 
    `âœ… ìë™ ì…ë ¥ ì™„ë£Œ (${filledCount}ê°œ í•„ë“œ ìë™ ì…ë ¥ë¨)`;
}

// ì €ì¥ ì¤‘ í”Œë˜ê·¸ (ì¤‘ë³µ ì €ì¥ ë°©ì§€)
let isSaving = false;

async function saveAccident() {
  if (!window.supabaseClient) {
    console.error('Supabase client missing');
    alert('Supabase ì´ˆê¸°í™” ì‹¤íŒ¨');
    return;
  }

  // ì¤‘ë³µ ì €ì¥ ë°©ì§€
  if (isSaving) {
    console.warn('[Accident] Save already in progress, skipping');
    return;
  }

  // í•„ìˆ˜ ì…ë ¥ í•­ëª©ë§Œ ê²€ì¦ (ì ‘ìˆ˜ë²ˆí˜¸, ì—°ë½ì²˜)
  const required = [
    "receiptNumber",
    "phone"
  ];

  const missingFields = [];
  const fieldNames = {
    "receiptNumber": "ì ‘ìˆ˜ë²ˆí˜¸",
    "phone": "ì—°ë½ì²˜"
  };

  for (let id of required) {
    if (!document.getElementById(id).value.trim()) {
      missingFields.push(fieldNames[id]);
    }
  }

  if (missingFields.length > 0) {
    document.getElementById("statusMsg").innerText =
      `âŒ ë‹¤ìŒ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤: ${missingFields.join(', ')}`;
    document.getElementById("statusMsg").style.color = "red";
    return;
  }

  // ìƒíƒœ ë©”ì‹œì§€ ì´ˆê¸°í™”
  const statusMsg = document.getElementById("statusMsg");
  statusMsg.innerText = "â³ ì €ì¥ ì¤‘...";
  statusMsg.style.color = "#2563eb";

  isSaving = true;

  try {
    // ë°©ì–´ ë¡œì§: API í˜¸ì¶œ ì „ client ì¡´ì¬ ì—¬ë¶€ ì¬í™•ì¸
    if (!window.supabaseClient) {
      console.error("Supabase client not ready");
      throw new Error("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
    }

    // Wait for Supabase to be ready
    await waitForSupabase();
    
    // ë°©ì–´ ë¡œì§: API í˜¸ì¶œ ì „ client ì¡´ì¬ ì—¬ë¶€ ìµœì¢… í™•ì¸
    if (!window.supabaseClient) {
      console.error("Supabase client not ready");
      throw new Error("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
    }
    
    // Check if API functions are available
    if (!window.API?.saveAccident && !window.saveAccidentRecord) {
      throw new Error("Supabase API í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
    }
    
    // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° (manager_idìš©)
    // ë°©ì–´ ë¡œì§: API í˜¸ì¶œ ì „ client ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    if (!window.supabaseClient || !window.supabaseClient.auth) {
      console.error("Supabase client not ready");
      throw new Error("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
    }
    
    const { data: { user }, error: userError } = await window.supabaseClient.auth.getUser();
    if (userError) {
      throw new Error("ì‚¬ìš©ì ì¸ì¦ ì˜¤ë¥˜: " + userError.message);
    }
    if (!user) {
      throw new Error("ë¡œê·¸ì¸í•œ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.");
    }
    
    // manager_id ì„¤ì •: ë¡œê·¸ì¸ ì‚¬ìš©ì idë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©
    // ë‹´ë‹¹ì ì´ë¦„ì´ ìˆ˜ì •ë˜ì–´ë„ manager_idëŠ” ìœ ì§€ (ì´ë¯¸ ì„¤ì •ëœ ê²½ìš°)
    if (!managerId) {
      managerId = user.id;
    }
    
    // ë‹´ë‹¹ì ì´ë¦„ (í™”ë©´ì— ì…ë ¥ëœ ê°’)
    const managerName = document.getElementById("manager").value.trim();
    
    // ìƒíƒœ select ë°•ìŠ¤ì—ì„œ í˜„ì¬ ìƒíƒœ ê°’ ì½ê¸°
    const statusSelect = document.getElementById("accidentStatus");
    const currentStatus = statusSelect ? statusSelect.value : "ì ‘ìˆ˜ë¨";
    
    // ì™„ë£Œ/ì •ì‚° ë‹¨ê³„ ë³´í˜¸ (í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸)
    if (['ì‘ì—…ì™„ë£Œ', 'ì •ì‚°ì™„ë£Œ'].includes(currentStatus)) {
      const ok = confirm(`${currentStatus} ìƒíƒœë¡œ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
      if (!ok) {
        statusMsg.innerText = "ì €ì¥ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.";
        statusMsg.style.color = "orange";
        isSaving = false;
        return;
      }
    }
    
    // í¼ ë°ì´í„° ìˆ˜ì§‘ - ìƒˆë¡œìš´ ì»¬ëŸ¼ëª… ê¸°ì¤€ìœ¼ë¡œ ë§¤í•‘
    const data = {
      case_no: document.getElementById("receiptNumber").value.trim(),
      incident_date: document.getElementById("accidentTime").value.trim(),
      customer_name: document.getElementById("customerName").value.trim(),
      phone: document.getElementById("phone").value.trim(),
      car_no: document.getElementById("carNumber").value.trim(),
      vin: document.getElementById("vin").value.trim(),
      car_model: document.getElementById("carModel").value.trim(),
      insurance: document.getElementById("insurer").value.trim(),
      damage_type: document.getElementById("damageType").value.trim(),
      accident_location: document.getElementById("accidentLocation").value.trim(),
      manager: managerName,
      memo: document.getElementById("memo").value.trim(),
      deductible: document.getElementById("deductible").value.trim(),
      deductible_type: document.getElementById("deductiblePayType").value.trim(),
      assigned_workshop_name: document.getElementById("assignedWorkshopName").value.trim(),
      assigned_workshop_address: document.getElementById("assignedWorkshopAddress").value.trim(),
      assigned_workshop_phone: document.getElementById("assignedWorkshopPhone").value.trim(),
      status: currentStatus || "ì ‘ìˆ˜ì™„ë£Œ",
      manager_id: managerId,
      manager_name: managerName
    };
    
    // Timestamp í•„ë“œ ì •ê·œí™” (ë¹ˆ ë¬¸ìì—´ì„ nullë¡œ ë³€í™˜)
    if (data.incident_date === '') {
      data.incident_date = null;
    }
    
    // ê¸°ì¡´ ì‚¬ê³ ì¸ì§€ í™•ì¸ (ë‹´ë‹¹ì ë³€ê²½ ì´ë ¥ ë¡œê·¸ìš©)
    const caseNo = data.case_no;
    let oldManagerId = null;
    let oldStatus = null;
    let accidentId = null;
    
    if (caseNo) {
      try {
        // ë°©ì–´ ë¡œì§: API í˜¸ì¶œ ì „ client ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        if (!window.supabaseClient) {
          console.error("Supabase client not ready");
          throw new Error("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        }
        
        const { data: existingRecord, error: fetchError } = await window.supabaseClient
          .from('accident_records')
          .select('id, manager_id, status')
          .eq('case_no', caseNo)
          .maybeSingle();
        
        if (!fetchError && existingRecord) {
          oldManagerId = existingRecord.manager_id;
          oldStatus = existingRecord.status || "ì ‘ìˆ˜ë¨";
          accidentId = existingRecord.id;
          // currentStatusëŠ” ì´ë¯¸ ìœ„ì—ì„œ select ë°•ìŠ¤ì—ì„œ ì½ì–´ì™”ìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ìˆ˜ì •í•˜ì§€ ì•ŠìŒ
        }
      } catch (fetchErr) {
        console.warn("ê¸°ì¡´ ì‚¬ê³  ì¡°íšŒ ì˜¤ë¥˜ (ë³€ê²½ ì´ë ¥ ë¡œê·¸ìš©):", fetchErr);
      }
    }
    
    // ìƒíƒœê°€ ë³€ê²½ëœ ê²½ìš° ìƒíƒœ ë³€ê²½ ì´ë ¥ ë¡œê·¸ ì €ì¥
    if (oldStatus !== null && oldStatus !== data.status && caseNo) {
      try {
        // ë°©ì–´ ë¡œì§: API í˜¸ì¶œ ì „ client ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        if (!window.supabaseClient) {
          console.error("Supabase client not ready");
          throw new Error("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        }
        
        await window.supabaseClient
          .from('accident_status_logs')
          .insert({
            case_no: caseNo,
            before_status: oldStatus,
            after_status: data.status,
            changed_by: user.id
          });
        console.log("ìƒíƒœ ë³€ê²½ ì´ë ¥ ë¡œê·¸ ì €ì¥ ì™„ë£Œ (ì €ì¥ ì‹œ)");
      } catch (statusLogError) {
        console.warn("ìƒíƒœ ë³€ê²½ ì´ë ¥ ë¡œê·¸ ì €ì¥ ì‹¤íŒ¨ (ì €ì¥ ì‹œ):", statusLogError);
      }
    }

    // ìˆ˜ì • ëª¨ë“œ ë¶„ê¸° ì²˜ë¦¬
    // ë°©ì–´ ë¡œì§: API í˜¸ì¶œ ì „ client ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    if (!window.supabaseClient) {
      console.error("Supabase client not ready");
      throw new Error("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
    }
    
    let saveResult = null;
    let saveError = null;
    try {
      // ìˆ˜ì • ëª¨ë“œì¸ ê²½ìš° UPDATE, ì‹ ê·œ ëª¨ë“œì¸ ê²½ìš° INSERT/UPSERT
      if (window.__ACCIDENT_EDIT_MODE__) {
        // ìˆ˜ì • ëª¨ë“œ: updateAccidentRecord ì‚¬ìš©
        // caseNoëŠ” ì´ë¯¸ ìœ„ì—ì„œ ì„ ì–¸ë˜ì—ˆìœ¼ë¯€ë¡œ ì¬ì‚¬ìš©
        if (!caseNo) {
          throw new Error("ì ‘ìˆ˜ë²ˆí˜¸(case_no)ê°€ ì—†ì–´ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
        
        if (typeof window.updateAccidentRecord === 'function') {
          saveResult = await window.updateAccidentRecord(caseNo, data);
          if (!saveResult) {
            throw new Error("ìˆ˜ì • ê²°ê³¼ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
          }
          console.log("âœ… ìˆ˜ì • ì„±ê³µ:", saveResult);
        } else {
          throw new Error("ìˆ˜ì • í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
        }
      } else {
        // ì‹ ê·œ ëª¨ë“œ: saveAccidentRecord ì‚¬ìš© (upsert - ì¤‘ë³µ ë°©ì§€)
        if (typeof window.API?.saveAccident === 'function') {
          saveResult = await window.API.saveAccident(data);
          if (!saveResult) {
            throw new Error("ì €ì¥ ê²°ê³¼ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
          }
          console.log("âœ… ì €ì¥ ì„±ê³µ:", saveResult);
        } else if (typeof window.saveAccidentRecord === 'function') {
          saveResult = await window.saveAccidentRecord(data);
          if (!saveResult) {
            throw new Error("ì €ì¥ ê²°ê³¼ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
          }
          console.log("âœ… ì €ì¥ ì„±ê³µ:", saveResult);
        } else if (typeof window.saveAccidentRecord === 'function') {
          saveResult = await window.saveAccidentRecord(data);
          if (!saveResult) {
            throw new Error("ì €ì¥ ê²°ê³¼ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
          }
          console.log("âœ… ì €ì¥ ì„±ê³µ (insert):", saveResult);
        } else {
          throw new Error("Supabase API í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
        }
      }
    } catch (managerErr) {
      saveError = managerErr;
      // manager ê´€ë ¨ ì˜¤ë¥˜ ë¡œê·¸ ë¶„ë¦¬ ì¶œë ¥
      console.error("âŒ ì €ì¥ ì˜¤ë¥˜:", managerErr);
      if (managerErr.message && managerErr.message.includes('manager')) {
        throw new Error("ë‹´ë‹¹ì ì •ë³´ ì €ì¥ ì‹¤íŒ¨: " + managerErr.message);
      }
      throw managerErr;
    }
    
    // ì €ì¥ ì„±ê³µ ì—¬ë¶€ ìµœì¢… í™•ì¸
    if (saveError) {
      throw saveError;
    }
    if (!saveResult) {
      throw new Error("ì €ì¥ì´ ì™„ë£Œë˜ì—ˆì§€ë§Œ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }
    
    // ë‹´ë‹¹ì ë³€ê²½ ì´ë ¥ ë¡œê·¸ ì €ì¥
    if (oldManagerId !== null && oldManagerId !== managerId && accidentId) {
      try {
        // ë°©ì–´ ë¡œì§: API í˜¸ì¶œ ì „ client ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        if (!window.supabaseClient) {
          console.error("Supabase client not ready");
          throw new Error("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        }
        
        await window.supabaseClient
          .from('accident_manager_logs')
          .insert({
            accident_id: accidentId,
            before_manager_id: oldManagerId,
            after_manager_id: managerId,
            changed_by: user.id
          });
        console.log("ë‹´ë‹¹ì ë³€ê²½ ì´ë ¥ ë¡œê·¸ ì €ì¥ ì™„ë£Œ");
      } catch (logError) {
        // ì´ë ¥ ë¡œê·¸ ì €ì¥ ì‹¤íŒ¨ëŠ” ê²½ê³ ë§Œ ì¶œë ¥ (ë©”ì¸ ì €ì¥ì€ ì„±ê³µí–ˆìœ¼ë¯€ë¡œ)
        console.warn("ë‹´ë‹¹ì ë³€ê²½ ì´ë ¥ ë¡œê·¸ ì €ì¥ ì‹¤íŒ¨:", logError);
      }
    }
    
    statusMsg.innerText = "âœ… ì ‘ìˆ˜ ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.";
    statusMsg.style.color = "green";
    
    // ì ‘ìˆ˜ ì €ì¥ ì‹œ accidentId í™•ë³´ ë° ì „ì—­ ìƒíƒœë¡œ ìœ ì§€
    let savedAccidentId = null;
    if (saveResult) {
      // saveResultê°€ ê°ì²´ì´ê³  id ì†ì„±ì´ ìˆëŠ” ê²½ìš°
      if (saveResult.id) {
        savedAccidentId = saveResult.id;
      } else if (saveResult.data && saveResult.data.id) {
        savedAccidentId = saveResult.data.id;
      } else if (Array.isArray(saveResult) && saveResult.length > 0 && saveResult[0].id) {
        savedAccidentId = saveResult[0].id;
      } else if (saveResult[0] && saveResult[0].id) {
        savedAccidentId = saveResult[0].id;
      }
    }
    
    // accidentIdë¥¼ ì „ì—­ ìƒíƒœë¡œ ìœ ì§€ (sessionStorage ì‚¬ìš©)
    if (savedAccidentId) {
      sessionStorage.setItem('currentAccidentId', savedAccidentId);
      window.currentRecordId = savedAccidentId;
      console.log('âœ… accidentId ì €ì¥ë¨:', savedAccidentId);
      
      // ë©”ì‹œì§€ ìƒì„± ë²„íŠ¼ í™œì„±í™”
      const messageButton = document.querySelector('.btn-kakao-vendor');
      if (messageButton) {
        messageButton.disabled = false;
      }
    }
    
    // ì €ì¥ ì„±ê³µ í›„ ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìœ¼ë©´ UI ë°˜ì˜
    if (statusSelect && currentStatus) {
      statusSelect.value = currentStatus;
    }
    
    // ì ‘ìˆ˜ í˜„í™© / ìš”ì•½ ê°±ì‹  (ë¶€ëª¨ ì°½ ë˜ëŠ” í˜„ì¬ ì°½)
    if (window.opener && typeof window.opener.loadRecords === 'function') {
      window.opener.loadRecords();
    } else if (typeof loadAccidentList === 'function') {
      loadAccidentList();
    } else if (typeof loadRecords === 'function') {
      loadRecords();
    }
    
    // ì €ì¥ ì„±ê³µ í›„ localStorageì—ì„œ í¼ ë°ì´í„° ì‚­ì œ
    clearFormFromLocalStorage();
  } catch (error) {
    console.error("ì €ì¥ ì˜¤ë¥˜:", error);
    console.error("Error details:", JSON.stringify(error, null, 2));
    console.error("Error stack:", error.stack);
    
    // More detailed error message
    let errorMsg = error.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜";
    if (error.message && error.message.includes('fetch')) {
      errorMsg = "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: Supabase ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.";
    } else if (error.message && error.message.includes('Failed to fetch')) {
      errorMsg = "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: Supabase ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.";
    }
    
    statusMsg.innerText = "âŒ ì„œë²„ ì €ì¥ ì‹¤íŒ¨: " + errorMsg;
    statusMsg.style.color = "red";
    alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + errorMsg);
  } finally {
    isSaving = false;
  }
}

// í…œí”Œë¦¿ ê´€ë¦¬ì™€ ì—°ë™ë˜ì§€ ì•Šì€ ëª¨ë“  ë©”ì‹œì§€ ìƒì„± ì½”ë“œ ì œê±°ë¨
// ë©”ì‹œì§€ ìƒì„±ì€ /pages/message/index.html í˜ì´ì§€ì—ì„œë§Œ ìˆ˜í–‰ë¨

// ë©”ì‹œì§€ ìƒì„± í˜ì´ì§€ë¡œ ì´ë™
// ë©”ì‹œì§€ ìƒì„±ì€ ë³„ë„ì˜ í˜ì´ì§€ë¡œ ë¶„ë¦¬
function openMessagePage() {
  // accidentId í™•ì¸: URL íŒŒë¼ë¯¸í„° ë˜ëŠ” sessionStorageì—ì„œ ê°€ì ¸ì˜¤ê¸°
  let accidentId = window.currentRecordId || sessionStorage.getItem('currentAccidentId');
  
  if (!accidentId) {
    alert('ì‚¬ê³  IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në¨¼ì € ì ‘ìˆ˜ë¥¼ ì €ì¥í•´ì£¼ì„¸ìš”.');
    return;
  }

  // ë©”ì‹œì§€ ìƒì„± í˜ì´ì§€ë¡œ ì´ë™
  // /pages/message/?accidentId=xxx
  const url = '/pages/message/index.html?accidentId=' + encodeURIComponent(accidentId);
  
  // iframe ë‚´ë¶€ì¸ ê²½ìš° ë¶€ëª¨ ì°½ì—ì„œ ì´ë™
  if (window.parent && window.parent !== window) {
    window.parent.location.href = url;
  } else {
    // ì§ì ‘ í˜ì´ì§€ ì´ë™
    window.location.href = url;
  }
}
</script>

</body>
</html>

