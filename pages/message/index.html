<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë©”ì‹œì§€ ìƒì„± ë° í…œí”Œë¦¿ ê´€ë¦¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="stylesheet" as="style" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Pretendard, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f7fa;
      color: #2c3e50;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
      height: calc(100vh - 40px);
    }

    .column {
      background: #ffffff;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #e1e8ed;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .column h2 {
      font-size: 18px;
      font-weight: 700;
      color: #1a202c;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid #e1e8ed;
    }

    .info-group {
      margin-bottom: 16px;
    }

    .info-label {
      font-size: 12px;
      font-weight: 600;
      color: #718096;
      margin-bottom: 4px;
      display: block;
    }

    .info-value {
      font-size: 14px;
      color: #2d3748;
      padding: 8px 12px;
      background: #f7fafc;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
    }

    .info-value.empty {
      color: #a0aec0;
      font-style: italic;
    }

    .tab-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .tab-button {
      flex: 1;
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 600;
      color: #4a5568;
      background: #edf2f7;
      border: 2px solid transparent;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tab-button.active {
      background: #3b82f6;
      color: #ffffff;
      border-color: #3b82f6;
    }

    .tab-button.workshop.active {
      background: #10b981;
      border-color: #10b981;
    }

    .variables-list {
      background: #f7fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
      font-size: 12px;
    }

    .variables-list h3 {
      font-size: 13px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 8px;
    }

    .variables-list code {
      display: inline-block;
      background: #edf2f7;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      color: #2d3748;
      margin: 2px;
    }

    .template-editor {
      flex: 1;
      margin-bottom: 16px;
    }

    .template-editor textarea {
      width: 100%;
      min-height: 300px;
      padding: 12px;
      font-size: 13px;
      line-height: 1.6;
      border: 1px solid #cbd5e0;
      border-radius: 8px;
      background: #ffffff;
      color: #2d3748;
      resize: vertical;
      font-family: 'Courier New', monospace;
    }

    .template-editor textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .btn-save {
      width: 100%;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 600;
      color: #ffffff;
      background: #3b82f6;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-save:hover {
      background: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .preview-area {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .warning-message {
      background: #fef3c7;
      border: 1px solid #f59e0b;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      color: #92400e;
      font-size: 13px;
      display: none;
    }

    .warning-message.show {
      display: block;
    }

    .preview-content {
      flex: 1;
      margin-bottom: 16px;
    }

    .preview-content textarea {
      width: 100%;
      min-height: 400px;
      padding: 12px;
      font-size: 13px;
      line-height: 1.6;
      border: 1px solid #cbd5e0;
      border-radius: 8px;
      background: #ffffff;
      color: #2d3748;
      resize: vertical;
      font-family: 'Courier New', monospace;
    }

    .preview-content textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .btn-copy {
      width: 100%;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 600;
      color: #ffffff;
      background: #10b981;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-copy:hover {
      background: #059669;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .btn-copy:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #718096;
    }

    .empty-state h3 {
      font-size: 18px;
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 8px;
    }

    .empty-state p {
      font-size: 14px;
      color: #718096;
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #1a202c;
      color: #ffffff;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      font-size: 14px;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
      display: none;
    }

    .toast.show {
      display: block;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @media (max-width: 1200px) {
      .container {
        grid-template-columns: 1fr;
        height: auto;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <!-- ì¢Œì¸¡ ì»¬ëŸ¼: ì‚¬ê³  ì •ë³´ (ì½ê¸° ì „ìš©) -->
  <div class="column">
    <h2>ğŸ“‹ ì‚¬ê³  ì •ë³´</h2>
    <div id="accidentInfo">
      <div class="empty-state">
        <h3>ì ‘ìˆ˜ ê±´ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</h3>
        <p>(ì ‘ìˆ˜ í˜„í™© â†’ ë©”ì‹œì§€ ë³´ë‚´ê¸° ë²„íŠ¼ì„ ì´ìš©í•˜ì„¸ìš”)</p>
      </div>
    </div>
  </div>

  <!-- ì¤‘ì•™ ì»¬ëŸ¼: í…œí”Œë¦¿ ê´€ë¦¬ + ì„ íƒ -->
  <div class="column">
    <h2>ğŸ“ í…œí”Œë¦¿ ê´€ë¦¬</h2>
    
    <!-- ì„¤ëª… ë¬¸êµ¬ -->
    <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 13px; color: #1e40af;">
      â€» ë°œì£¼ì²˜ / ì‹œê³µì  ë©”ì‹œì§€ í…œí”Œë¦¿ì€ ì´ í˜ì´ì§€ì—ì„œ ì§ì ‘ ê´€ë¦¬ë©ë‹ˆë‹¤.
    </div>
    
    <!-- íƒ­ ë²„íŠ¼ -->
    <div class="tab-buttons">
      <button class="tab-button active" onclick="selectTab('ë°œì£¼ì²˜')" id="tabIssuer">
        ë°œì£¼ì²˜ í…œí”Œë¦¿
      </button>
      <button class="tab-button workshop" onclick="selectTab('ì‹œê³µì ')" id="tabWorkshop">
        ì‹œê³µì  í…œí”Œë¦¿
      </button>
    </div>

    <!-- ì‚¬ìš© ê°€ëŠ¥í•œ ë³€ìˆ˜ ëª©ë¡ -->
    <div class="variables-list">
      <h3>ì‚¬ìš© ê°€ëŠ¥í•œ ë³€ìˆ˜</h3>
      <div>
        <code>{{ì ‘ìˆ˜ë²ˆí˜¸}}</code>
        <code>{{ì°¨ëŸ‰ë²ˆí˜¸}}</code>
        <code>{{ì°¨ì¢…}}</code>
        <code>{{VIN}}</code>
        <code>{{ì‘ì—…ë¶€ìœ„}}</code>
        <code>{{ê³ ê°ì£¼ì†Œ}}</code>
        <code>{{ì—°ë½ì²˜}}</code>
        <code>{{HUD}}</code>
        <code>{{ì°¨ìŒìœ ë¦¬}}</code>
        <code>{{ì¹´ë©”ë¼}}</code>
        <code>{{ë ˆì¸ì„¼ì„œ}}</code>
        <code>{{ëŒ€ì¸ì—¬ë¶€}}</code>
        <code>{{ë©´ì±…ê¸ˆì•¡}}</code>
      </div>
    </div>

    <!-- í…œí”Œë¦¿ í¸ì§‘ ì˜ì—­ -->
    <div class="template-editor">
      <textarea id="templateContent" placeholder="í…œí”Œë¦¿ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
    </div>

    <!-- ì €ì¥ ë²„íŠ¼ -->
    <button class="btn-save" onclick="saveTemplate()">
      ğŸ’¾ ì €ì¥í•˜ê¸°
    </button>
  </div>

  <!-- ìš°ì¸¡ ì»¬ëŸ¼: ë©”ì‹œì§€ ìƒì„± ê²°ê³¼ (ë¯¸ë¦¬ë³´ê¸°) -->
  <div class="column">
    <h2>ğŸ‘ï¸ ë©”ì‹œì§€ ë¯¸ë¦¬ë³´ê¸°</h2>
    
    <div class="preview-area">
      <!-- ê²½ê³  ë©”ì‹œì§€ -->
      <div class="warning-message" id="warningMessage">
        âš ï¸ ì¼ë¶€ í•­ëª©ì´ ì¹˜í™˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
      </div>

      <!-- ë¯¸ë¦¬ë³´ê¸° ë‚´ìš© -->
      <div class="preview-content">
        <textarea id="previewContent" readonly placeholder="í…œí”Œë¦¿ì„ ì…ë ¥í•˜ë©´ ë¯¸ë¦¬ë³´ê¸°ê°€ í‘œì‹œë©ë‹ˆë‹¤."></textarea>
      </div>

      <!-- ë³µì‚¬ ë²„íŠ¼ -->
      <button class="btn-copy" onclick="copyMessage()" id="btnCopy" disabled>
        ğŸ“‹ ë³µì‚¬í•˜ê¸°
      </button>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="/js/supabaseclient.js"></script>

<script>
// í…œí”Œë¦¿ íƒ€ì… ìƒìˆ˜
const TEMPLATE_TYPE = {
  ISSUER: 'ë°œì£¼ì²˜',
  WORKSHOP: 'ì‹œê³µì '
};

let currentAccidentData = null;
let currentTemplateType = TEMPLATE_TYPE.ISSUER;
let templateData = {};

// URL íŒŒë¼ë¯¸í„°ì—ì„œ accidentId ê°€ì ¸ì˜¤ê¸°
// URL íŒŒë¼ë¯¸í„° ë˜ëŠ” sessionStorageì—ì„œ accidentId ê°€ì ¸ì˜¤ê¸°
function getUrlParams() {
  const params = new URLSearchParams(window.location.search);
  const urlAccidentId = params.get('accidentId');
  const sessionAccidentId = sessionStorage.getItem('currentAccidentId');
  
  // URL íŒŒë¼ë¯¸í„° ìš°ì„ , ì—†ìœ¼ë©´ sessionStorageì—ì„œ ê°€ì ¸ì˜¤ê¸°
  const accidentId = urlAccidentId || sessionAccidentId;
  
  return {
    accidentId: accidentId
  };
}

// Supabase ëŒ€ê¸° í•¨ìˆ˜
async function waitForSupabase() {
  let attempts = 0;
  const maxAttempts = 50;
  
  while (attempts < maxAttempts) {
    if (window.supabase || window.supabaseClient) {
      return;
    }
    await new Promise(resolve => setTimeout(resolve, 100));
    attempts++;
  }
  
  throw new Error('Supabase client initialization timeout');
}

// ì‚¬ê³  ë°ì´í„° ë¡œë“œ
async function loadAccidentData() {
  const { accidentId } = getUrlParams();
  const accidentInfo = document.getElementById('accidentInfo');

  // accidentIdê°€ ì—†ìœ¼ë©´ ì•ˆë‚´ ë¬¸êµ¬ë§Œ í‘œì‹œ
  if (!accidentId) {
    accidentInfo.innerHTML = `
      <div class="empty-state">
        <h3>ì ‘ìˆ˜ ê±´ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</h3>
        <p>(ì ‘ìˆ˜ í˜„í™© â†’ ë©”ì‹œì§€ ë³´ë‚´ê¸° ë²„íŠ¼ì„ ì´ìš©í•˜ì„¸ìš”)</p>
      </div>
    `;
    return;
  }

  // ë¡œë”© ìƒíƒœ
  accidentInfo.innerHTML = '<div class="empty-state"><p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>';

  try {
    await waitForSupabase();
    const supabase = window.supabase || window.supabaseClient;
    
    if (!supabase) {
      throw new Error('Supabase client not initialized');
    }

    // accidentIdë¡œ ì‚¬ê³  ë°ì´í„° ì¡°íšŒ
    const { data, error } = await supabase
      .from('accident_records')
      .select('*')
      .eq('id', accidentId)
      .eq('is_deleted', false)
      .single();

    if (error) {
      if (error.code === 'PGRST116') {
        throw new Error('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì ‘ìˆ˜ ê±´ì…ë‹ˆë‹¤');
      }
      throw error;
    }

    if (!data) {
      throw new Error('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì ‘ìˆ˜ ê±´ì…ë‹ˆë‹¤');
    }

    currentAccidentData = data;

    // templateData ê°ì²´ ìƒì„±
    templateData = {
      ì ‘ìˆ˜ë²ˆí˜¸: data.receipt_number || data.case_no || '',
      ì°¨ëŸ‰ë²ˆí˜¸: data.car_number || data.car_no || '',
      ì°¨ì¢…: data.car_model || data.vehicle_model || '',
      VIN: data.vin || '',
      ì‘ì—…ë¶€ìœ„: data.damage_part || data.damage_type || '',
      ê³ ê°ì£¼ì†Œ: data.customer_address || data.accident_location || '',
      ì—°ë½ì²˜: data.phone || '',
      HUD: data.hud ? 'ìˆìŒ' : 'ì—†ìŒ',
      ì°¨ìŒìœ ë¦¬: (data.acoustic || data.soundproof) ? 'ìˆìŒ' : 'ì—†ìŒ',
      ì¹´ë©”ë¼: data.camera || 'ì—†ìŒ',
      ë ˆì¸ì„¼ì„œ: data.rain_sensor || data.rain || 'ì—†ìŒ',
      ëŒ€ì¸ì—¬ë¶€: data.personal_injury ? 'ìˆìŒ' : 'ì—†ìŒ',
      ë©´ì±…ê¸ˆì•¡: data.deductible || ''
    };

    // ì‚¬ê³  ì •ë³´ í‘œì‹œ
    renderAccidentInfo(data);

    // í…œí”Œë¦¿ ë¡œë“œ
    await loadTemplate(currentTemplateType);

  } catch (error) {
    console.error('ì‚¬ê³  ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:', error);
    accidentInfo.innerHTML = `
      <div class="empty-state">
        <h3>ì˜¤ë¥˜ ë°œìƒ</h3>
        <p>${error.message || 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}</p>
      </div>
    `;
  }
}

// ì‚¬ê³  ì •ë³´ ë Œë”ë§
function renderAccidentInfo(data) {
  const accidentInfo = document.getElementById('accidentInfo');
  
  accidentInfo.innerHTML = `
    <div class="info-group">
      <span class="info-label">ì ‘ìˆ˜ë²ˆí˜¸</span>
      <div class="info-value">${data.receipt_number || data.case_no || '-'}</div>
    </div>
    <div class="info-group">
      <span class="info-label">ì°¨ëŸ‰ë²ˆí˜¸</span>
      <div class="info-value">${data.car_number || data.car_no || '-'}</div>
    </div>
    <div class="info-group">
      <span class="info-label">ì°¨ì¢…</span>
      <div class="info-value">${data.car_model || data.vehicle_model || '-'}</div>
    </div>
    <div class="info-group">
      <span class="info-label">VIN</span>
      <div class="info-value ${!data.vin ? 'empty' : ''}">${data.vin || 'ì—†ìŒ'}</div>
    </div>
    <div class="info-group">
      <span class="info-label">ì‘ì—… ë¶€ìœ„</span>
      <div class="info-value">${data.damage_part || data.damage_type || '-'}</div>
    </div>
    <div class="info-group">
      <span class="info-label">ê³ ê° ì£¼ì†Œ</span>
      <div class="info-value">${data.customer_address || data.accident_location || '-'}</div>
    </div>
    <div class="info-group">
      <span class="info-label">ê³ ê° ì—°ë½ì²˜</span>
      <div class="info-value">${data.phone || '-'}</div>
    </div>
  `;
}

// íƒ­ ì„ íƒ
function selectTab(type) {
  if (type !== TEMPLATE_TYPE.ISSUER && type !== TEMPLATE_TYPE.WORKSHOP) {
    return;
  }

  currentTemplateType = type;

  // íƒ­ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
  const tabIssuer = document.getElementById('tabIssuer');
  const tabWorkshop = document.getElementById('tabWorkshop');
  
  tabIssuer.classList.toggle('active', type === TEMPLATE_TYPE.ISSUER);
  tabWorkshop.classList.toggle('active', type === TEMPLATE_TYPE.WORKSHOP);

  // í…œí”Œë¦¿ ë¡œë“œ
  loadTemplate(type);
}

// í…œí”Œë¦¿ ë¡œë“œ
async function loadTemplate(type) {
  if (!currentAccidentData) {
    return;
  }

  try {
    await waitForSupabase();
    const supabase = window.supabase || window.supabaseClient;
    
    if (!supabase) {
      throw new Error('Supabase client not initialized');
    }

    // message_templates í…Œì´ë¸”ì—ì„œ typeê³¼ ì¼ì¹˜í•˜ëŠ” í…œí”Œë¦¿ ì¡°íšŒ
    const { data, error } = await supabase
      .from('message_templates')
      .select('*')
      .eq('type', type)
      .order('updated_at', { ascending: false })
      .limit(1)
      .maybeSingle();

    if (error) {
      throw error;
    }

    // í…œí”Œë¦¿ contentë¥¼ textareaì— í‘œì‹œ
    const templateContent = document.getElementById('templateContent');
    templateContent.value = data?.content || '';

    // ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ 
    updatePreview();

  } catch (error) {
    console.error('í…œí”Œë¦¿ ë¡œë“œ ì˜¤ë¥˜:', error);
    showToast('error', 'í…œí”Œë¦¿ ë¡œë“œ ì‹¤íŒ¨', error.message || 'í…œí”Œë¦¿ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }
}

// í…œí”Œë¦¿ ì €ì¥
async function saveTemplate() {
  if (!currentAccidentData) {
    showToast('warning', 'ì €ì¥ ì‹¤íŒ¨', 'ì ‘ìˆ˜ ê±´ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }

  const templateContent = document.getElementById('templateContent');
  const content = templateContent.value.trim();

  if (!content) {
    showToast('warning', 'ì €ì¥ ì‹¤íŒ¨', 'í…œí”Œë¦¿ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }

  try {
    await waitForSupabase();
    const supabase = window.supabase || window.supabaseClient;
    
    if (!supabase) {
      throw new Error('Supabase client not initialized');
    }

    // ë™ì¼ typeì€ ì—…ì„œíŠ¸(1ê°œë§Œ ìœ ì§€)
    // ë¨¼ì € ê¸°ì¡´ í…œí”Œë¦¿ í™•ì¸
    const { data: existing } = await supabase
      .from('message_templates')
      .select('id')
      .eq('type', currentTemplateType)
      .maybeSingle();

    if (existing) {
      // ê¸°ì¡´ í…œí”Œë¦¿ ì—…ë°ì´íŠ¸
      const { error } = await supabase
        .from('message_templates')
        .update({
          content: content,
          updated_at: new Date().toISOString()
        })
        .eq('type', currentTemplateType);
      
      if (error) throw error;
    } else {
      // ìƒˆ í…œí”Œë¦¿ ìƒì„±
      const { error } = await supabase
        .from('message_templates')
        .insert({
          type: currentTemplateType,
          content: content,
          updated_at: new Date().toISOString()
        });
      
      if (error) throw error;
    }

    if (error) {
      throw error;
    }

    showToast('success', 'ì €ì¥ ì™„ë£Œ', 'í…œí”Œë¦¿ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    
    // ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ 
    updatePreview();

  } catch (error) {
    console.error('í…œí”Œë¦¿ ì €ì¥ ì˜¤ë¥˜:', error);
    showToast('error', 'ì €ì¥ ì‹¤íŒ¨', error.message || 'í…œí”Œë¦¿ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// í…œí”Œë¦¿ ì ìš© í•¨ìˆ˜
function applyTemplate(template, data) {
  if (!template || !data) {
    return template || '';
  }

  // í† í° ì¹˜í™˜
  let result = template;
  Object.entries(data).forEach(([key, value]) => {
    result = result.replaceAll('{{' + key + '}}', value || '');
  });

  return result;
}

// ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ 
function updatePreview() {
  if (!currentAccidentData) {
    return;
  }

  const templateContent = document.getElementById('templateContent');
  const previewContent = document.getElementById('previewContent');
  const warningMessage = document.getElementById('warningMessage');
  const btnCopy = document.getElementById('btnCopy');

  const template = templateContent.value;
  
  if (!template.trim()) {
    previewContent.value = '';
    warningMessage.classList.remove('show');
    btnCopy.disabled = true;
    return;
  }

  // í…œí”Œë¦¿ ì ìš©
  const result = applyTemplate(template, templateData);

  // {{ }} íŒ¨í„´ì´ ë‚¨ì•„ ìˆëŠ”ì§€ í™•ì¸
  const unresolved = result.match(/{{[^}]+}}/g);
  
  if (unresolved) {
    warningMessage.classList.add('show');
  } else {
    warningMessage.classList.remove('show');
  }

  // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
  previewContent.value = result;
  btnCopy.disabled = false;
}

// í…œí”Œë¦¿ í¸ì§‘ ì‹œ ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ 
document.addEventListener('DOMContentLoaded', () => {
  const templateContent = document.getElementById('templateContent');
  
  // í…œí”Œë¦¿ í¸ì§‘ ì‹œ ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ 
  templateContent.addEventListener('input', () => {
    updatePreview();
  });

  // ì´ˆê¸° ë¡œë“œ
  loadAccidentData();
});

// ë³µì‚¬ ë²„íŠ¼ í´ë¦­
function copyMessage() {
  const previewContent = document.getElementById('previewContent');
  const message = previewContent.value;

  if (!message || message.trim() === '') {
    showToast('warning', 'ë³µì‚¬ ì‹¤íŒ¨', 'ë³µì‚¬í•  ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }

  navigator.clipboard.writeText(message).then(() => {
    showToast('success', 'ë³µì‚¬ ì™„ë£Œ', 'ë©”ì‹œì§€ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
  }).catch(err => {
    console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
    showToast('error', 'ë³µì‚¬ ì‹¤íŒ¨', 'í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  });
}

// Toast ì•Œë¦¼ í‘œì‹œ
function showToast(type, title, message) {
  const toast = document.getElementById('toast');
  if (!toast) return;

  const colors = {
    success: '#10b981',
    error: '#e53e3e',
    warning: '#f59e0b',
    info: '#3b82f6'
  };

  toast.style.background = colors[type] || colors.info;
  toast.textContent = title + ': ' + message;
  toast.classList.add('show');

  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}
</script>

</body>
</html>
