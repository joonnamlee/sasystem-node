<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì ‘ìˆ˜ í˜„í™©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="stylesheet" as="style" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
  
  <!-- XLSX library for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Pretendard, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f7fa;
      color: #2c3e50;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #e1e8ed;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }

    h1 {
      font-size: 24px;
      font-weight: 600;
      color: #1a202c;
    }

    .btn-new {
      padding: 10px 20px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-new:hover {
      background: #2563eb;
      box-shadow: 0 4px 6px rgba(59,130,246,0.3);
    }

    .date-filter-box {
      margin-bottom: 16px;
      padding: 12px;
      background: #f7fafc;
      border-radius: 8px;
      border: 1px solid #e1e8ed;
    }

    .date-filter-row {
      display: flex;
      gap: 12px;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    .date-filter-item {
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex: 1;
      min-width: 150px;
    }

    .date-filter-item label {
      font-size: 13px;
      font-weight: 500;
      color: #4a5568;
    }

    .date-filter-item input {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      outline: none;
      font-family: inherit;
    }

    .date-filter-item input:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
    }

    .btn-filter-clear {
      padding: 8px 16px;
      background: #6b7280;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .btn-filter-clear:hover {
      background: #4b5563;
    }

    .filter-row {
      display: flex;
      gap: 12px;
      align-items: flex-end;
      flex-wrap: wrap;
      margin-bottom: 16px;
      padding: 12px;
      background: #f7fafc;
      border-radius: 8px;
      border: 1px solid #e1e8ed;
    }

    .filter-item {
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex: 1;
      min-width: 150px;
    }

    .filter-item label {
      font-size: 13px;
      font-weight: 500;
      color: #4a5568;
    }

    .filter-item select {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      outline: none;
      font-family: inherit;
      background: white;
      cursor: pointer;
    }

    .filter-item select:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
    }

    .btn-export {
      padding: 8px 16px;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .btn-export:hover {
      background: #059669;
    }

    .search-box {
      margin-bottom: 20px;
      padding: 12px;
      background: #f7fafc;
      border-radius: 8px;
      border: 1px solid #e1e8ed;
    }

    .search-box input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      outline: none;
    }

    .search-box input:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
    }

    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    thead {
      background: #f7fafc;
      border-bottom: 2px solid #e1e8ed;
    }

    th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #4a5568;
      white-space: nowrap;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #e1e8ed;
    }

    tbody tr {
      cursor: pointer;
      transition: background 0.15s;
    }

    tbody tr:hover {
      background: #f7fafc;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
    }

    .status-new {
      background: #e5e7eb;
      color: #374151;
    }

    .status-assigned {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-progress {
      background: #fed7aa;
      color: #9a3412;
    }

    .status-completed {
      background: #d1fae5;
      color: #065f46;
    }

    .status-settled {
      background: #10b981;
      color: white;
    }

    .status-received {
      background: #e5e7eb;
      color: #374151;
    }

    .status-assigned {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-scheduled {
      background: #e9d5ff;
      color: #6b21a8;
    }

    .status-completed {
      background: #d1fae5;
      color: #065f46;
    }

    .status-pending {
      background: #fed7aa;
      color: #9a3412;
    }

    .status-closed {
      background: #4b5563;
      color: white;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #9ca3af;
    }

    .empty-state p {
      font-size: 16px;
      margin-top: 12px;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-top: 20px;
      padding: 16px 0;
    }

    .pagination button {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    .pagination button:hover:not(:disabled) {
      background: #f7fafc;
      border-color: #3b82f6;
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination button.active {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }

    .pagination-info {
      margin: 0 12px;
      font-size: 14px;
      color: #6b7280;
    }

    /* Mobile Styles */
    @media (max-width: 768px) {
      body {
        padding-bottom: 80px;
      }

      .container {
        padding: 12px;
        margin: 0;
        border-radius: 0;
      }

      .header {
        flex-direction: column;
        align-items: stretch;
        margin-bottom: 16px;
      }

      .header h1 {
        font-size: 20px;
      }

      .btn-new {
        width: 100%;
        padding: 14px;
        font-size: 16px;
        margin-bottom: 16px;
      }

      /* í†µê³„ ì¹´ë“œ 1ì—´ ë¦¬ìŠ¤íŠ¸ */
      .stats-cards {
        grid-template-columns: 1fr;
        gap: 12px;
        margin-bottom: 16px;
      }

      .stat-card {
        padding: 16px;
      }

      .stat-card-value {
        font-size: 24px;
      }

      /* í…Œì´ë¸”ì„ ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜ */
      .table-container {
        border: none;
        overflow: visible;
        margin-bottom: 80px;
      }

      table {
        display: none;
      }

      .m-card-list {
        display: block;
      }

      .m-card-item {
        background: white;
        border: 1px solid #e1e8ed;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }

      .m-card-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
        border-bottom: 1px solid #f3f4f6;
      }

      .m-card-row:last-child {
        border-bottom: none;
      }

      .m-card-label {
        font-size: 12px;
        color: #6b7280;
        font-weight: 500;
        min-width: 80px;
      }

      .m-card-value {
        font-size: 14px;
        color: #1a202c;
        text-align: right;
        flex: 1;
      }

      .m-card-header {
        font-size: 16px;
        font-weight: 600;
        color: #1a202c;
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 2px solid #e1e8ed;
      }

      /* í•˜ë‹¨ ê³ ì • ë²„íŠ¼ */
      .m-fixed-actions {
        position: fixed;
        bottom: 56px;
        left: 0;
        right: 0;
        background: white;
        border-top: 1px solid #e1e8ed;
        padding: 12px 16px;
        box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
        z-index: 999;
        display: flex;
        gap: 8px;
      }

      .m-fixed-actions .btn {
        flex: 1;
        padding: 14px;
        font-size: 16px;
        font-weight: 600;
      }

      th, td {
        padding: 8px 6px;
      }

      .mobile-hide {
        display: none;
      }

      .date-filter-box {
        padding: 12px;
        margin-bottom: 16px;
      }

      .date-filter-row {
        flex-direction: column;
        gap: 8px;
      }

      .date-filter-item {
        width: 100%;
      }

      .filters {
        flex-direction: column;
        gap: 8px;
        padding: 12px;
        margin-bottom: 16px;
      }

      .filters > * {
        width: 100%;
      }
    }

    /* Desktop: ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ ìˆ¨ê¸°ê¸° */
    .m-card-list {
      display: none;
    }

    .btn-delete {
      padding: 4px 8px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-delete:hover {
      background: #dc2626;
      transform: scale(1.05);
    }

    .btn-delete:active {
      transform: scale(0.95);
    }

    tbody tr td:last-child {
      cursor: default;
    }

    /* í†µê³„ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .stats-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: white;
      border: 1px solid #e1e8ed;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: all 0.2s;
    }

    .stat-card.clickable-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.15);
      border-color: #3b82f6;
    }

    .stat-card-label {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .stat-card-value {
      font-size: 24px;
      font-weight: 600;
      color: #1a202c;
    }

    /* ìƒíƒœ ë±ƒì§€ í´ë¦­ ê°€ëŠ¥ ìŠ¤íƒ€ì¼ */
    .status-badge.clickable {
      cursor: pointer;
      transition: all 0.2s;
    }

    .status-badge.clickable:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    /* ìƒíƒœ ë³€ê²½ íŒì—… */
    .status-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 1px solid #e1e8ed;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      z-index: 1000;
      min-width: 300px;
    }

    .status-popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }

    .status-popup h3 {
      margin: 0 0 16px 0;
      font-size: 18px;
      font-weight: 600;
    }

    .status-popup-buttons {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }

    .status-popup-buttons button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-status-change {
      background: #3b82f6;
      color: white;
    }

    .btn-status-change:hover {
      background: #2563eb;
    }

    .btn-cancel {
      background: #e5e7eb;
      color: #374151;
    }

    .btn-cancel:hover {
      background: #d1d5db;
    }

    /* ë¹ ë¥¸ í•„í„° ë²„íŠ¼ */
    .quick-filter-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .btn-quick-filter {
      padding: 6px 12px;
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-quick-filter:hover {
      background: #e5e7eb;
      border-color: #9ca3af;
    }

    .btn-quick-filter.active {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }

    /* ìœ„í—˜/ì§€ì—° í‘œì‹œ */
    .row-warning {
      background: #fef3c7 !important;
      border-left: 4px solid #f59e0b;
    }

    .row-danger {
      background: #fee2e2 !important;
      border-left: 4px solid #ef4444;
    }

    .warning-badge {
      display: inline-block;
      padding: 2px 6px;
      background: #f59e0b;
      color: white;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      margin-left: 4px;
    }

    /* í—¤ë” ê³ ì • */
    .table-wrapper {
      position: relative;
      max-height: 600px;
      overflow-y: auto;
    }

    table thead {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #f7fafc;
    }

    /* í† ìŠ¤íŠ¸ ì•Œë¦¼ */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      z-index: 2000;
      animation: slideIn 0.3s ease-out;
    }

    .toast.error {
      background: #ef4444;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Skeleton UI */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s ease-in-out infinite;
      border-radius: 4px;
    }

    @keyframes loading {
      0% {
        background-position: 200% 0;
      }
      100% {
        background-position: -200% 0;
      }
    }

    .skeleton-row {
      height: 48px;
      margin: 8px 0;
    }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>ğŸ“‹ ì ‘ìˆ˜ í˜„í™©</h1>
    <button class="btn-new" onclick="createNew()">â• ì‹ ê·œ ì ‘ìˆ˜ ë§Œë“¤ê¸°</button>
  </div>

  <!-- í†µê³„ ì¹´ë“œ (5ê°œ) -->
  <div class="stats-cards" id="statsCards">
    <div class="stat-card clickable-card" onclick="filterByCard('todayReceived')" style="cursor: pointer;">
      <div class="stat-card-label">ì˜¤ëŠ˜ ì ‘ìˆ˜ ê±´ìˆ˜</div>
      <div class="stat-card-value" id="todayReceivedCount">0</div>
    </div>
    <div class="stat-card clickable-card" onclick="filterByCard('scheduled')" style="cursor: pointer; border-left: 4px solid #e9d5ff;">
      <div class="stat-card-label">ì‹œê³µì˜ˆì • ê±´ìˆ˜</div>
      <div class="stat-card-value" id="scheduledCount">0</div>
    </div>
    <div class="stat-card clickable-card" onclick="filterByCard('completed')" style="cursor: pointer; border-left: 4px solid #d1fae5;">
      <div class="stat-card-label">ì‹œê³µì™„ë£Œ ê±´ìˆ˜</div>
      <div class="stat-card-value" id="completedCount">0</div>
    </div>
    <div class="stat-card clickable-card" onclick="filterByCard('pendingSettlement')" style="cursor: pointer; border-left: 4px solid #fed7aa;">
      <div class="stat-card-label">ì •ì‚°ëŒ€ê¸° ê±´ìˆ˜</div>
      <div class="stat-card-value" id="pendingSettlementCount">0</div>
    </div>
    <div class="stat-card clickable-card" onclick="filterByCard('unclosed')" style="cursor: pointer; border-left: 4px solid #fbbf24;">
      <div class="stat-card-label">ë¯¸ì¢…ê²° ì´ ê±´ìˆ˜</div>
      <div class="stat-card-value" id="unclosedCount">0</div>
    </div>
  </div>

  <div class="date-filter-box">
    <div class="date-filter-row">
      <div class="date-filter-item">
        <label for="startDate">ì‹œì‘ì¼</label>
        <input type="date" id="startDate" onchange="applyAllFilters()" />
      </div>
      <div class="date-filter-item">
        <label for="endDate">ì¢…ë£Œì¼</label>
        <input type="date" id="endDate" onchange="applyAllFilters()" />
      </div>
      <button class="btn-filter-clear" onclick="clearDateFilter()">ì´ˆê¸°í™”</button>
    </div>
  </div>

  <!-- í•„í„° ì˜ì—­ -->
  <div class="filter-row">
    <div class="filter-item">
      <label for="statusFilter">ìƒíƒœ</label>
      <select id="statusFilter" onchange="applyAllFilters()">
        <option value="">ì „ì²´</option>
        <option value="ë¯¸ì •ì‚°">ë¯¸ì •ì‚° (ì •ì‚°ëŒ€ê¸° ì´ì „)</option>
        <option value="ì ‘ìˆ˜ì™„ë£Œ">ì ‘ìˆ˜ì™„ë£Œ</option>
        <option value="ë°°ì •ì™„ë£Œ">ë°°ì •ì™„ë£Œ</option>
        <option value="ì‹œê³µì˜ˆì •">ì‹œê³µì˜ˆì •</option>
        <option value="ì‹œê³µì™„ë£Œ">ì‹œê³µì™„ë£Œ</option>
        <option value="ì •ì‚°ëŒ€ê¸°">ì •ì‚°ëŒ€ê¸°</option>
        <option value="ì •ì‚°ì™„ë£Œ">ì •ì‚°ì™„ë£Œ</option>
        <option value="ì¢…ë£Œ">ì¢…ë£Œ</option>
      </select>
    </div>
    <div class="filter-item">
      <label for="insuranceFilter">ë³´í—˜ì‚¬</label>
      <select id="insuranceFilter" onchange="applyAllFilters()">
        <option value="">ì „ì²´</option>
      </select>
    </div>
    <div class="filter-item">
      <label for="workshopFilter">ì‹œê³µì </label>
      <select id="workshopFilter" onchange="applyAllFilters()">
        <option value="">ì „ì²´</option>
      </select>
    </div>
    <div class="filter-item">
      <label for="managerFilter">ë‹´ë‹¹ì</label>
      <select id="managerFilter" onchange="applyAllFilters()">
        <option value="">ì „ì²´</option>
      </select>
    </div>
    <button class="btn-export" onclick="exportToExcel()">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
  </div>

  <!-- ë¹ ë¥¸ í•„í„° ë²„íŠ¼ -->
  <div class="quick-filter-buttons">
    <button class="btn-quick-filter" onclick="applyQuickFilter('ë¯¸ì •ì‚°')" id="quickFilter-ë¯¸ì •ì‚°">ë¯¸ì •ì‚°ë§Œ ë³´ê¸°</button>
    <button class="btn-quick-filter" onclick="applyQuickFilter('ì˜¤ëŠ˜ì ‘ìˆ˜')" id="quickFilter-ì˜¤ëŠ˜ì ‘ìˆ˜">ì˜¤ëŠ˜ ì ‘ìˆ˜</button>
    <button class="btn-quick-filter" onclick="applyQuickFilter('ì´ë²ˆì£¼ì™„ë£Œ')" id="quickFilter-ì´ë²ˆì£¼ì™„ë£Œ">ì´ë²ˆ ì£¼ ì™„ë£Œ</button>
  </div>

  <div class="search-box">
    <input type="text" id="searchInput" placeholder="ì ‘ìˆ˜ë²ˆí˜¸, ì°¨ëŸ‰ë²ˆí˜¸, ê³ ê°ëª…, ì—°ë½ì²˜ë¡œ ê²€ìƒ‰..." oninput="applyAllFilters()" />
  </div>

  <div class="table-wrapper">
    <table id="recordsTable">
      <thead>
        <tr>
          <th>ì ‘ìˆ˜ë²ˆí˜¸</th>
          <th class="mobile-hide">ì ‘ìˆ˜ì¼ì‹œ</th>
          <th class="mobile-hide">ì°¨ëŸ‰ë²ˆí˜¸</th>
          <th class="mobile-hide">ì°¨ì¢…</th>
          <th class="mobile-hide">ë³´í—˜ì‚¬</th>
          <th class="mobile-hide">ì‹œê³µì </th>
          <th>í˜„ì¬ìƒíƒœ</th>
          <th style="width: 140px;">ì‘ì—…</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <tr>
          <td colspan="8" class="empty-state">
            <p>ì €ì¥ëœ ì ‘ìˆ˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
          </td>
        </tr>
      </tbody>
    </table>
    <!-- Mobile Card List -->
    <div class="m-card-list" id="mAccidentCardList">
      <div style="text-align: center; padding: 40px; color: #9ca3af;">ë¡œë”© ì¤‘...</div>
    </div>
  </div>
  <!-- Mobile Fixed Action Buttons -->
  <div class="m-fixed-actions" id="mFixedActions" style="display: none;">
    <button class="btn-new" onclick="createNew()">â• ì‹ ê·œ ì ‘ìˆ˜ ë§Œë“¤ê¸°</button>
  </div>

  <div class="pagination" id="pagination"></div>
</div>

<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Supabase and API scripts -->
<script src="/js/supabaseclient.js"></script>
<script src="/js/statusConfig.js"></script>
<script src="/js/accidentapi.js" defer></script>
<script>
  // Signal that Supabase is ready (after scripts load)
  document.addEventListener('DOMContentLoaded', () => {
    window.supabaseReady = true;
    window.dispatchEvent(new CustomEvent('supabaseReady'));
  });
</script>

<script>
let currentRecords = []; // í˜„ì¬ í˜ì´ì§€ ë°ì´í„°ë§Œ ë³´ê´€
let currentPage = 1;
let totalCount = 0;
let totalPages = 1;
let startDate = null;
let endDate = null;
let statusFilter = '';
let insuranceFilter = '';
let workshopFilter = '';
let managerFilter = '';
let searchTerm = '';
const pageSize = 30; // ê¸°ë³¸ limit 30
let isLoading = false;

// Normalize text for fuzzy search (remove spaces, dashes, convert to lowercase)
function normalizeText(text) {
  if (!text) return '';
  return String(text).toLowerCase().replace(/[\s\-]/g, '');
}

// Wait for Supabase to be ready
function waitForSupabase() {
  return new Promise((resolve) => {
    // Check if both client and API functions are ready
    const clientReady = (window.supabase || window.supabaseClient) && (window.supabaseReady || window.__supabaseReady);
    const apiReady = window.fetchAccidentRecords || window.loadAllAccidents;
    
    if (clientReady && apiReady) {
      resolve();
      return;
    }
    
    // Wait for supabaseReady event
    window.addEventListener('supabaseReady', () => {
      // Check API functions after client is ready
      if (window.fetchAccidentRecords || window.loadAllAccidents) {
        resolve();
      } else {
        // Wait a bit more for API functions to load (defer script)
        let attempts = 0;
        const checkApi = setInterval(() => {
          attempts++;
          if (window.fetchAccidentRecords || window.loadAllAccidents) {
            clearInterval(checkApi);
            resolve();
          } else if (attempts >= 20) { // 2 seconds max
            clearInterval(checkApi);
            console.warn('API functions not ready after supabaseReady event');
            resolve(); // Still resolve to allow error handling
          }
        }, 100);
      }
    }, { once: true });
    
    // Fallback timeout
    setTimeout(() => {
      const client = window.supabase || window.supabaseClient;
      const api = window.fetchAccidentRecords || window.loadAllAccidents;
      if (client && api) {
        resolve();
      } else {
        console.warn('Supabase client or API functions not ready after timeout');
        resolve(); // Still resolve to allow error handling
      }
    }, 5000);
  });
}

// Load records from Supabase with server-side pagination
async function loadRecords(page = 1, resetFilters = false) {
  if (isLoading) return;
  
  try {
    isLoading = true;
    
    // Wait for Supabase to be ready
    await waitForSupabase();
    
    // Check if API function is available
    if (!window.fetchAccidentRecordsPaginated) {
      throw new Error("Supabase API í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
    }

    // ê¸°ë³¸ ì¡°íšŒ ì¡°ê±´: ê¸°ê°„ ì œí•œ ì—†ìŒ, ì „ì²´ ìƒíƒœ (ì¢…ë£Œ í¬í•¨)
    // ë°ì´í„° í‘œì‹œ ì•ˆì •í™”ë¥¼ ìœ„í•´ ê³¼ë„í•œ ì œí•œ ì œê±°
    const excludeClosed = false; // ì¢…ë£Œ ìƒíƒœë„ í¬í•¨
    const defaultLastDays = null; // ê¸°ê°„ ì œí•œ ì—†ìŒ

    // ì„œë²„ ì‚¬ì´ë“œ í˜ì´ì§€ë„¤ì´ì…˜ ë° í•„í„°ë§
    const result = await window.fetchAccidentRecordsPaginated({
      page: page,
      limit: pageSize,
      status: statusFilter || null,
      startDate: startDate || null,
      endDate: endDate || null,
      insurer: insuranceFilter || null,
      workshop: workshopFilter || null,
      manager: managerFilter || null,
      search: searchTerm || null,
      excludeClosed: excludeClosed,
      defaultLastDays: defaultLastDays
    });

    if (!result || !result.data) {
      currentRecords = [];
      totalCount = 0;
      totalPages = 1;
      return;
    }

    // Convert to internal format
    currentRecords = result.data.map(r => {
      const rawDate = r.incident_date || r.accident_time;
      const dateObj = rawDate ? new Date(rawDate) : null;
      
      return {
        id: r.id || '',
        displayNo: r.case_no || r.receipt_number || '',
        accidentTime: dateObj ? dateObj.toLocaleString('ko-KR', { 
          year: 'numeric', 
          month: '2-digit', 
          day: '2-digit', 
          hour: '2-digit', 
          minute: '2-digit' 
        }) : '',
        accidentDate: dateObj,
        customerName: r.customer_name || '',
        phone: r.phone || '',
        carNumber: r.car_no || r.car_number || '',
        carModel: r.car_model || r.vehicle_model || '',
        accidentLocation: r.accident_location || '',
        insurer: r.insurance || r.insurer || '',
        manager: r.manager || '',
        caseNo: r.case_no || r.receipt_number || '',
        assignedWorkshopName: r.assigned_workshop_name || '',
        assignedWorkshopAddress: r.assigned_workshop_address || '',
        assignedWorkshopPhone: r.assigned_workshop_phone || '',
        status: (r.status && window.normalizeStatus) ? window.normalizeStatus(r.status) : 'ì ‘ìˆ˜ì™„ë£Œ',
        vin: r.vin || '',
        deductible: r.deductible || '',
        deductibleType: r.deductible_type || r.deductible_pay_type || '',
        damageType: r.damage_type || '',
        memo: r.memo || ''
      };
    });
    
    totalCount = result.count || 0;
    totalPages = result.totalPages || 1;
    currentPage = page;

    // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸ (ë³„ë„ API í˜¸ì¶œ í•„ìš” - ì„±ëŠ¥ ê³ ë ¤)
    // updateStatsCards();
    
  } catch (error) {
    console.error('Supabase error:', error);
    console.error('Error details:', JSON.stringify(error, null, 2));
    currentRecords = [];
    totalCount = 0;
    totalPages = 1;
    showToast('ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (error.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"), 'error');
    throw error;
  } finally {
    isLoading = false;
  }
}

// Update filter dropdowns with unique values from database
async function updateFilterDropdowns() {
  try {
    await waitForSupabase();
    const supabase = window.supabase || window.supabaseClient;
    
    if (!supabase) return;

    // ë³´í—˜ì‚¬ ëª©ë¡ ì¡°íšŒ
    const { data: insurersData } = await supabase
      .from('accident_records')
      .select('insurer')
      .eq('is_deleted', false)
      .not('insurer', 'is', null);
    
    const insurers = [...new Set((insurersData || []).map(r => r.insurer).filter(Boolean))].sort();
    const insuranceSelect = document.getElementById('insuranceFilter');
    if (insuranceSelect) {
      const currentValue = insuranceSelect.value;
      insuranceSelect.innerHTML = '<option value="">ì „ì²´</option>';
      insurers.forEach(insurer => {
        const option = document.createElement('option');
        option.value = insurer;
        option.textContent = insurer;
        insuranceSelect.appendChild(option);
      });
      if (currentValue) insuranceSelect.value = currentValue;
    }
    
    // ì‹œê³µì  ëª©ë¡ ì¡°íšŒ
    const { data: workshopsData } = await supabase
      .from('accident_records')
      .select('assigned_workshop_name')
      .eq('is_deleted', false)
      .not('assigned_workshop_name', 'is', null);
    
    const workshops = [...new Set((workshopsData || []).map(r => r.assigned_workshop_name).filter(Boolean))].sort();
    const workshopSelect = document.getElementById('workshopFilter');
    if (workshopSelect) {
      const currentValue = workshopSelect.value;
      workshopSelect.innerHTML = '<option value="">ì „ì²´</option>';
      workshops.forEach(workshop => {
        const option = document.createElement('option');
        option.value = workshop;
        option.textContent = workshop;
        workshopSelect.appendChild(option);
      });
      if (currentValue) workshopSelect.value = currentValue;
    }
    
    // ë‹´ë‹¹ì ëª©ë¡ ì¡°íšŒ
    const { data: managersData } = await supabase
      .from('accident_records')
      .select('manager')
      .eq('is_deleted', false)
      .not('manager', 'is', null);
    
    const managers = [...new Set((managersData || []).map(r => r.manager).filter(Boolean))].sort();
    const managerSelect = document.getElementById('managerFilter');
    if (managerSelect) {
      const currentValue = managerSelect.value;
      managerSelect.innerHTML = '<option value="">ì „ì²´</option>';
      managers.forEach(manager => {
        const option = document.createElement('option');
        option.value = manager;
        option.textContent = manager;
        managerSelect.appendChild(option);
      });
      if (currentValue) managerSelect.value = currentValue;
    }
  } catch (error) {
    console.warn('í•„í„° ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
  }
}

// Legacy function for backward compatibility
async function loadStatusList() {
  const tbody = document.querySelector("#tableBody");
  if (!tbody) {
    console.error("Table body not found");
    return;
  }
  
  // Skeleton UI í‘œì‹œ
  showSkeleton();

  try {
    // í•„í„° ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
    await updateFilterDropdowns();
    
    // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
    await updateStatsCards();
    
    // ê¸°ë³¸ ì¡°íšŒ ì¡°ê±´ìœ¼ë¡œ ë°ì´í„° ë¡œë“œ (ìµœê·¼ 7ì¼, ì¢…ë£Œ ì œì™¸)
    await loadRecords(1, true);
    renderTable();
  } catch (error) {
      tbody.innerHTML = `<tr><td colspan='8' style='text-align:center;padding:20px;color:red;'>ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"}</td></tr>`;
    showToast("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + (error.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"), 'error');
  }
}

// HTML escape helper
function escapeHtml(text) {
  if (!text) return "";
  const div = document.createElement("div");
  div.textContent = text;
  return div.innerHTML;
}

// Wait for both DOM and Supabase to be ready
document.addEventListener("DOMContentLoaded", async () => {
  await waitForSupabase();
  loadStatusList();
});

// í…Œì´ë¸” ë Œë”ë§ (í˜ì´ì§€ë„¤ì´ì…˜ ì ìš©)
let isRendering = false;

function renderTable() {
  if (isRendering) {
    console.warn('[Status] Render already in progress, skipping');
    return;
  }
  
  isRendering = true;
  
  try {
    const tbody = document.getElementById("tableBody");
    if (!tbody) {
      console.warn('[Status] Table body not found');
      return;
    }
    
    if (currentRecords.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="8" class="empty-state">
            <p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
          </td>
        </tr>
      `;
      const cardList = document.getElementById('mAccidentCardList');
      if (cardList) {
        cardList.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      }
      renderPagination();
      updateMobileFixedActions();
      return;
    }

    // í˜„ì¬ í˜ì´ì§€ ë°ì´í„°ë§Œ ë Œë”ë§ (ì„œë²„ì—ì„œ ì´ë¯¸ í˜ì´ì§€ë„¤ì´ì…˜ë¨)
    tbody.innerHTML = currentRecords.map((record, index) => {
      const displayNo = escapeHtml(record.displayNo || ''); // í™”ë©´ í‘œì‹œìš© ì ‘ìˆ˜ë²ˆí˜¸
      const recordId = record.id || ''; // UUID - ìƒì„¸ í˜ì´ì§€ ì¡°íšŒ ê¸°ì¤€
      const caseNo = escapeHtml(record.caseNo || displayNo || ''); // case_no (ìƒì„¸ í˜ì´ì§€ ì´ë™ìš©)
      
      if (!recordId) {
        console.error("[renderTable] ë ˆì½”ë“œ ID(UUID)ê°€ ì—†ìŠµë‹ˆë‹¤:", record);
        return '';
      }
      
      const status = record.status || 'ì ‘ìˆ˜ì™„ë£Œ';
      const canDelete = canDeleteRecord(status);
      
      // ìœ„í—˜/ì§€ì—° í‘œì‹œ í™•ì¸
      const warningInfo = checkWarningConditions(record, status);
      const rowClass = warningInfo.class ? `clickable-row ${warningInfo.class}` : 'clickable-row';
      const warningBadge = warningInfo.message ? `<span class="warning-badge">${warningInfo.message}</span>` : '';
      
      return `
        <tr data-receipt-number="${caseNo}" data-case-no="${caseNo}" data-record-id="${recordId}" data-status="${status}" class="${rowClass}">
          <td>${displayNo}${warningBadge}</td>
          <td class="mobile-hide">${escapeHtml(record.accidentTime || '')}</td>
          <td class="mobile-hide">${escapeHtml(record.carNumber || '')}</td>
          <td class="mobile-hide">${escapeHtml(record.carModel || '')}</td>
          <td class="mobile-hide">${escapeHtml(record.insurer || '')}</td>
          <td class="mobile-hide">${escapeHtml(record.assignedWorkshopName || '')}</td>
          <td onclick="event.stopPropagation(); openStatusChangePopup('${recordId}', '${caseNo}', '${status}')">${renderStatusBadge(status, true)}</td>
          <td class="mobile-hide">${escapeHtml(record.manager || '')}</td>
          <td style="width: 140px; text-align: center;" onclick="event.stopPropagation()">
            <button class="btn-message" onclick="openMessagePage('${recordId}', '${caseNo}', event)" title="ë©”ì‹œì§€ ë³´ë‚´ê¸°" style="margin-right: 4px; padding: 4px 10px; background: #3b82f6; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; white-space: nowrap;">ğŸ’¬ ë©”ì‹œì§€</button>
            ${canDelete ? `<button class="btn-delete" onclick="deleteRecord(${JSON.stringify(recordId)}, event)" title="ì‚­ì œ">ğŸ—‘ï¸</button>` : '<span style="color: #9ca3af; font-size: 12px;">ì‚­ì œë¶ˆê°€</span>'}
          </td>
        </tr>
      `;
    }).join('');

    // ëª¨ë°”ì¼ ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    const cardList = document.getElementById('mAccidentCardList');
    if (cardList) {
      if (currentRecords.length === 0) {
        cardList.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      } else {
        cardList.innerHTML = currentRecords.map((record, index) => {
          const displayNo = escapeHtml(record.displayNo || '');
          const recordId = record.id || '';
          const caseNo = escapeHtml(record.caseNo || displayNo || '');
          const status = record.status || 'ì ‘ìˆ˜ì™„ë£Œ';
          const warningInfo = checkWarningConditions(record, status);
          const warningBadge = warningInfo.message ? `<span class="warning-badge">${warningInfo.message}</span>` : '';
          
          return `
            <div class="m-card-item clickable-row ${warningInfo.class || ''}" 
                 data-receipt-number="${caseNo}" 
                 data-case-no="${caseNo}" 
                 data-record-id="${recordId}" 
                 data-status="${status}"
                 onclick="window.location.href='/pages/accident/index.html?receipt_number=' + encodeURIComponent('${caseNo}')">
              <div class="m-card-header">${displayNo}${warningBadge}</div>
              <div class="m-card-row">
                <span class="m-card-label">ì ‘ìˆ˜ì¼ì‹œ</span>
                <span class="m-card-value">${escapeHtml(record.accidentTime || '')}</span>
              </div>
              <div class="m-card-row">
                <span class="m-card-label">ì°¨ëŸ‰ë²ˆí˜¸</span>
                <span class="m-card-value">${escapeHtml(record.carNumber || '')}</span>
              </div>
              <div class="m-card-row">
                <span class="m-card-label">ì°¨ì¢…</span>
                <span class="m-card-value">${escapeHtml(record.carModel || '')}</span>
              </div>
              <div class="m-card-row">
                <span class="m-card-label">í˜„ì¬ìƒíƒœ</span>
                <span class="m-card-value">${renderStatusBadge(status, true)}</span>
              </div>
              <div style="display: flex; gap: 8px; margin-top: 12px;" onclick="event.stopPropagation()">
                <button class="btn-message" onclick="openMessagePage('${recordId}', '${caseNo}', event)" style="flex: 1; padding: 8px; background: #3b82f6; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">ğŸ’¬ ë©”ì‹œì§€</button>
                ${canDeleteRecord(status) ? `<button class="btn-delete" onclick="deleteRecord(${JSON.stringify(recordId)}, event)" style="flex: 1; padding: 8px; background: #ef4444; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">ğŸ—‘ï¸ ì‚­ì œ</button>` : ''}
              </div>
            </div>
          `;
        }).join('');
      }
    }

    // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
    renderPagination();
    
    // í…Œì´ë¸” í–‰ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    setupRowClickHandlers();
    
    // ëª¨ë°”ì¼ ê³ ì • ë²„íŠ¼ ì—…ë°ì´íŠ¸
    updateMobileFixedActions();
  } finally {
    isRendering = false;
  }
}

// í…Œì´ë¸” í–‰ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì„¤ì •
function setupRowClickHandlers() {
  const tbody = document.getElementById("tableBody");
  if (!tbody) return;
  
  // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
  const rows = tbody.querySelectorAll('.clickable-row');
  rows.forEach(row => {
    // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¥¼ ìœ„í•´ í´ë¡  í›„ ì¬ì¶”ê°€
    const newRow = row.cloneNode(true);
    row.parentNode.replaceChild(newRow, row);
  });
  
  // ìƒˆë¡œìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
  const newRows = tbody.querySelectorAll('.clickable-row');
  newRows.forEach(row => {
    row.addEventListener('click', function(event) {
      // ì‚­ì œ ë²„íŠ¼ ë˜ëŠ” ë©”ì‹œì§€ ë²„íŠ¼ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì „íŒŒ ì¤‘ë‹¨
      if (event.target.closest('.btn-delete') || event.target.closest('.btn-message')) {
        return;
      }
      
      // data-case-no ë˜ëŠ” data-receipt-number ì†ì„±ì—ì„œ ì ‘ìˆ˜ë²ˆí˜¸ ì½ê¸°
      const caseNo = this.dataset.caseNo || this.dataset.receiptNumber;
      
      if (!caseNo || caseNo.trim() === '') {
        console.error("[setupRowClickHandlers] ì ‘ìˆ˜ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤. data-case-no:", caseNo);
        alert("ì ‘ìˆ˜ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      
      console.log("[setupRowClickHandlers] í–‰ í´ë¦­, case_no:", caseNo);
      
      // ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™ (receipt_number íŒŒë¼ë¯¸í„° ì‚¬ìš©)
      const url = '/pages/accident/index.html?receipt_number=' + encodeURIComponent(caseNo);
      console.log("[setupRowClickHandlers] ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™:", url);
      window.location.href = url;
    });
  });
}

// ëª¨ë°”ì¼ ê³ ì • ë²„íŠ¼ ì—…ë°ì´íŠ¸
function updateMobileFixedActions() {
  const isMobile = window.innerWidth <= 768;
  if (!isMobile) return;
  
  const fixedActions = document.getElementById('mFixedActions');
  if (fixedActions) {
    fixedActions.style.display = 'flex';
  }
}

// ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ëª¨ë°”ì¼ ë²„íŠ¼ ì—…ë°ì´íŠ¸
window.addEventListener('resize', () => {
  updateMobileFixedActions();
});

// í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë°”ì¼ ë²„íŠ¼ ì´ˆê¸°í™”
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    updateMobileFixedActions();
  });
} else {
  updateMobileFixedActions();
}

// í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
function renderPagination() {
  const paginationEl = document.getElementById("pagination");
  
  if (totalPages <= 1) {
    paginationEl.innerHTML = '';
    return;
  }

  let html = '';
  
  // ì´ì „ ë²„íŠ¼
  html += `<button onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>ì´ì „</button>`;
  
  // í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼
  const maxVisiblePages = 5;
  let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
  let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
  
  if (endPage - startPage < maxVisiblePages - 1) {
    startPage = Math.max(1, endPage - maxVisiblePages + 1);
  }
  
  if (startPage > 1) {
    html += `<button onclick="goToPage(1)">1</button>`;
    if (startPage > 2) html += `<span class="pagination-info">...</span>`;
  }
  
  for (let i = startPage; i <= endPage; i++) {
    html += `<button onclick="goToPage(${i})" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
  }
  
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) html += `<span class="pagination-info">...</span>`;
    html += `<button onclick="goToPage(${totalPages})">${totalPages}</button>`;
  }
  
  // ë‹¤ìŒ ë²„íŠ¼
  html += `<button onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>ë‹¤ìŒ</button>`;
  
  // ì •ë³´ í‘œì‹œ
  const startIndex = (currentPage - 1) * pageSize + 1;
  const endIndex = Math.min(currentPage * pageSize, totalCount);
  html += `<span class="pagination-info">${startIndex}-${endIndex} / ${totalCount}</span>`;
  
  paginationEl.innerHTML = html;
}

// í˜ì´ì§€ ì´ë™
async function goToPage(page) {
  if (page < 1 || page > totalPages) return;
  if (page === currentPage) return; // ì´ë¯¸ í•´ë‹¹ í˜ì´ì§€ë©´ ìŠ¤í‚µ
  
  showSkeleton();
  await loadRecords(page);
  renderTable();
  // ìŠ¤í¬ë¡¤ to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ìƒíƒœ ê´€ë ¨ í•¨ìˆ˜ëŠ” statusConfig.jsì—ì„œ ì œê³µ
// getStatusClass, getStatusLabel, renderStatusBadge, normalizeStatus ë“±

// ë‚ ì§œ ë²”ìœ„ í•„í„° í•¨ìˆ˜
function filterByDateRange(records, startDate, endDate) {
  if (!startDate || !endDate) return records;
  
  const s = new Date(startDate);
  const e = new Date(endDate);
  e.setHours(23, 59, 59, 999);
  
  return records.filter(r => {
    if (!r.accidentDate) return false;
    const d = new Date(r.accidentDate);
    return d >= s && d <= e;
  });
}

// ìƒíƒœ í•„í„° í•¨ìˆ˜
function filterByStatus(records, status) {
  if (!status) return records;
  
  // ë¯¸ì •ì‚° í•„í„° (ì •ì‚°ëŒ€ê¸° ì´ì „ ìƒíƒœ ì „ì²´)
  if (status === 'ë¯¸ì •ì‚°') {
    const beforeSettlementStatuses = ['ì ‘ìˆ˜ì™„ë£Œ', 'ë°°ì •ì™„ë£Œ', 'ì‹œê³µì˜ˆì •', 'ì‹œê³µì™„ë£Œ'];
    return records.filter(r => {
      const recordStatus = r.status || 'ì ‘ìˆ˜ì™„ë£Œ';
      return beforeSettlementStatuses.includes(recordStatus);
    });
  }
  
  // ìƒˆë¡œìš´ ìƒíƒœ ê°’ê³¼ ê¸°ì¡´ ìƒíƒœ ê°’ ëª¨ë‘ ì§€ì›
  return records.filter(r => {
    const recordStatus = r.status || 'ì ‘ìˆ˜ì™„ë£Œ';
    return recordStatus === status;
  });
}

// ë³´í—˜ì‚¬ í•„í„° í•¨ìˆ˜
function filterByInsurance(records, insurer) {
  if (!insurer) return records;
  return records.filter(r => r.insurer === insurer);
}

// ì‹œê³µì  í•„í„° í•¨ìˆ˜
function filterByWorkshop(records, workshop) {
  if (!workshop) return records;
  return records.filter(r => r.assignedWorkshopName === workshop);
}

// ë‹´ë‹¹ì í•„í„° í•¨ìˆ˜
function filterByManager(records, manager) {
  if (!manager) return records;
  return records.filter(r => r.manager === manager);
}

// í‚¤ì›Œë“œ í•„í„°ë§ í•¨ìˆ˜ (ì ‘ìˆ˜ë²ˆí˜¸, ì°¨ëŸ‰ë²ˆí˜¸, ê³ ê°ëª…, ì—°ë½ì²˜ í†µí•© ê²€ìƒ‰)
function filterByKeyword(records, keyword) {
  if (!keyword) return records;
  const k = keyword.toLowerCase().trim();
  return records.filter(r => {
    const receiptNo = (r.displayNo || r.caseNo || r.receiptNumber || '').toLowerCase();
    const carNumber = (r.carNumber || '').toLowerCase();
    const customerName = (r.customerName || '').toLowerCase();
    const phone = (r.phone || '').toLowerCase();
    
    return receiptNo.includes(k) ||
           carNumber.includes(k) ||
           customerName.includes(k) ||
           phone.includes(k);
  });
}

// í…Œì´ë¸” í•„í„°ë§ (ì„œë²„ ì‚¬ì´ë“œ)
let isFiltering = false;

// ëª¨ë“  í•„í„° ì ìš© (ì„œë²„ ì‚¬ì´ë“œ API í˜¸ì¶œ)
async function applyAllFilters() {
  if (isFiltering || isLoading) return;
  isFiltering = true;
  
  try {
    // Update filter values from UI
    const startDateInput = document.getElementById("startDate");
    const endDateInput = document.getElementById("endDate");
    const statusSelect = document.getElementById("statusFilter");
    const insuranceSelect = document.getElementById("insuranceFilter");
    const workshopSelect = document.getElementById("workshopFilter");
    const managerSelect = document.getElementById("managerFilter");
    const searchInput = document.getElementById("searchInput");
    
    startDate = startDateInput?.value || null;
    endDate = endDateInput?.value || null;
    statusFilter = statusSelect?.value || '';
    insuranceFilter = insuranceSelect?.value || '';
    workshopFilter = workshopSelect?.value || '';
    managerFilter = managerSelect?.value || '';
    searchTerm = searchInput?.value || '';
    
    // í•„í„° ë³€ê²½ ì‹œ ì²« í˜ì´ì§€ë¡œ ì´ë™
    currentPage = 1;
    
    // ë¹ ë¥¸ í•„í„° ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
    updateQuickFilterButtons();
    
    // ì„œë²„ ì‚¬ì´ë“œ API í˜¸ì¶œ
    showSkeleton();
    await loadRecords(1, false);
    
    // ë Œë”ë§
    renderTable();
  } catch (error) {
    console.error('í•„í„° ì ìš© ì¤‘ ì˜¤ë¥˜:', error);
    showToast('í•„í„° ì ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
  } finally {
    isFiltering = false;
  }
}

// ë‚ ì§œ í•„í„° ì´ˆê¸°í™”
async function clearDateFilter() {
  const startDateInput = document.getElementById("startDate");
  const endDateInput = document.getElementById("endDate");
  
  if (startDateInput) startDateInput.value = '';
  if (endDateInput) endDateInput.value = '';
  startDate = null;
  endDate = null;
  
  await applyAllFilters();
}

// HTML ì´ìŠ¤ì¼€ì´í”„
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ì—‘ì…€ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ (ì„œë²„ ì‚¬ì´ë“œ ì „ì²´ ë°ì´í„° ì¡°íšŒ)
async function exportToExcel() {
  // XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ í™•ì¸
  if (typeof XLSX === 'undefined') {
    alert('ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  try {
    // ë¡œë”© í‘œì‹œ
    const exportBtn = document.querySelector('.btn-export');
    let originalText = '';
    if (exportBtn) {
      originalText = exportBtn.textContent || '';
      exportBtn.disabled = true;
      exportBtn.textContent = 'â³ ì—‘ì…€ ìƒì„± ì¤‘...';
    }
    
    showToast('ì—‘ì…€ íŒŒì¼ì„ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...');
    
    // Wait for Supabase to be ready
    await waitForSupabase();
    
    // Check if API function is available
    if (!window.fetchAccidentRecordsForExport) {
      throw new Error("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ API í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }

    // ì„œë²„ì—ì„œ ì „ì²´ í•„í„° ì¡°ê±´ì„ ê¸°ì¤€ìœ¼ë¡œ ì „ì²´ ë°ì´í„° ì¡°íšŒ
    const allData = await window.fetchAccidentRecordsForExport({
      status: statusFilter || null,
      startDate: startDate || null,
      endDate: endDate || null,
      insurer: insuranceFilter || null,
      workshop: workshopFilter || null,
      manager: managerFilter || null,
      search: searchTerm || null
    });

    if (!allData || allData.length === 0) {
      alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    // ë°ì´í„° ì¤€ë¹„ - ì „ì²´ í•„ë“œ í¬í•¨
    const data = allData.map(r => {
      const rawDate = r.incident_date || r.accident_time;
      const dateObj = rawDate ? new Date(rawDate) : null;
      const accidentTime = dateObj ? dateObj.toLocaleString('ko-KR', { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit', 
        hour: '2-digit', 
        minute: '2-digit' 
      }) : '';
      
      return {
        'ì ‘ìˆ˜ë²ˆí˜¸': r.case_no || r.receipt_number || '',
        'ì ‘ìˆ˜ì¼ì‹œ': accidentTime,
        'ê³ ê°ëª…': r.customer_name || '',
        'ì—°ë½ì²˜': r.phone || '',
        'ì°¨ëŸ‰ë²ˆí˜¸': r.car_no || r.car_number || '',
        'VIN': r.vin || '',
        'ì°¨ì¢…': r.car_model || r.vehicle_model || '',
        'ë³´í—˜ì‚¬': r.insurance || r.insurer || '',
        'ë©´ì±…ê¸ˆ': r.deductible || '',
        'ë©´ì±…ê¸ˆë‚©ë¶€ë°©ì‹': r.deductible_type || r.deductible_pay_type || '',
        'íŒŒì†ìœ í˜•': r.damage_type || '',
        'ì‚¬ê³ ìœ„ì¹˜': r.accident_location || '',
        'ë‹´ë‹¹ì': r.manager || '',
        'ë°°ì • ì‹œê³µì ëª…': r.assigned_workshop_name || '',
        'ë°°ì • ì‹œê³µì  ì£¼ì†Œ': r.assigned_workshop_address || '',
        'ë°°ì • ì‹œê³µì  ì „í™”ë²ˆí˜¸': r.assigned_workshop_phone || '',
        'í˜„ì¬ìƒíƒœ': r.status || '',
        'ë¹„ê³ ': r.memo || ''
      };
    });
    
    // ì›Œí¬ë¶ ìƒì„±
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'ì ‘ìˆ˜í˜„í™©');
    
    // íŒŒì¼ëª… ìƒì„± (í˜„ì¬ ë‚ ì§œ í¬í•¨)
    const now = new Date();
    const dateStr = now.toISOString().split('T')[0].replace(/-/g, '');
    const filename = `ì ‘ìˆ˜í˜„í™©_${dateStr}.xlsx`;
    
    // ë‹¤ìš´ë¡œë“œ
    XLSX.writeFile(wb, filename);
    
    showToast('ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
  } catch (error) {
    console.error('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
    showToast('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (error.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"), 'error');
  } finally {
    // ë²„íŠ¼ ë³µì›
    const exportBtn = document.querySelector('.btn-export');
    if (exportBtn) {
      exportBtn.disabled = false;
      exportBtn.textContent = originalText || 'ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ';
    }
  }
}

// ìƒì„¸ í˜ì´ì§€ ì—´ê¸° (receipt_number ê¸°ì¤€)
function openDetail(receiptNumber) {
  console.log("[openDetail] í•¨ìˆ˜ í˜¸ì¶œë¨, receiptNumber:", receiptNumber);
  
  // receiptNumberëŠ” ì ‘ìˆ˜ë²ˆí˜¸ (display_no, case_no, receipt_number ë“±)
  if (!receiptNumber || receiptNumber === 'undefined' || receiptNumber === 'null' || receiptNumber === '') {
    console.error("[openDetail] ì ‘ìˆ˜ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤. receiptNumber:", receiptNumber);
    alert("ì ‘ìˆ˜ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  
  // ì§ì ‘ í˜ì´ì§€ ì´ë™ (receipt_numberë¥¼ ì¿¼ë¦¬ìŠ¤íŠ¸ë§ìœ¼ë¡œ ì „ë‹¬)
  const url = '/pages/accident/index.html?receipt_number=' + encodeURIComponent(receiptNumber);
  console.log("[openDetail] ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™:", url);
  window.location.href = url;
}

// ì‹ ê·œ ì ‘ìˆ˜ ë§Œë“¤ê¸°
function createNew() {
  // ë¶€ëª¨ í”„ë ˆì„ìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
  if (window.parent && window.parent !== window) {
    window.parent.postMessage({ type: 'openAccidentNew' }, '*');
  } else {
    window.location.href = '/pages/accident/index.html';
  }
}

// ê¸°ë³¸ ì •ë ¬ ìˆœì„œ í•¨ìˆ˜ (ìƒíƒœ ê¸°ì¤€ ìš°ì„  ì •ë ¬)
function sortByDefaultOrder(records) {
  const statusOrder = {
    'ì •ì‚°ëŒ€ê¸°': 1,
    'ì‹œê³µì™„ë£Œ': 2,
    'ì‹œê³µì˜ˆì •': 3,
    'ë°°ì •ì™„ë£Œ': 4,
    'ì ‘ìˆ˜ì™„ë£Œ': 5,
    'ì¢…ë£Œ': 6,
    'ì •ì‚°ì™„ë£Œ': 7
  };
  
  return [...records].sort((a, b) => {
    const statusA = a.status || 'ì ‘ìˆ˜ì™„ë£Œ';
    const statusB = b.status || 'ì ‘ìˆ˜ì™„ë£Œ';
    const orderA = statusOrder[statusA] || 99;
    const orderB = statusOrder[statusB] || 99;
    
    if (orderA !== orderB) {
      return orderA - orderB;
    }
    
    // ê°™ì€ ìš°ì„ ìˆœìœ„ë©´ ìµœì‹ ìˆœ
    const dateA = a.accidentDate ? new Date(a.accidentDate).getTime() : 0;
    const dateB = b.accidentDate ? new Date(b.accidentDate).getTime() : 0;
    return dateB - dateA;
  });
}

// ì‹¤ì œ DB status ê°’ ì¡°íšŒ (ë””ë²„ê¹…ìš©)
async function checkDatabaseStatusValues() {
  try {
    await waitForSupabase();
    const supabase = window.supabase || window.supabaseClient;
    
    if (!supabase) return;

    // DISTINCT status ê°’ ì¡°íšŒ
    const { data: statusData, error } = await supabase
      .from('accident_records')
      .select('status')
      .eq('is_deleted', false);

    if (error) {
      console.error('Status ì¡°íšŒ ì˜¤ë¥˜:', error);
      return;
    }

    // ê³ ìœ  status ê°’ ì¶”ì¶œ
    const uniqueStatuses = [...new Set(statusData.map(r => r.status).filter(s => s))];
    console.log('=== ì‹¤ì œ DB Status ê°’ ëª©ë¡ ===');
    console.log('ì´ ë ˆì½”ë“œ ìˆ˜:', statusData.length);
    console.log('ê³ ìœ  Status ê°’:', uniqueStatuses);
    console.log('Statusë³„ ê°œìˆ˜:');
    const statusCounts = {};
    statusData.forEach(r => {
      const s = r.status || '(NULL)';
      statusCounts[s] = (statusCounts[s] || 0) + 1;
    });
    console.table(statusCounts);

    // ENUM ì •ì˜ì™€ ë¹„êµ
    const enumStatuses = ['ì ‘ìˆ˜ì™„ë£Œ', 'ë°°ì •ì™„ë£Œ', 'ì‹œê³µì˜ˆì •', 'ì‹œê³µì™„ë£Œ', 'ì •ì‚°ëŒ€ê¸°', 'ì •ì‚°ì™„ë£Œ', 'ì¢…ë£Œ'];
    const unknownStatuses = uniqueStatuses.filter(s => !enumStatuses.includes(s));
    if (unknownStatuses.length > 0) {
      console.warn('âš ï¸ ENUM ì •ì˜ì™€ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” Status ê°’:', unknownStatuses);
    } else {
      console.log('âœ… ëª¨ë“  Status ê°’ì´ ENUM ì •ì˜ì™€ ì¼ì¹˜í•©ë‹ˆë‹¤.');
    }

    return { uniqueStatuses, statusCounts, unknownStatuses };
  } catch (error) {
    console.error('Status ê°’ ì¡°íšŒ ì‹¤íŒ¨:', error);
  }
}

// í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸ (ì„œë²„ ì‚¬ì´ë“œ ì§‘ê³„)
async function updateStatsCards() {
  try {
    await waitForSupabase();
    const supabase = window.supabase || window.supabaseClient;
    
    if (!supabase) return;

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);

    // ì˜¤ëŠ˜ ì ‘ìˆ˜ëœ ê±´
    const { count: todayReceived } = await supabase
      .from('accident_records')
      .select('*', { count: 'exact', head: true })
      .eq('is_deleted', false)
      .gte('incident_date', today.toISOString())
      .lt('incident_date', tomorrow.toISOString());

    // ì‹œê³µì˜ˆì • ê±´ìˆ˜
    const { count: scheduled } = await supabase
      .from('accident_records')
      .select('*', { count: 'exact', head: true })
      .eq('is_deleted', false)
      .eq('status', 'ì‹œê³µì˜ˆì •');

    // ì‹œê³µì™„ë£Œ ê±´ìˆ˜
    const { count: completed } = await supabase
      .from('accident_records')
      .select('*', { count: 'exact', head: true })
      .eq('is_deleted', false)
      .eq('status', 'ì‹œê³µì™„ë£Œ');

    // ì •ì‚°ëŒ€ê¸° ê±´
    const { count: pendingSettlement } = await supabase
      .from('accident_records')
      .select('*', { count: 'exact', head: true })
      .eq('is_deleted', false)
      .eq('status', 'ì •ì‚°ëŒ€ê¸°');

    // ë¯¸ì¢…ê²° ì´ ê±´ìˆ˜ (ì¢…ë£Œ, ì •ì‚°ì™„ë£Œ ì œì™¸)
    const { count: unclosed } = await supabase
      .from('accident_records')
      .select('*', { count: 'exact', head: true })
      .eq('is_deleted', false)
      .in('status', ['ì ‘ìˆ˜ì™„ë£Œ', 'ë°°ì •ì™„ë£Œ', 'ì‹œê³µì˜ˆì •', 'ì‹œê³µì™„ë£Œ', 'ì •ì‚°ëŒ€ê¸°']);

    document.getElementById('todayReceivedCount').textContent = todayReceived || 0;
    document.getElementById('scheduledCount').textContent = scheduled || 0;
    document.getElementById('completedCount').textContent = completed || 0;
    document.getElementById('pendingSettlementCount').textContent = pendingSettlement || 0;
    document.getElementById('unclosedCount').textContent = unclosed || 0;
  } catch (error) {
    console.warn('í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
  }
}

// ì¹´ë“œ í´ë¦­ ì‹œ í•„í„°ë§
async function filterByCard(cardType) {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  // ê¸°ì¡´ í•„í„° ì´ˆê¸°í™”
  document.getElementById('statusFilter').value = '';
  document.getElementById('startDate').value = '';
  document.getElementById('endDate').value = '';
  
  switch(cardType) {
    case 'todayReceived':
      document.getElementById('startDate').value = today.toISOString().split('T')[0];
      document.getElementById('endDate').value = today.toISOString().split('T')[0];
      break;
    case 'scheduled':
      document.getElementById('statusFilter').value = 'ì‹œê³µì˜ˆì •';
      break;
    case 'completed':
      document.getElementById('statusFilter').value = 'ì‹œê³µì™„ë£Œ';
      break;
    case 'pendingSettlement':
      document.getElementById('statusFilter').value = 'ì •ì‚°ëŒ€ê¸°';
      break;
    case 'unclosed':
      // ë¯¸ì¢…ê²°ì€ ìƒíƒœ í•„í„°ë¡œëŠ” í‘œí˜„ ë¶ˆê°€, ê²€ìƒ‰ìœ¼ë¡œ ì²˜ë¦¬
      break;
  }
  
  await applyAllFilters();
  showToast('í•„í„°ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// ë¹ ë¥¸ í•„í„° ì ìš©
async function applyQuickFilter(filterType) {
  // í˜„ì¬ í™œì„±í™”ëœ ë²„íŠ¼ í™•ì¸
  const currentActive = document.querySelector('.btn-quick-filter.active');
  const isAlreadyActive = currentActive && currentActive.id === `quickFilter-${filterType}`;
  
  // ëª¨ë“  ë¹ ë¥¸ í•„í„° ë²„íŠ¼ ë¹„í™œì„±í™”
  document.querySelectorAll('.btn-quick-filter').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // ê°™ì€ ë²„íŠ¼ì„ ë‹¤ì‹œ í´ë¦­í•˜ë©´ í•„í„° í•´ì œ, ì•„ë‹ˆë©´ í™œì„±í™”
  if (isAlreadyActive) {
    // í•„í„° í•´ì œ
    document.getElementById('statusFilter').value = '';
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    await applyAllFilters();
    showToast('í•„í„°ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    return;
  }
  
  // ì„ íƒí•œ ë²„íŠ¼ í™œì„±í™”
  const btn = document.getElementById(`quickFilter-${filterType}`);
  if (btn) {
    btn.classList.add('active');
  }
  
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  // ê¸°ì¡´ í•„í„° ì´ˆê¸°í™”
  document.getElementById('statusFilter').value = '';
  document.getElementById('startDate').value = '';
  document.getElementById('endDate').value = '';
  
  switch(filterType) {
    case 'ë¯¸ì •ì‚°':
      document.getElementById('statusFilter').value = 'ë¯¸ì •ì‚°';
      break;
    case 'ì˜¤ëŠ˜ì ‘ìˆ˜':
      document.getElementById('startDate').value = today.toISOString().split('T')[0];
      document.getElementById('endDate').value = today.toISOString().split('T')[0];
      break;
    case 'ì´ë²ˆì£¼ì™„ë£Œ':
      const weekStart = new Date(today);
      weekStart.setDate(today.getDate() - today.getDay()); // ì´ë²ˆ ì£¼ ì›”ìš”ì¼
      document.getElementById('startDate').value = weekStart.toISOString().split('T')[0];
      document.getElementById('endDate').value = today.toISOString().split('T')[0];
      document.getElementById('statusFilter').value = 'ì‹œê³µì™„ë£Œ';
      break;
  }
  
  await applyAllFilters();
  showToast('ë¹ ë¥¸ í•„í„°ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// ë¹ ë¥¸ í•„í„° ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
function updateQuickFilterButtons() {
  // ëª¨ë“  ë¹ ë¥¸ í•„í„° ë²„íŠ¼ ë¹„í™œì„±í™”
  document.querySelectorAll('.btn-quick-filter').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // í˜„ì¬ í•„í„° ìƒíƒœì— ë”°ë¼ ë²„íŠ¼ í™œì„±í™”
  const statusFilter = document.getElementById('statusFilter')?.value || '';
  const startDate = document.getElementById('startDate')?.value || '';
  const endDate = document.getElementById('endDate')?.value || '';
  
  const today = new Date().toISOString().split('T')[0];
  const weekStart = new Date();
  weekStart.setDate(weekStart.getDate() - weekStart.getDay());
  const weekStartStr = weekStart.toISOString().split('T')[0];
  
  if (statusFilter === 'ë¯¸ì •ì‚°') {
    document.getElementById('quickFilter-ë¯¸ì •ì‚°')?.classList.add('active');
  } else if (startDate === today && endDate === today) {
    document.getElementById('quickFilter-ì˜¤ëŠ˜ì ‘ìˆ˜')?.classList.add('active');
  } else if (startDate === weekStartStr && endDate === today && statusFilter === 'ì‹œê³µì™„ë£Œ') {
    document.getElementById('quickFilter-ì´ë²ˆì£¼ì™„ë£Œ')?.classList.add('active');
  }
}

// ì‚­ì œ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
function canDeleteRecord(status) {
  const cannotDeleteStatuses = ['ì •ì‚°ëŒ€ê¸°', 'ì •ì‚°ì™„ë£Œ', 'ì¢…ë£Œ'];
  return !cannotDeleteStatuses.includes(status);
}

// ìƒíƒœ ë³€ê²½ íŒì—… ì—´ê¸°
function openStatusChangePopup(recordId, caseNo, currentStatus) {
  const STATUS_ORDER = ['ì ‘ìˆ˜ì™„ë£Œ', 'ë°°ì •ì™„ë£Œ', 'ì‹œê³µì˜ˆì •', 'ì‹œê³µì™„ë£Œ', 'ì •ì‚°ëŒ€ê¸°', 'ì •ì‚°ì™„ë£Œ', 'ì¢…ë£Œ'];
  const currentIndex = STATUS_ORDER.indexOf(currentStatus);
  const nextStatus = STATUS_ORDER[currentIndex + 1];
  
  if (!nextStatus) {
    alert('ë” ì´ìƒ ë³€ê²½í•  ìˆ˜ ìˆëŠ” ìƒíƒœê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  // íŒì—… ì˜¤ë²„ë ˆì´ ìƒì„±
  const overlay = document.createElement('div');
  overlay.className = 'status-popup-overlay';
  overlay.onclick = () => closeStatusChangePopup(overlay);
  
  // íŒì—… ìƒì„±
  const popup = document.createElement('div');
  popup.className = 'status-popup';
  popup.innerHTML = `
    <h3>ìƒíƒœ ë³€ê²½</h3>
    <p style="margin-bottom: 12px; color: #6b7280;">í˜„ì¬ ìƒíƒœ: <strong>${currentStatus}</strong></p>
    <p style="margin-bottom: 16px; color: #6b7280;">ë³€ê²½í•  ìƒíƒœ: <strong>${nextStatus}</strong></p>
    <div class="status-popup-buttons">
      <button class="btn-status-change" onclick="confirmStatusChange('${recordId}', '${caseNo}', '${currentStatus}', '${nextStatus}', this.closest('.status-popup-overlay'))">ë³€ê²½</button>
      <button class="btn-cancel" onclick="closeStatusChangePopup(this.closest('.status-popup-overlay'))">ì·¨ì†Œ</button>
    </div>
  `;
  
  overlay.appendChild(popup);
  document.body.appendChild(overlay);
}

// ìƒíƒœ ë³€ê²½ íŒì—… ë‹«ê¸°
function closeStatusChangePopup(overlay) {
  if (overlay) {
    overlay.remove();
  }
}

// ìœ„í—˜/ì§€ì—° ì¡°ê±´ í™•ì¸
function checkWarningConditions(record, status) {
  const now = new Date();
  const result = { class: '', message: '' };
  
  if (!record.accidentDate) return result;
  
  const accidentDate = new Date(record.accidentDate);
  const hoursSinceAccident = (now - accidentDate) / (1000 * 60 * 60);
  
  // ì ‘ìˆ˜ í›„ 24ì‹œê°„ ì´ìƒ ìƒíƒœ ë³€ê²½ ì—†ìŒ
  if (status === 'ì ‘ìˆ˜ì™„ë£Œ' && hoursSinceAccident >= 24) {
    result.class = 'row-warning';
    result.message = '24h+';
    return result;
  }
  
  // ì‹œê³µì  ë¯¸ë°°ì • ìƒíƒœ 12ì‹œê°„ ì´ˆê³¼
  if ((status === 'ì ‘ìˆ˜ì™„ë£Œ' || status === 'ë°°ì •ì™„ë£Œ') && !record.assignedWorkshopName && hoursSinceAccident >= 12) {
    result.class = 'row-danger';
    result.message = 'ë¯¸ë°°ì •';
    return result;
  }
  
  // ì‹œê³µì™„ë£Œ í›„ 3ì¼ ì´ìƒ ì •ì‚°ëŒ€ê¸°
  if (status === 'ì •ì‚°ëŒ€ê¸°') {
    // ì‹œê³µì™„ë£Œ ìƒíƒœ ë³€ê²½ ì´ë ¥ì„ í™•ì¸í•´ì•¼ í•˜ì§€ë§Œ, ê°„ë‹¨íˆ ì ‘ìˆ˜ì¼ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
    const daysSinceAccident = hoursSinceAccident / 24;
    if (daysSinceAccident >= 3) {
      result.class = 'row-warning';
      result.message = '3ì¼+';
      return result;
    }
  }
  
  return result;
}

// í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ
function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast ${type === 'error' ? 'error' : ''}`;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideIn 0.3s ease-out reverse';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// Skeleton UI í‘œì‹œ
function showSkeleton() {
  const tbody = document.getElementById("tableBody");
  if (!tbody) return;
  
  tbody.innerHTML = Array(10).fill(0).map(() => `
    <tr>
      <td><div class="skeleton skeleton-row"></div></td>
      <td><div class="skeleton skeleton-row"></div></td>
      <td><div class="skeleton skeleton-row"></div></td>
      <td><div class="skeleton skeleton-row"></div></td>
      <td><div class="skeleton skeleton-row"></div></td>
      <td><div class="skeleton skeleton-row"></div></td>
      <td><div class="skeleton skeleton-row"></div></td>
      <td><div class="skeleton skeleton-row"></div></td>
    </tr>
  `).join('');
}

// ìƒíƒœ ë³€ê²½ í™•ì¸
async function confirmStatusChange(recordId, caseNo, oldStatus, newStatus, overlay) {
  if (!window.supabaseClient) {
    alert('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  try {
    await waitForSupabase();
    
    // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const { data: { user }, error: userError } = await window.supabaseClient.auth.getUser();
    if (userError || !user) {
      alert('ë¡œê·¸ì¸í•œ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    // status_priority ê³„ì‚° (statusConfig.jsì˜ ACCIDENT_STATUS_PRIORITY ì‚¬ìš©)
    const statusPriority = (window.ACCIDENT_STATUS_PRIORITY && window.ACCIDENT_STATUS_PRIORITY[newStatus]) || 5;
    
    // accident_records.status UPDATE (status_priorityë„ í•¨ê»˜ ì—…ë°ì´íŠ¸)
    const { error: updateError } = await window.supabaseClient
      .from('accident_records')
      .update({ 
        status: newStatus,
        status_priority: statusPriority
      })
      .eq('id', recordId);
    
    if (updateError) {
      console.error("ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", updateError);
      alert("ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: " + updateError.message);
      return;
    }
    
    // accident_status_logs í…Œì´ë¸”ì— ë³€ê²½ ë¡œê·¸ INSERT
    const { error: logError } = await window.supabaseClient
      .from('accident_status_logs')
      .insert({
        case_no: caseNo,
        before_status: oldStatus,
        after_status: newStatus,
        changed_by: user.id
      });
    
    if (logError) {
      console.warn("ìƒíƒœ ë³€ê²½ ì´ë ¥ ë¡œê·¸ ì €ì¥ ì‹¤íŒ¨:", logError);
    }
    
    // íŒì—… ë‹«ê¸°
    closeStatusChangePopup(overlay);
    
    // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
    await loadRecords();
    applyAllFilters();
    
    showToast(`ìƒíƒœê°€ "${newStatus}"ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
  } catch (error) {
    console.error("ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜:", error);
    alert("ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + (error.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
  }
}

// ë©”ì‹œì§€ ë³´ë‚´ê¸° í˜ì´ì§€ë¡œ ì´ë™
// ì ‘ìˆ˜ í˜„í™© ë¦¬ìŠ¤íŠ¸ì˜ "ë©”ì‹œì§€ ë³´ë‚´ê¸°" ë²„íŠ¼ í´ë¦­ ì‹œ
// ë©”ì‹œì§€ ìƒì„±ì€ ë³„ë„ì˜ í˜ì´ì§€ë¡œ ë¶„ë¦¬
function openMessagePage(recordId, caseNo, event) {
  if (event) {
    event.stopPropagation(); // í–‰ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€
  }
  
  if (!recordId) {
    alert('ì‚¬ê³  IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  // ë©”ì‹œì§€ ìƒì„± í˜ì´ì§€ë¡œ ì´ë™
  // /pages/message/?accidentId=xxx
  const url = `/pages/message/index.html?accidentId=${encodeURIComponent(recordId)}`;
  
  // iframe ë‚´ë¶€ì¸ ê²½ìš° ë¶€ëª¨ ì°½ì—ì„œ ì´ë™
  if (window.parent && window.parent !== window) {
    window.parent.location.href = url;
  } else {
    // ì§ì ‘ í˜ì´ì§€ ì´ë™
    window.location.href = url;
  }
}

// ë ˆì½”ë“œ ì‚­ì œ í•¨ìˆ˜
async function deleteRecord(recordId, event) {
  if (event) {
    event.stopPropagation(); // í–‰ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€
  }
  
  if (!recordId) {
    alert("ì‚­ì œí•  ë ˆì½”ë“œ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  
  // ì‚­ì œ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
  const record = allRecords.find(r => r.id === recordId);
  if (!record) {
    alert("ë ˆì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  
  if (!canDeleteRecord(record.status)) {
    alert(`"${record.status}" ìƒíƒœì¸ ì‚¬ê³ ëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì •ì‚°ëŒ€ê¸° ì´ìƒ ìƒíƒœì˜ ì‚¬ê³ ëŠ” ì‚­ì œê°€ ì œí•œë©ë‹ˆë‹¤.`);
    return;
  }
  
  if (!window.confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì‚­ì œ í›„ ë³µêµ¬ ê°€ëŠ¥)")) {
    return;
  }
  
  try {
    await waitForSupabase();
    
    if (!window.deleteAccidentRecord) {
      throw new Error("ì‚­ì œ í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
    }
    
    await window.deleteAccidentRecord(recordId);
    
    showToast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
    
    // í˜„ì¬ í˜ì´ì§€ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
    await loadRecords(currentPage);
    renderTable();
    
    // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
    await updateStatsCards();
    
  } catch (error) {
    console.error("ì‚­ì œ ì˜¤ë¥˜:", error);
    showToast("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + (error.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"), 'error');
  }
}

// ì´ˆê¸°í™” (í•œ ë²ˆë§Œ ì‹¤í–‰)
let isInitialized = false;

(async function() {
  if (isInitialized) {
    console.warn('[Status] Already initialized, skipping');
    return;
  }
  isInitialized = true;
  
  // í•„í„° ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
  await updateFilterDropdowns();
  
  // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
  await updateStatsCards();
  
  // ë””ë²„ê¹…: ì‹¤ì œ DB status ê°’ í™•ì¸
  await checkDatabaseStatusValues();
  
  // ê¸°ë³¸ ì¡°íšŒ ì¡°ê±´ìœ¼ë¡œ ë°ì´í„° ë¡œë“œ (ì„ì‹œ: ì¡°ê±´ ì—†ìŒ)
  await loadRecords(1, true);
  renderTable();
  
  // ë””ë²„ê¹…: ë¡œë“œëœ ë°ì´í„° í™•ì¸
  console.log('=== ë¡œë“œëœ ë°ì´í„° í™•ì¸ ===');
  console.log('currentRecords ê°œìˆ˜:', currentRecords.length);
  console.log('totalCount:', totalCount);
  console.log('currentPage:', currentPage);
  console.log('totalPages:', totalPages);
  if (currentRecords.length > 0) {
    console.log('ì²« ë²ˆì§¸ ë ˆì½”ë“œ ìƒ˜í”Œ:', currentRecords[0]);
  }
  
  // Supabase ì‹¤ì‹œê°„ êµ¬ë… ì„¤ì • (ë Œë”ë§ í›„)
  if (!window.supabaseClient) {
    return;
  }
  
  const client = window.supabaseClient;
  if (client) {
    let isReloading = false;
    client
      .channel('accidents-changes')
      .on('postgres_changes', 
        { event: '*', schema: 'public', table: 'accident_records' },
        async (payload) => {
          if (isReloading) {
            console.log('[Status] Reload already in progress, skipping');
            return;
          }
          isReloading = true;
          try {
            // í˜„ì¬ í˜ì´ì§€ ë‹¤ì‹œ ë¡œë“œ
            await loadRecords(currentPage);
            renderTable();
            // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
            await updateStatsCards();
          } finally {
            isReloading = false;
          }
        }
      )
      .subscribe();
  }
})();

</script>

</body>
</html>
