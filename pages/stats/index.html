<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í†µê³„ / ë¦¬í¬íŠ¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="stylesheet" as="style" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- jsPDF for PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Pretendard, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f7fa;
      color: #2c3e50;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #e1e8ed;
    }

    h1 {
      font-size: 24px;
      font-weight: 700;
      color: #1a202c;
      margin-bottom: 24px;
    }

    .filters {
      display: flex;
      gap: 16px;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .filters label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .filters input[type="date"] {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }

    .filters input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .filters button {
      padding: 8px 16px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }

    .filters button:hover {
      background: #2563eb;
    }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .summary-card {
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .summary-card.total {
      background: #f0f0f0;
    }

    .summary-card.new {
      background: #e3f2fd;
    }

    .summary-card.in-progress {
      background: #fff3e0;
    }

    .summary-card.done {
      background: #e8f5e9;
    }

    .summary-card .value {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
      color: #1a202c;
    }

    .summary-card .label {
      font-size: 14px;
      color: #6b7280;
    }

    .section {
      margin-bottom: 32px;
    }

    .section h3 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #1a202c;
    }

    .stats-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .stats-table thead {
      background: #f8f9fa;
    }

    .stats-table th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
    }

    .stats-table td {
      padding: 12px;
      font-size: 14px;
      color: #6b7280;
      border-bottom: 1px solid #e5e7eb;
    }

    .stats-table tbody tr:hover {
      background: #f9fafb;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }

    .error {
      padding: 16px;
      background: #fee2e2;
      color: #dc2626;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .header-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
    }

    .btn-export {
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      color: white;
      font-size: 13px;
      cursor: pointer;
      font-weight: 500;
    }

    .btn-excel {
      background: #16a34a;
    }

    .btn-excel:hover {
      background: #15803d;
    }

    .btn-pdf {
      background: #0f766e;
    }

    .btn-pdf:hover {
      background: #0d9488;
    }

    .chart-container {
      position: relative;
      height: 300px;
      margin-bottom: 24px;
    }

    .chart-wrapper {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 16px;
      margin-bottom: 16px;
      background: white;
    }

    .chart-wrapper h3 {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #1a202c;
    }

    .kpi-card {
      cursor: pointer;
      transition: all 0.2s;
    }

    .kpi-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .kpi-card.active {
      border: 2px solid #4f46e5;
      background: rgba(79,70,229,0.05);
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    @media (max-width: 1024px) {
      .charts-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
      <h1 style="margin: 0;">ğŸ“Š í†µê³„ ëŒ€ì‹œë³´ë“œ</h1>
      <div class="header-actions">
        <button class="btn-export btn-excel" onclick="handleExportExcel()">Excel ë‹¤ìš´ë¡œë“œ</button>
        <button class="btn-export btn-pdf" onclick="handleExportPDF()">PDF ë¦¬í¬íŠ¸</button>
      </div>
    </div>

    <div class="filters">
      <label>
        ì‹œì‘ì¼:
        <input type="date" id="startDate" />
      </label>
      <label>
        ì¢…ë£Œì¼:
        <input type="date" id="endDate" />
      </label>
      <label>
        <input type="checkbox" id="includeDeleted" />
        ì‚­ì œ í¬í•¨
      </label>
      <button id="searchBtn" onclick="fetchStats()">ì¡°íšŒí•˜ê¸°</button>
    </div>

    <div id="errorMsg" class="error" style="display: none;"></div>

    <div class="summary-cards">
      <div class="summary-card total kpi-card" id="kpiTotal" onclick="filterByStatus('')">
        <div class="value" id="totalCount">0</div>
        <div class="label">ì´ ì ‘ìˆ˜</div>
      </div>
      <div class="summary-card new kpi-card" id="kpiNew" onclick="filterByStatus('ì‹ ê·œ')">
        <div class="value" id="newCount">0</div>
        <div class="label">ì‹ ê·œ</div>
      </div>
      <div class="summary-card in-progress kpi-card" id="kpiInProgress" onclick="filterByStatus('ì§„í–‰ì¤‘')">
          <div class="value" id="inProgressCount">0</div>
          <div class="value" id="progressCount" style="display: none;">0</div>
        <div class="label">ì§„í–‰ì¤‘</div>
      </div>
      <div class="summary-card done kpi-card" id="kpiDone" onclick="filterByStatus('ì™„ë£Œ')">
        <div class="value" id="doneCount">0</div>
        <div class="label">ì™„ë£Œ</div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-grid">
      <div class="chart-wrapper">
        <h3>ì¼ë³„ ì ‘ìˆ˜ ì¶”ì´</h3>
        <div class="chart-container">
          <canvas id="dailyChart"></canvas>
        </div>
      </div>
      <div class="chart-wrapper">
        <h3>ë³´í—˜ì‚¬ë³„ ì ‘ìˆ˜ ë¹„ì¤‘</h3>
        <div class="chart-container">
          <canvas id="insurerChart"></canvas>
        </div>
      </div>
      <div class="chart-wrapper">
        <h3>ì›”ë³„ ì ‘ìˆ˜ ê±´ìˆ˜</h3>
        <div class="chart-container">
          <canvas id="monthlyChart"></canvas>
        </div>
      </div>
      <div class="chart-wrapper">
        <h3>ì‹œê³µì ë³„ ë°°ì • TOP 10</h3>
        <div class="chart-container">
          <canvas id="shopChart"></canvas>
        </div>
      </div>
      <div class="chart-wrapper">
        <h3>ë‹´ë‹¹ìë³„ ì²˜ë¦¬ ê±´ìˆ˜</h3>
        <div class="chart-container">
          <canvas id="managerChart"></canvas>
        </div>
      </div>
    </div>

    <div class="section">
      <h3>ë‹´ë‹¹ìë³„ ì²˜ë¦¬ ê±´ìˆ˜ í†µê³„</h3>
      <div id="managerStatsContainer">
        <div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    </div>

    <div class="section">
      <h3>ì¼ë³„ ì ‘ìˆ˜ í†µê³„</h3>
      <div id="dailyStatsContainer">
        <div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    </div>
  </div>

  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Supabase ì´ˆê¸°í™” -->
  <script src="/js/supabaseclient.js"></script>
  
  <!-- Accident API -->
  <script src="/js/accidentapi.js" defer></script>

  <script>
    let isSupabaseReady = false;
    let allRecords = [];
    let filteredRecords = [];
    let selectedStatus = "";
    let dailyChart, insurerChart, monthlyChart, shopChart, managerChart;
    let managerStatsData = []; // ë‹´ë‹¹ìë³„ í†µê³„ ë°ì´í„° (ì°¨íŠ¸ í™•ì¥ìš©)

    // í†µê³„ ëŒ€ì‹œë³´ë“œ ì§‘ê³„ í•¨ìˆ˜
    async function loadDashboardStats() {
      try {
        await waitForSupabase();
        
        // API í•¨ìˆ˜ í™•ì¸
        if (!window.API || !window.API.fetchDashboardStats) {
          console.warn('fetchDashboardStats API í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        const stats = await window.API.fetchDashboardStats(
          document.getElementById('startDate').value,
          document.getElementById('endDate').value
        );

        // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
        document.getElementById('totalCount').innerText = stats.total;
        document.getElementById('newCount').innerText = stats.new;
        document.getElementById('progressCount').innerText = stats.progress;
        document.getElementById('doneCount').innerText = stats.done;
      } catch (error) {
        console.error('í†µê³„ ì§‘ê³„ ì˜¤ë¥˜:', error);
        showError('í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }

    // Wait for Supabase to be ready
    function waitForSupabase() {
      return new Promise((resolve) => {
        // window.supabase ë˜ëŠ” window.supabaseClient í™•ì¸
        if ((window.supabase || window.supabaseClient) && (window.supabaseReady || window.__supabaseReady)) {
          isSupabaseReady = true;
          resolve();
          return;
        }
        
        window.addEventListener('supabaseReady', () => {
          isSupabaseReady = true;
          resolve();
        }, { once: true });
        
        // Timeout after 5 seconds
        setTimeout(() => {
          if (!isSupabaseReady) {
            showError("Supabase ì´ˆê¸°í™” ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
          }
          resolve();
        }, 5000);
      });
    }

    function showError(message) {
      const errorMsg = document.getElementById("errorMsg");
      errorMsg.textContent = message;
      errorMsg.style.display = "block";
      setTimeout(() => {
        errorMsg.style.display = "none";
      }, 5000);
    }

    async function fetchStats() {
      await waitForSupabase();
      
      // window.supabase ë˜ëŠ” window.supabaseClient ì‚¬ìš©
      const supabase = window.supabase || window.supabaseClient;
      
      if (!supabase) {
        showError("Supabase í´ë¼ì´ì–¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;
      const includeDeleted = document.getElementById("includeDeleted").checked;

      try {
        let query = supabase
          .from("accident_records")
          .select("*", { count: "exact" });

        if (!includeDeleted) {
          query = query.eq("is_deleted", false);
        }
        if (startDate) {
          query = query.gte("created_at", startDate);
        }
        if (endDate) {
          query = query.lte("created_at", endDate + " 23:59:59");
        }

        const { data, count, error } = await query;
        
        if (error) {
          console.error("Error fetching stats:", error);
          showError("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
          return;
        }

        allRecords = data || [];
        applyFilters();
        
        // ë‹´ë‹¹ìë³„ í†µê³„ ë°ì´í„° ë¡œë“œ
        await loadManagerStats();

        // í†µê³„ ëŒ€ì‹œë³´ë“œ ì§‘ê³„ (ìƒˆë¡œìš´ API í•¨ìˆ˜ ì‚¬ìš©)
        await loadDashboardStats();
      } catch (error) {
        console.error("Error in fetchStats:", error);
        showError("í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
      }
    }

    function applyFilters() {
      filteredRecords = allRecords;
      if (selectedStatus) {
        filteredRecords = allRecords.filter(r => r.status === selectedStatus);
      }
      updateCharts();
      updateTable();
      // í•„í„°ë§ëœ ë ˆì½”ë“œì— ëŒ€í•´ ë‹´ë‹¹ìë³„ í†µê³„ë„ ì—…ë°ì´íŠ¸
      loadManagerStats();
    }

    function filterByStatus(status) {
      selectedStatus = selectedStatus === status ? "" : status;
      
      // Update KPI card active state
      document.querySelectorAll('.kpi-card').forEach(card => card.classList.remove('active'));
      if (selectedStatus === '') {
        document.getElementById('kpiTotal').classList.add('active');
      } else if (selectedStatus === 'ì‹ ê·œ') {
        document.getElementById('kpiNew').classList.add('active');
      } else if (selectedStatus === 'ì§„í–‰ì¤‘') {
        document.getElementById('kpiInProgress').classList.add('active');
      } else if (selectedStatus === 'ì™„ë£Œ') {
        document.getElementById('kpiDone').classList.add('active');
      }
      
      applyFilters();
    }

    function updateCharts() {
      // Daily stats
      const dailyGrouped = {};
      filteredRecords.forEach(r => {
        const d = (r.created_at || "").split("T")[0];
        if (d) dailyGrouped[d] = (dailyGrouped[d] || 0) + 1;
      });
      const dailyData = Object.entries(dailyGrouped)
        .map(([day, count]) => ({ day, count }))
        .sort((a, b) => a.day.localeCompare(b.day));

      if (dailyChart) dailyChart.destroy();
      const dailyCtx = document.getElementById('dailyChart').getContext('2d');
      dailyChart = new Chart(dailyCtx, {
        type: 'line',
        data: {
          labels: dailyData.map(d => d.day),
          datasets: [{
            label: 'ì ‘ìˆ˜ ê±´ìˆ˜',
            data: dailyData.map(d => d.count),
            borderColor: '#4f46e5',
            backgroundColor: 'rgba(79,70,229,0.1)',
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          }
        }
      });

      // Insurer stats
      const insurerGrouped = {};
      filteredRecords.forEach(r => {
        const key = r.insurance || r.insurer || "ë¯¸ì§€ì •";
        insurerGrouped[key] = (insurerGrouped[key] || 0) + 1;
      });
      const insurerData = Object.entries(insurerGrouped).map(([insurer, count]) => ({ insurer, count }));

      if (insurerChart) insurerChart.destroy();
      const insurerCtx = document.getElementById('insurerChart').getContext('2d');
      insurerChart = new Chart(insurerCtx, {
        type: 'pie',
        data: {
          labels: insurerData.map(d => d.insurer),
          datasets: [{
            data: insurerData.map(d => d.count),
            backgroundColor: ['#4f46e5', '#22c55e', '#f97316', '#0ea5e9', '#e11d48', '#6366f1']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });

      // Monthly stats
      const monthlyGrouped = {};
      filteredRecords.forEach(r => {
        const d = (r.created_at || "").slice(0, 7);
        if (d) monthlyGrouped[d] = (monthlyGrouped[d] || 0) + 1;
      });
      const monthlyData = Object.entries(monthlyGrouped).map(([month, count]) => ({ month, count }));

      if (monthlyChart) monthlyChart.destroy();
      const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
      monthlyChart = new Chart(monthlyCtx, {
        type: 'bar',
        data: {
          labels: monthlyData.map(d => d.month),
          datasets: [{
            label: 'ì ‘ìˆ˜ ê±´ìˆ˜',
            data: monthlyData.map(d => d.count),
            backgroundColor: '#22c55e'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          }
        }
      });

      // Shop stats (TOP 10)
      const shopGrouped = {};
      filteredRecords.forEach(r => {
        const key = r.assigned_workshop_name || "ë¯¸ë°°ì •";
        shopGrouped[key] = (shopGrouped[key] || 0) + 1;
      });
      const shopData = Object.entries(shopGrouped)
        .map(([shop, count]) => ({ shop, count }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 10);

      if (shopChart) shopChart.destroy();
      const shopCtx = document.getElementById('shopChart').getContext('2d');
      shopChart = new Chart(shopCtx, {
        type: 'bar',
        data: {
          labels: shopData.map(d => d.shop),
          datasets: [{
            label: 'ë°°ì • ê±´ìˆ˜',
            data: shopData.map(d => d.count),
            backgroundColor: '#f97316'
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          }
        }
      });
      
      // Manager stats chart
      if (managerChart) managerChart.destroy();
      if (managerStatsData.length > 0) {
        const managerCtx = document.getElementById('managerChart').getContext('2d');
        managerChart = new Chart(managerCtx, {
          type: 'bar',
          data: {
            labels: managerStatsData.map(d => d.manager_name || 'ë¯¸ì§€ì •'),
            datasets: [{
              label: 'ì²˜ë¦¬ ê±´ìˆ˜',
              data: managerStatsData.map(d => d.total_cases),
              backgroundColor: '#8b5cf6'
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            }
          }
        });
      }
    }
    
    // ë‹´ë‹¹ìë³„ í†µê³„ ë°ì´í„° ë¡œë“œ
    async function loadManagerStats() {
      try {
        // users í…Œì´ë¸”ì—ì„œ ëª¨ë“  ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const { data: users, error: usersError } = await window.supabase
          .from('users')
          .select('id, name');
        
        if (usersError) {
          console.error('ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', usersError);
          return;
        }
        
        // ì‚¬ìš©ì IDë¥¼ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘
        const userMap = {};
        (users || []).forEach(user => {
          userMap[user.id] = user.name;
        });
        
        // manager_id ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹í•‘
        const managerGrouped = {};
        filteredRecords.forEach(record => {
          const managerId = record.manager_id;
          if (managerId) {
            if (!managerGrouped[managerId]) {
              managerGrouped[managerId] = {
                manager_id: managerId,
                manager_name: userMap[managerId] || 'ë¯¸ì§€ì •',
                total_cases: 0
              };
            }
            managerGrouped[managerId].total_cases++;
          }
        });
        
        // ë°°ì—´ë¡œ ë³€í™˜í•˜ê³  ì²˜ë¦¬ ê±´ìˆ˜ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
        managerStatsData = Object.values(managerGrouped)
          .sort((a, b) => b.total_cases - a.total_cases);
        
        // UI ì—…ë°ì´íŠ¸
        updateManagerStatsTable();
      } catch (error) {
        console.error('ë‹´ë‹¹ìë³„ í†µê³„ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
      }
    }
    
    // ë‹´ë‹¹ìë³„ í†µê³„ í…Œì´ë¸” ì—…ë°ì´íŠ¸
    function updateManagerStatsTable() {
      const container = document.getElementById("managerStatsContainer");
      
      if (managerStatsData.length === 0) {
        container.innerHTML = "<div class='loading'>ë‹´ë‹¹ìë³„ í†µê³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
        return;
      }
      
      container.innerHTML = `
        <table class="stats-table">
          <thead>
            <tr>
              <th>ìˆœìœ„</th>
              <th>ë‹´ë‹¹ì</th>
              <th>ì²˜ë¦¬ ê±´ìˆ˜</th>
            </tr>
          </thead>
          <tbody>
            ${managerStatsData.map((stat, index) => `
              <tr>
                <td>${index + 1}</td>
                <td>${stat.manager_name || 'ë¯¸ì§€ì •'}</td>
                <td>${stat.total_cases}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function updateTable() {
      const dailyGrouped = {};
      filteredRecords.forEach(r => {
        const d = (r.created_at || "").split("T")[0];
        if (d) dailyGrouped[d] = (dailyGrouped[d] || 0) + 1;
      });
      const dailyStats = Object.entries(dailyGrouped)
        .map(([day, count]) => ({ day, count }))
        .sort((a, b) => a.day.localeCompare(b.day));

      const container = document.getElementById("dailyStatsContainer");
      if (dailyStats.length === 0) {
        container.innerHTML = "<div class='loading'>í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
      } else {
        container.innerHTML = `
          <table class="stats-table">
            <thead>
              <tr>
                <th>ë‚ ì§œ</th>
                <th>ì ‘ìˆ˜ ê±´ìˆ˜</th>
              </tr>
            </thead>
            <tbody>
              ${dailyStats.map(stat => `
                <tr>
                  <td>${stat.day}</td>
                  <td>${stat.count}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      }
    }

    function handleExportExcel() {
      if (!filteredRecords.length) {
        alert("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;

      const headers = ["ì ‘ìˆ˜ë²ˆí˜¸", "ì ‘ìˆ˜ì¼ì‹œ", "ê³ ê°ëª…", "ì—°ë½ì²˜", "ì°¨ëŸ‰ë²ˆí˜¸", "ì°¨ì¢…", "ì‚¬ê³ ìœ„ì¹˜", "ë³´í—˜ì‚¬", "ë°°ì • ì‹œê³µì ", "ìƒíƒœ"];
      const rows = filteredRecords.map(r => [
        r.receipt_number || r.case_no || "",
        r.created_at || "",
        r.customer_name || "",
        r.phone || "",
        r.car_number || r.car_no || "",
        r.car_model || "",
        r.accident_location || "",
        r.insurance || r.insurer || "",
        r.assigned_workshop_name || "",
        r.status || ""
      ]);

      function escapeCsv(value) {
        const str = String(value ?? "");
        if (/[",\n]/.test(str)) {
          return `"${str.replace(/"/g, '""')}"`;
        }
        return str;
      }

      const csv = "\uFEFF" + [headers.join(","), ...rows.map(row => row.map(escapeCsv).join(","))].join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `accident_stats_${startDate}_${endDate}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function handleExportPDF() {
      if (!filteredRecords.length) {
        alert("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF("landscape");
      doc.setFontSize(14);
      doc.text("ìœ ë¦¬ êµì²´ ì‚¬ê³  ì ‘ìˆ˜ í†µê³„ ë¦¬í¬íŠ¸", 14, 18);
      doc.setFontSize(10);
      doc.text(`ê¸°ê°„: ${startDate || "-"} ~ ${endDate || "-"}`, 14, 26);
      if (selectedStatus) {
        doc.text(`ìƒíƒœ í•„í„°: ${selectedStatus}`, 14, 32);
      }

      const headers = [["ì ‘ìˆ˜ë²ˆí˜¸", "ì ‘ìˆ˜ì¼ì‹œ", "ê³ ê°ëª…", "ì—°ë½ì²˜", "ì°¨ëŸ‰ë²ˆí˜¸", "ì°¨ì¢…", "ì‚¬ê³ ìœ„ì¹˜", "ë³´í—˜ì‚¬", "ë°°ì • ì‹œê³µì ", "ìƒíƒœ"]];
      const body = filteredRecords.map(r => [
        r.receipt_number || r.case_no || "",
        r.created_at || "",
        r.customer_name || "",
        r.phone || "",
        r.car_number || r.car_no || "",
        r.car_model || "",
        r.accident_location || "",
        r.insurance || r.insurer || "",
        r.assigned_workshop_name || "",
        r.status || ""
      ]);

      doc.autoTable({
        head: headers,
        body: body,
        startY: 36,
        styles: { fontSize: 8 },
        headStyles: { fillColor: [79, 70, 229] }
      });

      doc.save(`accident_stats_${startDate}_${endDate}.pdf`);
    }

    // Load stats on page load
    document.addEventListener('DOMContentLoaded', async () => {
      await waitForSupabase();
      
      // Set default date range (last 30 days)
      const today = new Date();
      const from = new Date();
      from.setDate(today.getDate() - 30);
      document.getElementById("startDate").value = from.toISOString().slice(0, 10);
      document.getElementById("endDate").value = today.toISOString().slice(0, 10);
      
      // í†µê³„ ëŒ€ì‹œë³´ë“œ ì§‘ê³„ ë¨¼ì € ì‹¤í–‰
      loadDashboardStats();
      // ì „ì²´ í†µê³„ë„ í•¨ê»˜ ë¡œë“œ
      fetchStats();
      
      // ì¡°íšŒ ë²„íŠ¼ì— í†µê³„ ì§‘ê³„ ì´ë²¤íŠ¸ ì—°ê²°
      const searchBtn = document.getElementById('searchBtn');
      if (searchBtn) {
        searchBtn.addEventListener('click', loadDashboardStats);
      }
    });
  </script>
</body>
</html>

