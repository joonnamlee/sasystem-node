<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>ìë™ì°¨ ìœ ë¦¬ êµì²´ í†µí•© ëŒ€ì‹œë³´ë“œ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
        font-family: Pretendard, sans-serif;
        display: flex;
        height: 100vh;
        overflow: hidden;
        background: #f3f4f6;
    }

    /* Sidebar */
    .sidebar {
        width: 260px;
        background: #111827;
        color: white;
        padding: 24px 16px;
        display: flex;
        flex-direction: column;
        transition: 0.3s ease;
    }

    .sidebar h2 {
        font-size: 20px;
        margin-bottom: 32px;
        color: #60a5fa;
    }

    #logoutBtn {
        margin-top: auto;
        padding: 12px 16px;
        background: #dc2626;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s ease;
    }

    #logoutBtn:hover {
        background: #b91c1c;
    }

    .menu-item {
        padding: 14px 16px;
        margin-bottom: 10px;
        border-radius: 8px;
        cursor: pointer;
        background: #1f2937;
        transition: 0.2s ease;
        font-size: 15px;
        user-select: none;
    }

    .menu-item:hover,
    .menu-item.active {
        background: #3b82f6;
    }

    .admin-only {
        display: none;
    }

    /* Content Layout */
    .content {
        flex: 1;
        height: 100vh;
        overflow: hidden;
        background: white;
    }

    iframe {
        border: none;
        width: 100%;
        height: 100%;
    }

    /* Mobile Header */
    .m-header {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 56px;
        background: white;
        border-bottom: 1px solid #e1e8ed;
        z-index: 1000;
        align-items: center;
        padding: 0 16px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .m-header-left {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .m-header-back {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #1a202c;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .m-header-title {
        font-size: 18px;
        font-weight: 600;
        color: #1a202c;
    }

    .m-header-right {
        margin-left: auto;
        display: flex;
        align-items: center;
    }

    .m-user-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #3b82f6;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 600;
    }

    /* Mobile Bottom Navigation */
    .m-bottom-nav {
        display: none;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 56px;
        background: white;
        border-top: 1px solid #e1e8ed;
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: space-around;
        box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
    }

    .m-nav-item {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 8px 4px;
        cursor: pointer;
        color: #6b7280;
        transition: color 0.2s;
        text-decoration: none;
        min-width: 0;
    }

    .m-nav-item.active {
        color: #3b82f6;
    }

    .m-nav-label {
        font-size: 13px;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: center;
    }

    .m-more-menu {
        position: fixed;
        bottom: 72px;
        right: 16px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        padding: 8px 0;
        min-width: 160px;
        display: none;
        z-index: 1001;
    }

    .m-more-menu.active {
        display: block;
    }

    .m-more-item {
        padding: 12px 16px;
        cursor: pointer;
        color: #1a202c;
        font-size: 14px;
        transition: background 0.2s;
    }

    .m-more-item:hover {
        background: #f3f4f6;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
        body {
            padding-bottom: 56px;
        }

        .sidebar {
            display: none !important;
        }

        .content {
            width: 100%;
            padding-top: 56px;
        }

        iframe {
            height: calc(100vh - 112px);
        }

        .m-header {
            display: flex;
        }

        .m-bottom-nav {
            display: flex;
        }
    }
</style>
</head>

<body>

<!-- Mobile Header -->
<div class="m-header">
    <div class="m-header-left">
        <button class="m-header-back" onclick="goBack()">â†</button>
        <div class="m-header-title" id="mPageTitle">ì ‘ìˆ˜ í˜„í™©</div>
    </div>
    <div class="m-header-right">
        <div class="m-user-icon" id="mUserIcon">A</div>
    </div>
</div>

<!-- Mobile Bottom Navigation -->
<div class="m-bottom-nav">
    <div class="m-nav-item" onclick="mNavigate('status')">
        <div class="m-nav-label">ì ‘ìˆ˜ í˜„í™©</div>
    </div>
    <div class="m-nav-item" onclick="mNavigate('accident')">
        <div class="m-nav-label">ì‚¬ê³  ì ‘ìˆ˜</div>
    </div>
    <div class="m-nav-item" onclick="mNavigate('map')">
        <div class="m-nav-label">ì‹œê³µì  ì§€ë„</div>
    </div>
    <div class="m-nav-item" onclick="mNavigate('message')">
        <div class="m-nav-label">ë©”ì‹œì§€</div>
    </div>
    <div class="m-nav-item" onclick="toggleMoreMenu()">
        <div class="m-nav-label">ë”ë³´ê¸°</div>
    </div>
</div>

<!-- More Menu -->
<div class="m-more-menu" id="mMoreMenu">
    <div class="m-more-item admin-only" onclick="mNavigate('workshop'); toggleMoreMenu();">ì‹œê³µì  ê´€ë¦¬</div>
    <div class="m-more-item admin-only" onclick="mNavigate('vehicle'); toggleMoreMenu();">ì°¨ëŸ‰ ê´€ë¦¬</div>
    <div class="m-more-item admin-only" onclick="mNavigate('settlement'); toggleMoreMenu();">ì •ì‚° ê´€ë¦¬</div>
    <div class="m-more-item" onclick="mNavigate('stats'); toggleMoreMenu();">í†µê³„ / ë¦¬í¬íŠ¸</div>
    <div class="m-more-item admin-only" onclick="mNavigate('users'); toggleMoreMenu();">ìœ ì € ê´€ë¦¬</div>
</div>

<div class="sidebar">
    <h2>ìœ ë¦¬ êµì²´ ëŒ€ì‹œë³´ë“œ</h2>

    <div class="menu-item active" onclick="loadPage('status', event)">
        ì ‘ìˆ˜ í˜„í™©
    </div>

    <div class="menu-item" onclick="loadPage('accident', event)">
        ì‚¬ê³  ì ‘ìˆ˜ ì‹œìŠ¤í…œ
    </div>

    <div class="menu-item" onclick="loadPage('map', event)">
        ì‹œê³µì  ìë™ ë°°ì • ì§€ë„
    </div>

    <div class="menu-item" onclick="loadPage('message', event)">
        ë©”ì‹œì§€ ë³´ë‚´ê¸°
    </div>

    <div class="menu-item admin-only" onclick="loadPage('workshop', event)">
        ì‹œê³µì  ê´€ë¦¬
    </div>

    <div class="menu-item admin-only" onclick="loadPage('vehicle', event)">
        ì°¨ëŸ‰ ê´€ë¦¬
    </div>

    <div class="menu-item admin-only" onclick="loadPage('settlement', event)">
        ì •ì‚° ê´€ë¦¬
    </div>

    <div class="menu-item" onclick="loadPage('stats', event)">
        í†µê³„ / ë¦¬í¬íŠ¸
    </div>

    <div class="menu-item admin-only" onclick="loadPage('users', event)">
        ìœ ì € ê´€ë¦¬
    </div>

    <button id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
</div>

<div class="content">
    <iframe id="contentFrame" src="./pages/status/index.html"></iframe>
</div>

<script>
async function loadPage(page, e) {
    const frame = document.getElementById("contentFrame");
    
    // ê¶Œí•œ ì²´í¬ë¥¼ ìœ„í•´ í˜„ì¬ ì‚¬ìš©ì role í™•ì¸
    const { supabase } = await import("/js/supabase.js");
    const { data: { session } } = await supabase.auth.getSession();
    const role = session?.user?.app_metadata?.role;

    // adminë§Œ ì ‘ê·¼ ê°€ëŠ¥í•œ í˜ì´ì§€
    const adminOnlyPages = ["users", "workshop", "vehicle", "settlement"];
    if (adminOnlyPages.includes(page) && role !== "admin") {
        alert("ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•œ í˜ì´ì§€ì…ë‹ˆë‹¤.");
        // ëŒ€ì‹œë³´ë“œë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (accident í˜ì´ì§€ë¡œ)
        frame.src = "./pages/accident/index.html";
        document.querySelectorAll(".menu-item").forEach(item => item.classList.remove("active"));
        const accidentMenu = Array.from(document.querySelectorAll(".menu-item")).find(item => 
            item.textContent.includes("ì‚¬ê³  ì ‘ìˆ˜")
        );
        if (accidentMenu) accidentMenu.classList.add("active");
        return;
    }

    if (page === "accident") {
        frame.src = "./pages/accident/index.html";
    } else if (page === "message") {
        frame.src = "./pages/message/index.html";
    } else if (page === "map") {
        frame.src = "./pages/installer/embed.html";
    } else if (page === "workshop") {
        frame.src = "./pages/installer/management.html";
    } else if (page === "vehicle") {
        frame.src = "./vehicle-management.html";
    } else if (page === "settlement") {
        frame.src = "./settlement-management.html";
    } else if (page === "templates") {
        frame.src = "./pages/templates/index.html";
    } else if (page === "status") {
        frame.src = "./pages/status/index.html";
    } else if (page === "stats") {
        frame.src = "./pages/stats/index.html";
    } else if (page === "users") {
        frame.src = "./users.html";
    }

    document.querySelectorAll(".menu-item").forEach(item => item.classList.remove("active"));
    if (e && e.target) {
        e.target.classList.add("active");
    }
    
    // ëª¨ë°”ì¼ ë„¤ë¹„ê²Œì´ì…˜ ì—…ë°ì´íŠ¸
    updateMobileNav(page);
    updateMobileHeader();
    
    // í˜ì´ì§€ ë³€ê²½ ì‹œ iframe ë¡œë“œ ì²˜ë¦¬
    frame.addEventListener('load', () => {
        // iframe ë¡œë“œ ì™„ë£Œ
        updateMobileHeader();
    }, { once: true });
}

// iframeì—ì„œ ë©”ì‹œì§€ ìˆ˜ì‹  ì²˜ë¦¬
window.addEventListener('message', function(event) {
    const frame = document.getElementById("contentFrame");
    
    if (event.data.type === 'openAccidentDetail') {
        const param = event.data.useId ? 'id' : 'edit';
        frame.src = "./pages/accident/index.html?" + param + "=" + encodeURIComponent(event.data.receiptNumber);
        // ë©”ë‰´ í™œì„±í™”
        document.querySelectorAll(".menu-item").forEach(item => item.classList.remove("active"));
        const accidentMenu = Array.from(document.querySelectorAll(".menu-item")).find(item => 
            item.textContent.includes("ì‚¬ê³  ì ‘ìˆ˜")
        );
        if (accidentMenu) accidentMenu.classList.add("active");
    } else if (event.data.type === 'openAccidentNew') {
        frame.src = "./pages/accident/index.html";
        // ë©”ë‰´ í™œì„±í™”
        document.querySelectorAll(".menu-item").forEach(item => item.classList.remove("active"));
        const accidentMenu = Array.from(document.querySelectorAll(".menu-item")).find(item => 
            item.textContent.includes("ì‚¬ê³  ì ‘ìˆ˜")
        );
        if (accidentMenu) accidentMenu.classList.add("active");
    } else if (event.data.type === 'openInstallerMap') {
        const addressParam = event.data.address ? `?address=${encodeURIComponent(event.data.address)}` : '';
        frame.src = "./pages/installer/embed.html" + addressParam;
        // ë©”ë‰´ í™œì„±í™”
        document.querySelectorAll(".menu-item").forEach(item => item.classList.remove("active"));
        const installerMenu = Array.from(document.querySelectorAll(".menu-item")).find(item => 
            item.textContent.includes("ì‹œê³µì ")
        );
        if (installerMenu) installerMenu.classList.add("active");
    } else if (event.data.type === 'openAccidentPage') {
        frame.src = "./pages/accident/index.html";
        // ë©”ë‰´ í™œì„±í™”
        document.querySelectorAll(".menu-item").forEach(item => item.classList.remove("active"));
        const accidentMenu = Array.from(document.querySelectorAll(".menu-item")).find(item => 
            item.textContent.includes("ì‚¬ê³  ì ‘ìˆ˜")
        );
        if (accidentMenu) accidentMenu.classList.add("active");
    } else if (event.data.type === 'openMessagePage') {
        const recordId = event.data.recordId;
        const caseNo = event.data.caseNo;
        const params = new URLSearchParams();
        if (recordId) params.set('accidentId', recordId);
        if (caseNo) params.set('caseNo', caseNo);
        frame.src = "./pages/message/index.html?" + params.toString();
        // ë©”ë‰´ í™œì„±í™”
        document.querySelectorAll(".menu-item").forEach(item => item.classList.remove("active"));
        const messageMenu = Array.from(document.querySelectorAll(".menu-item")).find(item => 
            item.textContent.includes("ë©”ì‹œì§€ ë³´ë‚´ê¸°")
        );
        if (messageMenu) messageMenu.classList.add("active");
    }
    
    // URL ê¸°ë°˜ ë¼ìš°íŒ… ì§€ì› (/accident-form, /workshop-map)
    if (window.location.pathname.includes('/accident-form') || window.location.pathname.endsWith('/accident/index.html')) {
        frame.src = "./pages/accident/index.html";
        document.querySelectorAll(".menu-item").forEach(item => item.classList.remove("active"));
        const accidentMenu = Array.from(document.querySelectorAll(".menu-item")).find(item => 
            item.textContent.includes("ì‚¬ê³  ì ‘ìˆ˜")
        );
        if (accidentMenu) accidentMenu.classList.add("active");
    } else if (window.location.pathname.includes('/workshop-map')) {
        const urlParams = new URLSearchParams(window.location.search);
        const address = urlParams.get('address');
        frame.src = "./pages/installer/embed.html" + (address ? "?address=" + encodeURIComponent(address) : "");
        document.querySelectorAll(".menu-item").forEach(item => item.classList.remove("active"));
        const installerMenu = Array.from(document.querySelectorAll(".menu-item")).find(item => 
            item.textContent.includes("ì‹œê³µì ")
        );
        if (installerMenu) installerMenu.classList.add("active");
    }
});
</script>

<script type="module">
import { logout } from "/js/auth.js";
import { supabase } from "/js/supabase.js";

// âœ… ì „ì—­ ë³€ìˆ˜ (ì„¸ì…˜ ë° ì‚¬ìš©ì ì •ë³´)
let currentUser = null;
let currentSession = null;

async function initDashboard() {
  // ğŸ”½ ì—¬ê¸°ì„œë¶€í„° ì•ˆì „í•˜ê²Œ ë¡œì§ ì‹¤í–‰ (ì„¸ì…˜ ë³´ì¥ë¨)
  const role = currentSession?.user?.app_metadata?.role;
  console.log("USER ROLE:", role);

  if (role === "admin") {
    document
      .querySelectorAll(".admin-only")
      .forEach(el => el.style.display = "block");
  } else {
    document
      .querySelectorAll(".admin-only")
      .forEach(el => el.style.display = "none");
  }
}


document.addEventListener('DOMContentLoaded', async () => {
  const { data, error } = await supabase.auth.getSession();

  if (error || !data.session) {
    window.location.href = '/login.html';
    return;
  }

  currentSession = data.session;
  currentUser = data.session.user;

  // ğŸ”½ ì—¬ê¸°ì„œë¶€í„° ì•ˆì „í•˜ê²Œ ë¡œì§ ì‹¤í–‰
  initDashboard();
  
  // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
  document
    .getElementById("logoutBtn")
    ?.addEventListener("click", logout);
  
  // iframe ë¡œë“œ ì™„ë£Œ ì²˜ë¦¬
  const frame = document.getElementById("contentFrame");
  frame.addEventListener('load', () => {
    // iframe ë¡œë“œ ì™„ë£Œ
    updateMobileHeader();
  });

  // ëª¨ë°”ì¼ í—¤ë” ì‚¬ìš©ì ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
  const userIcon = document.getElementById('mUserIcon');
  if (userIcon && currentUser) {
    const name = currentUser.email || currentUser.user_metadata?.name || 'U';
    userIcon.textContent = name.charAt(0).toUpperCase();
  }
});

// ëª¨ë°”ì¼ ë„¤ë¹„ê²Œì´ì…˜
function mNavigate(page) {
  loadPage(page, null);
  updateMobileNav(page);
  updateMobileHeader();
  toggleMoreMenu(false);
}

// ëª¨ë°”ì¼ ë„¤ë¹„ê²Œì´ì…˜ í™œì„±í™” ì—…ë°ì´íŠ¸
function updateMobileNav(activePage) {
  const navItems = document.querySelectorAll('.m-bottom-nav .m-nav-item');
  navItems.forEach(item => item.classList.remove('active'));
  
  const pageMap = {
    'status': 0,
    'accident': 1,
    'map': 2,
    'message': 3
  };
  
  if (pageMap[activePage] !== undefined) {
    navItems[pageMap[activePage]]?.classList.add('active');
  }
}

// ëª¨ë°”ì¼ í—¤ë” ì œëª© ì—…ë°ì´íŠ¸
function updateMobileHeader() {
  const frame = document.getElementById("contentFrame");
  const titleEl = document.getElementById("mPageTitle");
  
  const pageTitles = {
    'accident': 'ì‚¬ê³  ì ‘ìˆ˜',
    'map': 'ì‹œê³µì  ì§€ë„',
    'settlement': 'ì •ì‚° ê´€ë¦¬',
    'vehicle': 'ì°¨ëŸ‰ ê´€ë¦¬',
    'status': 'ì ‘ìˆ˜ í˜„í™©',
    'stats': 'í†µê³„ / ë¦¬í¬íŠ¸',
    'workshop': 'ì‹œê³µì  ê´€ë¦¬',
    'users': 'ìœ ì € ê´€ë¦¬',
    'message': 'ë©”ì‹œì§€ ë³´ë‚´ê¸°'
  };
  
  const currentSrc = frame.src;
  for (const [page, title] of Object.entries(pageTitles)) {
    if (currentSrc.includes(page) || currentSrc.includes(page.replace('workshop', 'installer'))) {
      titleEl.textContent = title;
      break;
    }
  }
}

// ë”ë³´ê¸° ë©”ë‰´ í† ê¸€
function toggleMoreMenu(show) {
  const menu = document.getElementById('mMoreMenu');
  if (show === undefined) {
    menu.classList.toggle('active');
  } else {
    menu.classList.toggle('active', show);
  }
}

// ë’¤ë¡œê°€ê¸°
function goBack() {
  window.history.back();
}

// í´ë¦­ ì™¸ë¶€ ì˜ì—­ì—ì„œ ë”ë³´ê¸° ë©”ë‰´ ë‹«ê¸°
document.addEventListener('click', (e) => {
  const moreMenu = document.getElementById('mMoreMenu');
  const moreNavItem = document.querySelector('.m-nav-item:last-child');
  
  if (moreMenu && moreNavItem && !moreMenu.contains(e.target) && !moreNavItem.contains(e.target)) {
    moreMenu.classList.remove('active');
  }
});
</script>

</body>
</html>

