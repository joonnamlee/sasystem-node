<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>ìë™ì°¨ ìœ ë¦¬ êµì²´ í†µí•© ëŒ€ì‹œë³´ë“œ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
        font-family: Pretendard, sans-serif;
        display: flex;
        height: 100vh;
        overflow: hidden;
        background: #f3f4f6;
    }

    /* Sidebar */
    .sidebar {
        width: 260px;
        background: #111827;
        color: white;
        padding: 24px 16px;
        display: flex;
        flex-direction: column;
        transition: 0.3s ease;
    }

    .sidebar h2 {
        font-size: 20px;
        margin-bottom: 32px;
        color: #60a5fa;
    }

    #logoutBtn {
        margin-top: auto;
        padding: 12px 16px;
        background: #dc2626;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s ease;
    }

    #logoutBtn:hover {
        background: #b91c1c;
    }

    .menu-item {
        padding: 14px 16px;
        margin-bottom: 10px;
        border-radius: 8px;
        cursor: pointer;
        background: #1f2937;
        transition: 0.2s ease;
        font-size: 15px;
        user-select: none;
    }

    .menu-item:hover,
    .menu-item.active {
        background: #3b82f6;
    }

    .admin-only {
        display: none;
    }

    /* Content Layout */
    .content {
        flex: 1;
        height: 100vh;
        overflow: hidden;
        background: white;
    }

    iframe {
        border: none;
        width: 100%;
        height: 100%;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
        body {
            flex-direction: column;
        }

        .sidebar {
            width: 100%;
            flex-direction: row;
            overflow-x: auto;
            height: auto;
            padding: 12px;
        }

        .menu-item {
            flex: 1;
            margin-right: 8px;
            text-align: center;
            white-space: nowrap;
        }
    }
</style>
</head>

<body>

<div class="sidebar">
    <h2>ìœ ë¦¬ êµì²´ ëŒ€ì‹œë³´ë“œ</h2>

    <div class="menu-item active" onclick="loadPage('accident', event)">
        ì‚¬ê³  ì ‘ìˆ˜ ì‹œìŠ¤í…œ
    </div>

    <div class="menu-item" onclick="loadPage('message', event)">
        ğŸ’¬ ë©”ì‹œì§€ ë³´ë‚´ê¸°
    </div>

    <div class="menu-item" onclick="loadPage('map', event)">
        ì‹œê³µì  ìë™ ë°°ì • ì§€ë„
    </div>

    <div class="menu-item" onclick="loadPage('status', event)">
        ì ‘ìˆ˜ í˜„í™©
    </div>

    <div class="menu-item" onclick="loadPage('stats', event)">
        í†µê³„ / ë¦¬í¬íŠ¸
    </div>

    <div class="menu-item admin-only" onclick="loadPage('users', event)">
        ìœ ì € ê´€ë¦¬
    </div>

    <button id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
</div>

<div class="content">
    <iframe id="contentFrame" src="./pages/accident/index.html"></iframe>
</div>

<script>
async function loadPage(page, e) {
    const frame = document.getElementById("contentFrame");
    
    // ê¶Œí•œ ì²´í¬ë¥¼ ìœ„í•´ í˜„ì¬ ì‚¬ìš©ì role í™•ì¸
    const { supabase } = await import("/js/supabase.js");
    const { data: { session } } = await supabase.auth.getSession();
    const role = session?.user?.app_metadata?.role;

    // adminë§Œ ì ‘ê·¼ ê°€ëŠ¥í•œ í˜ì´ì§€
    const adminOnlyPages = ["users"];
    if (adminOnlyPages.includes(page) && role !== "admin") {
        alert("ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•œ í˜ì´ì§€ì…ë‹ˆë‹¤.");
        // ëŒ€ì‹œë³´ë“œë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (accident í˜ì´ì§€ë¡œ)
        frame.src = "./pages/accident/index.html";
        document.querySelectorAll(".menu-item").forEach(item => item.classList.remove("active"));
        const accidentMenu = Array.from(document.querySelectorAll(".menu-item")).find(item => 
            item.textContent.includes("ì‚¬ê³  ì ‘ìˆ˜")
        );
        if (accidentMenu) accidentMenu.classList.add("active");
        return;
    }

    if (page === "accident") {
        frame.src = "./pages/accident/index.html";
    } else if (page === "message") {
        frame.src = "./pages/message/index.html";
    } else if (page === "map") {
        frame.src = "./pages/installer/embed.html";
    } else if (page === "templates") {
        frame.src = "./pages/templates/index.html";
    } else if (page === "status") {
        frame.src = "./pages/status/index.html";
    } else if (page === "stats") {
        frame.src = "./pages/stats/index.html";
    } else if (page === "users") {
        frame.src = "./users.html";
    }

    document.querySelectorAll(".menu-item").forEach(item => item.classList.remove("active"));
    if (e && e.target) {
        e.target.classList.add("active");
    }
    
    // í˜ì´ì§€ ë³€ê²½ ì‹œ iframe ë¡œë“œ ì²˜ë¦¬
    frame.addEventListener('load', () => {
        // iframe ë¡œë“œ ì™„ë£Œ
    }, { once: true });
}

// iframeì—ì„œ ë©”ì‹œì§€ ìˆ˜ì‹  ì²˜ë¦¬
window.addEventListener('message', function(event) {
    const frame = document.getElementById("contentFrame");
    
    if (event.data.type === 'openAccidentDetail') {
        const param = event.data.useId ? 'id' : 'edit';
        frame.src = "./pages/accident/index.html?" + param + "=" + encodeURIComponent(event.data.receiptNumber);
        // ë©”ë‰´ í™œì„±í™”
        document.querySelectorAll(".menu-item").forEach(item => item.classList.remove("active"));
        const accidentMenu = Array.from(document.querySelectorAll(".menu-item")).find(item => 
            item.textContent.includes("ì‚¬ê³  ì ‘ìˆ˜")
        );
        if (accidentMenu) accidentMenu.classList.add("active");
    } else if (event.data.type === 'openAccidentNew') {
        frame.src = "./pages/accident/index.html";
        // ë©”ë‰´ í™œì„±í™”
        document.querySelectorAll(".menu-item").forEach(item => item.classList.remove("active"));
        const accidentMenu = Array.from(document.querySelectorAll(".menu-item")).find(item => 
            item.textContent.includes("ì‚¬ê³  ì ‘ìˆ˜")
        );
        if (accidentMenu) accidentMenu.classList.add("active");
    } else if (event.data.type === 'openInstallerMap') {
        const addressParam = event.data.address ? `?address=${encodeURIComponent(event.data.address)}` : '';
        frame.src = "./pages/installer/embed.html" + addressParam;
        // ë©”ë‰´ í™œì„±í™”
        document.querySelectorAll(".menu-item").forEach(item => item.classList.remove("active"));
        const installerMenu = Array.from(document.querySelectorAll(".menu-item")).find(item => 
            item.textContent.includes("ì‹œê³µì ")
        );
        if (installerMenu) installerMenu.classList.add("active");
    } else if (event.data.type === 'openAccidentPage') {
        frame.src = "./pages/accident/index.html";
        // ë©”ë‰´ í™œì„±í™”
        document.querySelectorAll(".menu-item").forEach(item => item.classList.remove("active"));
        const accidentMenu = Array.from(document.querySelectorAll(".menu-item")).find(item => 
            item.textContent.includes("ì‚¬ê³  ì ‘ìˆ˜")
        );
        if (accidentMenu) accidentMenu.classList.add("active");
    } else if (event.data.type === 'openMessagePage') {
        const recordId = event.data.recordId;
        const caseNo = event.data.caseNo;
        const params = new URLSearchParams();
        if (recordId) params.set('accidentId', recordId);
        if (caseNo) params.set('caseNo', caseNo);
        frame.src = "./pages/message/index.html?" + params.toString();
        // ë©”ë‰´ í™œì„±í™”
        document.querySelectorAll(".menu-item").forEach(item => item.classList.remove("active"));
        const messageMenu = Array.from(document.querySelectorAll(".menu-item")).find(item => 
            item.textContent.includes("ë©”ì‹œì§€ ë³´ë‚´ê¸°")
        );
        if (messageMenu) messageMenu.classList.add("active");
    }
    
    // URL ê¸°ë°˜ ë¼ìš°íŒ… ì§€ì› (/accident-form, /workshop-map)
    if (window.location.pathname.includes('/accident-form') || window.location.pathname.endsWith('/accident/index.html')) {
        frame.src = "./pages/accident/index.html";
        document.querySelectorAll(".menu-item").forEach(item => item.classList.remove("active"));
        const accidentMenu = Array.from(document.querySelectorAll(".menu-item")).find(item => 
            item.textContent.includes("ì‚¬ê³  ì ‘ìˆ˜")
        );
        if (accidentMenu) accidentMenu.classList.add("active");
    } else if (window.location.pathname.includes('/workshop-map')) {
        const urlParams = new URLSearchParams(window.location.search);
        const address = urlParams.get('address');
        frame.src = "./pages/installer/embed.html" + (address ? "?address=" + encodeURIComponent(address) : "");
        document.querySelectorAll(".menu-item").forEach(item => item.classList.remove("active"));
        const installerMenu = Array.from(document.querySelectorAll(".menu-item")).find(item => 
            item.textContent.includes("ì‹œê³µì ")
        );
        if (installerMenu) installerMenu.classList.add("active");
    }
});
</script>

<script type="module">
import { logout } from "/js/auth.js";
import { supabase } from "/js/supabase.js";

// âœ… ì „ì—­ ë³€ìˆ˜ (ì„¸ì…˜ ë° ì‚¬ìš©ì ì •ë³´)
let currentUser = null;
let currentSession = null;

async function initDashboard() {
  // ğŸ”½ ì—¬ê¸°ì„œë¶€í„° ì•ˆì „í•˜ê²Œ ë¡œì§ ì‹¤í–‰ (ì„¸ì…˜ ë³´ì¥ë¨)
  const role = currentSession?.user?.app_metadata?.role;
  console.log("USER ROLE:", role);

  if (role === "admin") {
    document
      .querySelectorAll(".admin-only")
      .forEach(el => el.style.display = "block");
  } else {
    document
      .querySelectorAll(".admin-only")
      .forEach(el => el.style.display = "none");
  }
}


document.addEventListener('DOMContentLoaded', async () => {
  const { data, error } = await supabase.auth.getSession();

  if (error || !data.session) {
    window.location.href = '/login.html';
    return;
  }

  currentSession = data.session;
  currentUser = data.session.user;

  // ğŸ”½ ì—¬ê¸°ì„œë¶€í„° ì•ˆì „í•˜ê²Œ ë¡œì§ ì‹¤í–‰
  initDashboard();
  
  // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
  document
    .getElementById("logoutBtn")
    ?.addEventListener("click", logout);
  
  // iframe ë¡œë“œ ì™„ë£Œ ì²˜ë¦¬
  const frame = document.getElementById("contentFrame");
  frame.addEventListener('load', () => {
    // iframe ë¡œë“œ ì™„ë£Œ
  });
});
</script>

</body>
</html>

