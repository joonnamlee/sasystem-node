<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>ìë™ì°¨ ìœ ë¦¬ êµì²´ í†µí•© ëŒ€ì‹œë³´ë“œ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script>
  // ëª¨ë°”ì¼ ê°ì§€ ë° ë¦¬ë‹¤ì´ë ‰íŠ¸
  (function() {
    const isMobile = window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const currentPath = window.location.pathname;
    
    // ëª¨ë°”ì¼ì´ê³  ì•„ì§ mobile ê²½ë¡œê°€ ì•„ë‹Œ ê²½ìš°
    if (isMobile && !currentPath.startsWith('/mobile/') && currentPath !== '/mobile/index.html') {
      // dashboard.htmlì—ì„œ ì ‘ê·¼í•œ ê²½ìš°
      if (currentPath === '/dashboard.html' || currentPath === '/' || currentPath.endsWith('/dashboard.html')) {
        window.location.href = '/mobile/index.html';
        return;
      }
    }
  })();
</script>

<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
        font-family: Pretendard, sans-serif;
        display: flex;
        height: 100vh;
        overflow: hidden;
        background: #f3f4f6;
    }

    /* Sidebar */
    .sidebar {
        width: 260px;
        background: #111827;
        color: white;
        padding: 24px 16px;
        display: flex;
        flex-direction: column;
        transition: 0.3s ease;
    }

    .sidebar h2 {
        font-size: 20px;
        margin-bottom: 32px;
        color: #60a5fa;
    }

    #logoutBtn {
        margin-top: auto;
        padding: 12px 16px;
        background: #dc2626;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s ease;
    }

    #logoutBtn:hover {
        background: #b91c1c;
    }

    .menu-item {
        padding: 14px 16px;
        margin-bottom: 10px;
        border-radius: 8px;
        cursor: pointer;
        background: #1f2937;
        transition: 0.2s ease;
        font-size: 15px;
        user-select: none;
    }

    .menu-item:hover,
    .menu-item.active {
        background: #3b82f6;
    }

    .admin-only {
        display: none;
    }

    /* Content Layout */
    .content {
        flex: 1;
        height: 100vh;
        overflow: hidden;
        background: white;
    }

    iframe {
        border: none;
        width: 100%;
        height: 100%;
    }

    /* Mobile Header */
    .m-header {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 44px;
        background: white;
        border-bottom: 1px solid #e1e8ed;
        z-index: 3000;
        align-items: center;
        padding: 0 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        pointer-events: auto;
    }
    
    /* PC í™”ë©´ì—ì„œ ëª¨ë°”ì¼ ìš”ì†Œ ì™„ì „ ìˆ¨ê¹€ */
    @media (min-width: 1024px) {
        .m-header,
        .m-slide-menu-overlay,
        .m-slide-menu,
        .m-bottom-nav,
        .app-header,
        .hamburger-btn,
        .drawer,
        .drawer-overlay {
            display: none !important;
            visibility: hidden !important;
        }
    }

    .m-header-left {
        display: flex;
        align-items: center;
        gap: 12px;
        pointer-events: auto;
        position: relative;
        z-index: 3001;
    }

    .m-header-back {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #1a202c;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .m-hamburger {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #1a202c;
        padding: 0;
        width: 44px;
        height: 44px;
        min-width: 44px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        z-index: 3002;
        position: relative;
        pointer-events: auto !important;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
    }
    
    .m-hamburger:active {
        opacity: 0.7;
        background: rgba(0,0,0,0.05);
        border-radius: 4px;
    }

    /* Mobile Slide Menu */
    .m-slide-menu {
        position: fixed;
        top: 0;
        left: -280px;
        width: 280px;
        height: 100vh;
        background: white;
        box-shadow: 2px 0 8px rgba(0,0,0,0.15);
        z-index: 2999;
        transition: left 0.3s ease;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        pointer-events: auto;
    }

    .m-slide-menu.active {
        left: 0;
    }

    .m-slide-menu-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 1999;
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
    }

    .m-slide-menu-overlay.active {
        display: block;
        opacity: 1;
        pointer-events: auto;
    }

    .m-slide-menu-header {
        padding: 16px;
        border-bottom: 1px solid #e1e8ed;
        background: #111827;
        color: white;
    }

    .m-slide-menu-header h2 {
        font-size: 18px;
        margin: 0;
        color: #60a5fa;
    }

    .m-slide-menu-content {
        flex: 1;
        padding: 8px 0;
        overflow-y: auto;
    }

    .m-slide-menu-item {
        padding: 14px 16px;
        cursor: pointer;
        color: #1a202c;
        font-size: 15px;
        transition: background 0.2s;
        border-bottom: 1px solid #f3f4f6;
        pointer-events: auto;
        -webkit-tap-highlight-color: rgba(59, 130, 246, 0.2);
    }

    .m-slide-menu-item:hover,
    .m-slide-menu-item.active {
        background: #3b82f6;
        color: white;
    }

    .m-slide-menu-item.admin-only {
        display: none;
    }

    .m-slide-menu-footer {
        padding: 16px;
        border-top: 1px solid #e1e8ed;
        background: #f9fafb;
    }

    .m-slide-menu-footer button {
        width: 100%;
        padding: 12px 16px;
        background: #dc2626;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
    }

    .m-slide-menu-footer button:hover {
        background: #b91c1c;
    }

    .m-header-title {
        font-size: 16px;
        font-weight: 600;
        color: #1a202c;
    }

    .m-header-right {
        margin-left: auto;
        display: flex;
        align-items: center;
        pointer-events: auto;
        position: relative;
        z-index: 3001;
    }

    .m-user-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #3b82f6;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 600;
    }


    /* Mobile Responsive */
    @media (max-width: 768px) {
        body {
            padding-bottom: 0;
        }

        .sidebar {
            display: none !important;
        }

        .content {
            width: 100%;
            padding-top: 44px;
        }

        iframe {
            height: calc(100vh - 44px - 60px);
            padding-bottom: 60px;
            pointer-events: auto;
            position: relative;
            z-index: 1;
        }
        
        /* iframeì´ í—¤ë”ë¥¼ ë®ì§€ ì•Šë„ë¡ */
        .content {
            position: relative;
            z-index: 1;
        }

        .m-header {
            display: flex;
        }

        .m-header-back {
            display: none;
        }

        .m-hamburger {
            display: flex;
        }

        /* í•˜ë‹¨ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
        .m-bottom-nav {
            display: flex;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: white;
            border-top: 1px solid #e1e8ed;
            z-index: 3000;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            pointer-events: auto;
        }

        .m-bottom-nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 6px 4px;
            cursor: pointer;
            color: #6b7280;
            font-size: 11px;
            transition: all 0.2s;
            min-height: 44px;
            min-width: 44px;
            -webkit-tap-highlight-color: transparent;
            pointer-events: auto !important;
            touch-action: manipulation;
            position: relative;
            z-index: 3001;
        }

        .m-bottom-nav-item.active {
            color: #3b82f6;
        }

        .m-bottom-nav-icon {
            font-size: 20px;
            margin-bottom: 2px;
        }

        .m-bottom-nav-label {
            font-size: 11px;
            font-weight: 500;
        }

        .m-bottom-nav-item:active {
            opacity: 0.7;
        }
    }

    /* Desktop: í–„ë²„ê±° ë²„íŠ¼ ìˆ¨ê¸°ê¸° */
    @media (min-width: 769px) {
        .m-hamburger {
            display: none;
        }

        .m-slide-menu,
        .m-slide-menu-overlay {
            display: none !important;
        }
    }
</style>
</head>

<body>

<!-- Mobile Header -->
<div class="m-header">
    <div class="m-header-left">
        <button class="m-hamburger" onclick="toggleMobileMenu()">â˜°</button>
        <div class="m-header-title" id="mPageTitle">ì ‘ìˆ˜ í˜„í™©</div>
    </div>
    <div class="m-header-right">
        <div class="m-user-icon" id="mUserIcon">A</div>
    </div>
</div>

<!-- Mobile Slide Menu Overlay -->
<div class="m-slide-menu-overlay" id="mSlideMenuOverlay" onclick="closeMobileMenu()"></div>

<!-- Mobile Slide Menu -->
<div class="m-slide-menu" id="mSlideMenu">
    <div class="m-slide-menu-header">
        <h2>ìœ ë¦¬ êµì²´ ëŒ€ì‹œë³´ë“œ</h2>
    </div>
    <div class="m-slide-menu-content">
        <div class="m-slide-menu-item active" data-page="status" onclick="mNavigate('status')">ì ‘ìˆ˜ í˜„í™©</div>
        <div class="m-slide-menu-item" data-page="accident" onclick="mNavigate('accident')">ì‚¬ê³  ì ‘ìˆ˜ ì‹œìŠ¤í…œ</div>
        <div class="m-slide-menu-item" data-page="map" onclick="mNavigate('map')">ì‹œê³µì  ìë™ ë°°ì • ì§€ë„</div>
        <div class="m-slide-menu-item" data-page="message" onclick="mNavigate('message')">ë©”ì‹œì§€ ë³´ë‚´ê¸°</div>
        <div class="m-slide-menu-item admin-only" data-page="workshop" onclick="mNavigate('workshop')">ì‹œê³µì  ê´€ë¦¬</div>
        <div class="m-slide-menu-item admin-only" data-page="vehicle" onclick="mNavigate('vehicle')">ì°¨ëŸ‰ ê´€ë¦¬</div>
        <div class="m-slide-menu-item admin-only" data-page="settlement" onclick="mNavigate('settlement')">ì •ì‚° ê´€ë¦¬</div>
        <div class="m-slide-menu-item" data-page="stats" onclick="mNavigate('stats')">í†µê³„ / ë¦¬í¬íŠ¸</div>
        <div class="m-slide-menu-item admin-only" data-page="users" onclick="mNavigate('users')">ìœ ì € ê´€ë¦¬</div>
    </div>
    <div class="m-slide-menu-footer">
        <button id="mLogoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
</div>

<!-- Mobile Bottom Navigation -->
<div class="m-bottom-nav" id="mBottomNav">
    <div class="m-bottom-nav-item active" data-page="status" data-action="navigate" data-target="status">
        <div class="m-bottom-nav-icon">ğŸ“‹</div>
        <div class="m-bottom-nav-label">ì ‘ìˆ˜ í˜„í™©</div>
    </div>
    <div class="m-bottom-nav-item" data-page="accident" data-action="navigate" data-target="accident">
        <div class="m-bottom-nav-icon">â•</div>
        <div class="m-bottom-nav-label">ì‚¬ê³  ì ‘ìˆ˜</div>
    </div>
    <div class="m-bottom-nav-item" data-page="map" data-action="navigate" data-target="map">
        <div class="m-bottom-nav-icon">ğŸ“</div>
        <div class="m-bottom-nav-label">ì‹œê³µì  ì§€ë„</div>
    </div>
    <div class="m-bottom-nav-item" data-page="message" data-action="navigate" data-target="message">
        <div class="m-bottom-nav-icon">ğŸ’¬</div>
        <div class="m-bottom-nav-label">ë©”ì‹œì§€</div>
    </div>
    <div class="m-bottom-nav-item" data-page="more" data-action="menu">
        <div class="m-bottom-nav-icon">â‹¯</div>
        <div class="m-bottom-nav-label">ë”ë³´ê¸°</div>
    </div>
</div>

<div class="sidebar">
    <h2>ìœ ë¦¬ êµì²´ ëŒ€ì‹œë³´ë“œ</h2>

    <div class="menu-item active" onclick="loadPage('status', event)">
        ì ‘ìˆ˜ í˜„í™©
    </div>

    <div class="menu-item" onclick="loadPage('accident', event)">
        ì‚¬ê³  ì ‘ìˆ˜ ì‹œìŠ¤í…œ
    </div>

    <div class="menu-item" onclick="loadPage('map', event)">
        ì‹œê³µì  ìë™ ë°°ì • ì§€ë„
    </div>

    <div class="menu-item" onclick="loadPage('message', event)">
        ë©”ì‹œì§€ ë³´ë‚´ê¸°
    </div>

    <div class="menu-item admin-only" onclick="loadPage('workshop', event)">
        ì‹œê³µì  ê´€ë¦¬
    </div>

    <div class="menu-item admin-only" onclick="loadPage('vehicle', event)">
        ì°¨ëŸ‰ ê´€ë¦¬
    </div>

    <div class="menu-item admin-only" onclick="loadPage('settlement', event)">
        ì •ì‚° ê´€ë¦¬
    </div>

    <div class="menu-item" onclick="loadPage('stats', event)">
        í†µê³„ / ë¦¬í¬íŠ¸
    </div>

    <div class="menu-item admin-only" onclick="loadPage('users', event)">
        ìœ ì € ê´€ë¦¬
    </div>

    <button id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
</div>

<div class="content">
    <iframe id="contentFrame" src="./pages/status/index.html"></iframe>
</div>

<script defer>
async function loadPage(page, e) {
    const frame = document.getElementById("contentFrame");
    
    // ê¶Œí•œ ì²´í¬ë¥¼ ìœ„í•´ í˜„ì¬ ì‚¬ìš©ì role í™•ì¸
    const { supabase } = await import("/js/supabase.js");
    const { data: { session } } = await supabase.auth.getSession();
    const role = session?.user?.app_metadata?.role;

    // adminë§Œ ì ‘ê·¼ ê°€ëŠ¥í•œ í˜ì´ì§€
    const adminOnlyPages = ["users", "workshop", "vehicle", "settlement"];
    if (adminOnlyPages.includes(page) && role !== "admin") {
        alert("ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•œ í˜ì´ì§€ì…ë‹ˆë‹¤.");
        // ëŒ€ì‹œë³´ë“œë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (accident í˜ì´ì§€ë¡œ)
        frame.src = "./pages/accident/index.html";
        document.querySelectorAll(".menu-item").forEach(item => item.classList.remove("active"));
        const accidentMenu = Array.from(document.querySelectorAll(".menu-item")).find(item => 
            item.textContent.includes("ì‚¬ê³  ì ‘ìˆ˜")
        );
        if (accidentMenu) accidentMenu.classList.add("active");
        return;
    }

    if (page === "accident") {
        frame.src = "./pages/accident/index.html";
    } else if (page === "message") {
        frame.src = "./pages/message/index.html";
    } else if (page === "map") {
        frame.src = "./pages/installer/embed.html";
    } else if (page === "workshop") {
        frame.src = "./pages/installer/management.html";
    } else if (page === "vehicle") {
        frame.src = "./vehicle-management.html";
    } else if (page === "settlement") {
        frame.src = "./settlement-management.html";
    } else if (page === "templates") {
        frame.src = "./pages/templates/index.html";
    } else if (page === "status") {
        frame.src = "./pages/status/index.html";
    } else if (page === "stats") {
        frame.src = "./pages/stats/index.html";
    } else if (page === "users") {
        frame.src = "./users.html";
    }

    document.querySelectorAll(".menu-item").forEach(item => item.classList.remove("active"));
    if (e && e.target) {
        e.target.classList.add("active");
    }
    
    // ëª¨ë°”ì¼ ë„¤ë¹„ê²Œì´ì…˜ ì—…ë°ì´íŠ¸
    updateMobileNav(page);
    updateMobileHeader();
    updateBottomNavActive(page);
    
    // í˜ì´ì§€ ë³€ê²½ ì‹œ iframe ë¡œë“œ ì²˜ë¦¬
    frame.addEventListener('load', () => {
        // iframe ë¡œë“œ ì™„ë£Œ
        updateMobileHeader();
    }, { once: true });
}

// iframeì—ì„œ ë©”ì‹œì§€ ìˆ˜ì‹  ì²˜ë¦¬
window.addEventListener('message', function(event) {
    const frame = document.getElementById("contentFrame");
    
    if (event.data.type === 'openAccidentDetail') {
        const param = event.data.useId ? 'id' : 'edit';
        frame.src = "./pages/accident/index.html?" + param + "=" + encodeURIComponent(event.data.receiptNumber);
        // ë©”ë‰´ í™œì„±í™”
        document.querySelectorAll(".menu-item").forEach(item => item.classList.remove("active"));
        const accidentMenu = Array.from(document.querySelectorAll(".menu-item")).find(item => 
            item.textContent.includes("ì‚¬ê³  ì ‘ìˆ˜")
        );
        if (accidentMenu) accidentMenu.classList.add("active");
    } else if (event.data.type === 'openAccidentNew') {
        frame.src = "./pages/accident/index.html";
        // ë©”ë‰´ í™œì„±í™”
        document.querySelectorAll(".menu-item").forEach(item => item.classList.remove("active"));
        const accidentMenu = Array.from(document.querySelectorAll(".menu-item")).find(item => 
            item.textContent.includes("ì‚¬ê³  ì ‘ìˆ˜")
        );
        if (accidentMenu) accidentMenu.classList.add("active");
    } else if (event.data.type === 'openInstallerMap') {
        const addressParam = event.data.address ? `?address=${encodeURIComponent(event.data.address)}` : '';
        frame.src = "./pages/installer/embed.html" + addressParam;
        // ë©”ë‰´ í™œì„±í™”
        document.querySelectorAll(".menu-item").forEach(item => item.classList.remove("active"));
        const installerMenu = Array.from(document.querySelectorAll(".menu-item")).find(item => 
            item.textContent.includes("ì‹œê³µì ")
        );
        if (installerMenu) installerMenu.classList.add("active");
    } else if (event.data.type === 'openAccidentPage') {
        frame.src = "./pages/accident/index.html";
        // ë©”ë‰´ í™œì„±í™”
        document.querySelectorAll(".menu-item").forEach(item => item.classList.remove("active"));
        const accidentMenu = Array.from(document.querySelectorAll(".menu-item")).find(item => 
            item.textContent.includes("ì‚¬ê³  ì ‘ìˆ˜")
        );
        if (accidentMenu) accidentMenu.classList.add("active");
    } else if (event.data.type === 'openMessagePage') {
        const recordId = event.data.recordId;
        const caseNo = event.data.caseNo;
        const params = new URLSearchParams();
        if (recordId) params.set('accidentId', recordId);
        if (caseNo) params.set('caseNo', caseNo);
        frame.src = "./pages/message/index.html?" + params.toString();
        // ë©”ë‰´ í™œì„±í™”
        document.querySelectorAll(".menu-item").forEach(item => item.classList.remove("active"));
        const messageMenu = Array.from(document.querySelectorAll(".menu-item")).find(item => 
            item.textContent.includes("ë©”ì‹œì§€ ë³´ë‚´ê¸°")
        );
        if (messageMenu) messageMenu.classList.add("active");
    }
    
    // URL ê¸°ë°˜ ë¼ìš°íŒ… ì§€ì› (/accident-form, /workshop-map)
    if (window.location.pathname.includes('/accident-form') || window.location.pathname.endsWith('/accident/index.html')) {
        frame.src = "./pages/accident/index.html";
        document.querySelectorAll(".menu-item").forEach(item => item.classList.remove("active"));
        const accidentMenu = Array.from(document.querySelectorAll(".menu-item")).find(item => 
            item.textContent.includes("ì‚¬ê³  ì ‘ìˆ˜")
        );
        if (accidentMenu) accidentMenu.classList.add("active");
    } else if (window.location.pathname.includes('/workshop-map')) {
        const urlParams = new URLSearchParams(window.location.search);
        const address = urlParams.get('address');
        frame.src = "./pages/installer/embed.html" + (address ? "?address=" + encodeURIComponent(address) : "");
        document.querySelectorAll(".menu-item").forEach(item => item.classList.remove("active"));
        const installerMenu = Array.from(document.querySelectorAll(".menu-item")).find(item => 
            item.textContent.includes("ì‹œê³µì ")
        );
        if (installerMenu) installerMenu.classList.add("active");
    }
});
</script>

<script type="module" defer>
import { logout } from "/js/auth.js";
import { supabase } from "/js/supabase.js";

// âœ… ì „ì—­ ë³€ìˆ˜ (ì„¸ì…˜ ë° ì‚¬ìš©ì ì •ë³´)
let currentUser = null;
let currentSession = null;

async function initDashboard() {
  // ğŸ”½ ì—¬ê¸°ì„œë¶€í„° ì•ˆì „í•˜ê²Œ ë¡œì§ ì‹¤í–‰ (ì„¸ì…˜ ë³´ì¥ë¨)
  const role = currentSession?.user?.app_metadata?.role;
  console.log("USER ROLE:", role);

  if (role === "admin") {
    document
      .querySelectorAll(".admin-only")
      .forEach(el => el.style.display = "block");
  } else {
    document
      .querySelectorAll(".admin-only")
      .forEach(el => el.style.display = "none");
  }
  
  // ëª¨ë°”ì¼ ë©”ë‰´ ì´ˆê¸° í™œì„±í™” ìƒíƒœ ì„¤ì •
  updateMobileMenuActive('status');
  updateBottomNavActive('status');
}


document.addEventListener('DOMContentLoaded', async () => {
  const { data, error } = await supabase.auth.getSession();

  if (error || !data.session) {
    window.location.href = '/login.html';
    return;
  }

  currentSession = data.session;
  currentUser = data.session.user;

  // ğŸ”½ ì—¬ê¸°ì„œë¶€í„° ì•ˆì „í•˜ê²Œ ë¡œì§ ì‹¤í–‰
  initDashboard();
  
  // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
  document
    .getElementById("logoutBtn")
    ?.addEventListener("click", logout);
  
  // ëª¨ë°”ì¼ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
  document
    .getElementById("mLogoutBtn")
    ?.addEventListener("click", logout);
  
  // í–„ë²„ê±° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ê°•í™”ëœ ë²„ì „)
  const hamburgerBtn = document.querySelector('.m-hamburger');
  if (hamburgerBtn) {
    console.log('[Mobile Menu] Hamburger button found, adding event listener');
    
    // ê¸°ì¡´ onclick ì œê±°í•˜ê³  addEventListenerë¡œ í†µì¼
    hamburgerBtn.removeAttribute('onclick');
    
    // ì—¬ëŸ¬ ì´ë²¤íŠ¸ íƒ€ì…ìœ¼ë¡œ ë°”ì¸ë”© (í„°ì¹˜/í´ë¦­ ëª¨ë‘ ëŒ€ì‘)
    ['click', 'touchend'].forEach(eventType => {
      hamburgerBtn.addEventListener(eventType, (e) => {
        e.preventDefault();
        e.stopPropagation();
        console.log('[Mobile Menu] Hamburger button ' + eventType + ' event triggered');
        toggleMobileMenu();
        return false;
      }, { passive: false });
    });
    
    // í„°ì¹˜ ì‹œì‘ ì‹œ í”¼ë“œë°±
    hamburgerBtn.addEventListener('touchstart', (e) => {
      hamburgerBtn.style.opacity = '0.7';
    }, { passive: true });
    
    hamburgerBtn.addEventListener('touchend', (e) => {
      setTimeout(() => {
        hamburgerBtn.style.opacity = '1';
      }, 100);
    }, { passive: true });
  } else {
    console.error('[Mobile Menu] Hamburger button not found');
  }
  
  // ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ë©”ë‰´ ë‹«ê¸°
  const overlay = document.getElementById('mSlideMenuOverlay');
  if (overlay) {
    overlay.addEventListener('click', (e) => {
      // ì˜¤ë²„ë ˆì´ ìì²´ë¥¼ í´ë¦­í•œ ê²½ìš°ì—ë§Œ ë‹«ê¸° (ë©”ë‰´ ë‚´ë¶€ í´ë¦­ì€ ì œì™¸)
      if (e.target === overlay) {
        console.log('[Mobile Menu] Overlay clicked, closing menu');
        closeMobileMenu();
      }
    });
  }
  
  // ë©”ë‰´ í•­ëª© í´ë¦­ ì‹œ ìë™ ë‹«ê¸°
  const menuItems = document.querySelectorAll('.m-slide-menu-item');
  menuItems.forEach(item => {
    item.addEventListener('click', () => {
      console.log('[Mobile Menu] Menu item clicked, closing menu');
      closeMobileMenu();
    });
  });
  
  // í•˜ë‹¨ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
  const bottomNavItems = document.querySelectorAll('.m-bottom-nav-item');
  bottomNavItems.forEach(item => {
    ['click', 'touchend'].forEach(eventType => {
      item.addEventListener(eventType, (e) => {
        e.preventDefault();
        e.stopPropagation();
        const page = item.dataset.page;
        const action = item.dataset.action;
        
        console.log('[Mobile Nav] Bottom nav item clicked:', page, action);
        
        if (action === 'menu') {
          toggleMobileMenu();
        } else if (action === 'navigate') {
          mNavigateTab(page);
        }
        return false;
      }, { passive: false });
    });
    
    // í„°ì¹˜ í”¼ë“œë°±
    item.addEventListener('touchstart', () => {
      item.style.opacity = '0.7';
    }, { passive: true });
    
    item.addEventListener('touchend', () => {
      setTimeout(() => {
        item.style.opacity = '1';
      }, 100);
    }, { passive: true });
  });
  
  // iframe ë¡œë“œ ì™„ë£Œ ì²˜ë¦¬
  const frame = document.getElementById("contentFrame");
  frame.addEventListener('load', () => {
    // iframe ë¡œë“œ ì™„ë£Œ
    updateMobileHeader();
  });

  // ëª¨ë°”ì¼ í—¤ë” ì‚¬ìš©ì ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
  const userIcon = document.getElementById('mUserIcon');
  if (userIcon && currentUser) {
    const name = currentUser.email || currentUser.user_metadata?.name || 'U';
    userIcon.textContent = name.charAt(0).toUpperCase();
  }
  
  // DOM ìš”ì†Œ ì¡´ì¬ í™•ì¸
  console.log('[Mobile Menu] DOM check:');
  console.log('  - Hamburger button:', !!hamburgerBtn);
  console.log('  - Menu:', !!document.getElementById('mSlideMenu'));
  console.log('  - Overlay:', !!overlay);
});

// ëª¨ë°”ì¼ ë„¤ë¹„ê²Œì´ì…˜ (í–„ë²„ê±° ë©”ë‰´)
function mNavigate(page) {
  loadPage(page, null);
  updateMobileMenuActive(page);
  updateMobileHeader();
  updateBottomNavActive(page);
  closeMobileMenu();
}

// ëª¨ë°”ì¼ í•˜ë‹¨ íƒ­ ë„¤ë¹„ê²Œì´ì…˜
function mNavigateTab(page) {
  console.log('[Mobile Nav] Tab clicked:', page);
  
  if (page === 'more') {
    toggleMobileMenu();
    return;
  }
  loadPage(page, null);
  updateBottomNavActive(page);
  updateMobileHeader();
}

// ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ
window.mNavigateTab = mNavigateTab;
window.toggleMobileMenu = toggleMobileMenu;
window.closeMobileMenu = closeMobileMenu;

// í•˜ë‹¨ íƒ­ í™œì„±í™” ì—…ë°ì´íŠ¸
function updateBottomNavActive(activePage) {
  const navItems = document.querySelectorAll('.m-bottom-nav-item');
  navItems.forEach(item => {
    item.classList.remove('active');
    if (item.dataset.page === activePage) {
      item.classList.add('active');
    }
  });
}

// ëª¨ë°”ì¼ ë©”ë‰´ í™œì„±í™” ì—…ë°ì´íŠ¸
function updateMobileMenuActive(activePage) {
  const menuItems = document.querySelectorAll('.m-slide-menu-item');
  menuItems.forEach(item => {
    item.classList.remove('active');
    // data-page ì†ì„±ê³¼ ì¼ì¹˜í•˜ëŠ” í•­ëª©ë§Œ í™œì„±í™”
    if (item.dataset.page === activePage) {
      item.classList.add('active');
    }
  });
}

// ëª¨ë°”ì¼ ë©”ë‰´ í† ê¸€ (ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ)
function toggleMobileMenu() {
  console.log('[Mobile Menu] toggleMobileMenu called');
  const menu = document.getElementById('mSlideMenu');
  const overlay = document.getElementById('mSlideMenuOverlay');
  
  console.log('[Mobile Menu] menu:', menu, 'overlay:', overlay);
  
  if (menu && overlay) {
    const isActive = menu.classList.contains('active');
    console.log('[Mobile Menu] current state:', isActive ? 'open' : 'closed');
    
    if (isActive) {
      menu.classList.remove('active');
      overlay.classList.remove('active');
      console.log('[Mobile Menu] menu closed');
    } else {
      menu.classList.add('active');
      overlay.classList.add('active');
      console.log('[Mobile Menu] menu opened');
    }
  } else {
    console.error('[Mobile Menu] menu or overlay not found');
  }
}

// ëª¨ë°”ì¼ ë©”ë‰´ ë‹«ê¸° (ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ)
function closeMobileMenu() {
  console.log('[Mobile Menu] closeMobileMenu called');
  const menu = document.getElementById('mSlideMenu');
  const overlay = document.getElementById('mSlideMenuOverlay');
  
  if (menu && overlay) {
    menu.classList.remove('active');
    overlay.classList.remove('active');
    console.log('[Mobile Menu] menu closed');
  }
}

// ì „ì—­ ìŠ¤ì½”í”„ì— í•¨ìˆ˜ ë…¸ì¶œ (ëª¨ë“ˆ ìŠ¤í¬ë¦½íŠ¸ì—ì„œë„ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡)
window.toggleMobileMenu = toggleMobileMenu;
window.closeMobileMenu = closeMobileMenu;

// ëª¨ë°”ì¼ í—¤ë” ì œëª© ì—…ë°ì´íŠ¸
function updateMobileHeader() {
  const frame = document.getElementById("contentFrame");
  const titleEl = document.getElementById("mPageTitle");
  
  const pageTitles = {
    'accident': 'ì‚¬ê³  ì ‘ìˆ˜',
    'map': 'ì‹œê³µì  ì§€ë„',
    'settlement': 'ì •ì‚° ê´€ë¦¬',
    'vehicle': 'ì°¨ëŸ‰ ê´€ë¦¬',
    'status': 'ì ‘ìˆ˜ í˜„í™©',
    'stats': 'í†µê³„ / ë¦¬í¬íŠ¸',
    'workshop': 'ì‹œê³µì  ê´€ë¦¬',
    'users': 'ìœ ì € ê´€ë¦¬',
    'message': 'ë©”ì‹œì§€ ë³´ë‚´ê¸°'
  };
  
  const currentSrc = frame.src;
  for (const [page, title] of Object.entries(pageTitles)) {
    if (currentSrc.includes(page) || currentSrc.includes(page.replace('workshop', 'installer'))) {
      titleEl.textContent = title;
      break;
    }
  }
}

</script>

</body>
</html>

